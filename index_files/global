"use strict";function Reset(){this.clearCookies()}function SignalrManager(isInSteamBrowser){this.connectedCallbacks=[];this.isInSteamBrowser=isInSteamBrowser;$.connection.hub.connectionSlow(function(){})}function History(){var self,state;window.history&&typeof history.replaceState=="function"&&typeof history.pushState=="function"&&typeof history.back=="function"&&typeof window.history.forward=="function"&&(this.popStateHandlers=[],History.apiPushState=history.pushState.bind(history),History.apiReplaceState=history.replaceState.bind(history),history.pushState=History.pushState,history.replaceState=History.replaceState,self=this,window.onpopstate=function(e){if(e.state){History.enableNavigation(e.state);History.setPageUrl();for(var i=0;i<self.popStateHandlers.length;++i)self.popStateHandlers[i](e.state)}},window.addEventListener("keydown",function(e){var d=e.srcElement||e.target;e.keyCode===8&&d.tagName.toUpperCase()!=="INPUT"&&d.tagName.toUpperCase()!=="TEXTAREA"&&(e.preventDefault(),self.goBack())}),$("#go-back-history-btn").click(function(){self.goBack()}),$("#go-forward-history-btn").click(function(){window.history.forward()}),state=history.state,state&&state.historyLength||(state=state||{},state.historyLength=history.length,History.apiReplaceState(state,"history")),History.enableNavigation(state))}function Search(){function search(event){var $selectedGame,url;switch(event.keyCode){case 40:self.next();return;case 38:self.prev();self.$input.val(self.$input.val());return;case 27:self.$dropdown.hide();return;case 13:if($selectedGame=$(".dropdown-menu__item._active"),console.log($selectedGame.length),$selectedGame.length>0&&(url=$selectedGame.attr("href"),url)){window.location.href=url;return}default:self.init()}self.$input.doTimeout("text-type",500,function(){var val=self.$input.val().trim(),timestamp;if(!val||val.length<2){self.$dropdown.hide();return}timestamp=(new Date).getTime();$.ajax({url:window.urls.search,cache:!1,data:{timestamp:timestamp,query:val},success:function(data){data?(self.$dropdown.html(data),self.$dropdown.show()):self.$dropdown.hide()}})})}this.$searchWrapper=$("#header-search-wrapper");this.$form=this.$searchWrapper.find("#header-search-form");this.$input=this.$form.find("#header-search-input");this.$dropdown=this.$searchWrapper.find("#header-search-dropdown");var self=this;self.$input.on("keyup",function(event){search(event);event.stopPropagation()});self.$input.on("focus",function(event){self.$input.addClass("focus");search(event)});self.$input.on("focusout",function(){self.$input.removeClass("focus")});self.$input.each(function(){var $searchIcon=self.$searchWrapper.find(".search__icon");$(this).focus(function(){$searchIcon.addClass("_focus")}).blur(function(){$searchIcon.removeClass("_focus")})});$("html").click(function(){self.$dropdown.hide();self.init()});self.$searchWrapper.click(function(event){event.stopPropagation()});self.init()}function CarouselHelper(){}function versionCompare(v1,v2,options){function isValidPart(x){return(lexicographical?/^\d+[A-Za-z]*$/:/^\d+$/).test(x)}var lexicographical=options&&options.lexicographical,zeroExtend=options&&options.zeroExtend,v1Parts=v1.split("."),v2Parts=v2.split("."),i;if(!v1Parts.every(isValidPart)||!v2Parts.every(isValidPart))return NaN;if(zeroExtend){while(v1Parts.length<v2Parts.length)v1Parts.push("0");while(v2Parts.length<v1Parts.length)v2Parts.push("0")}for(lexicographical||(v1Parts=v1Parts.map(Number),v2Parts=v2Parts.map(Number)),i=0;i<v1Parts.length;++i){if(v2Parts.length===i)return 1;if(v1Parts[i]===v2Parts[i])continue;else return v1Parts[i]>v2Parts[i]?1:-1}return v1Parts.length!==v2Parts.length?-1:0}function getCookieValue(cookieName,fieldName){var cookieValueRe=new RegExp("(?:^|; )"+cookieName+"=([^;]+)"),cookieValueMatches=document.cookie.match(cookieValueRe),cookieValue,fieldValueRe,fieldValueMatches;return cookieValueMatches?(cookieValue=cookieValueMatches[1],!fieldName)?cookieValue:(fieldValueRe=new RegExp("(?:^|&)"+fieldName+"=([^&]+)"),fieldValueMatches=cookieValue.match(fieldValueRe),fieldValueMatches?fieldValueMatches[1]:undefined):undefined}function getParameterByName(name,url){url||(url=window.location.href);name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null}function selectText(selector){var target=document.getElementById(selector),rng,sel;target&&(document.createRange?(rng=document.createRange(),rng.selectNode(target),sel=window.getSelection(),sel.removeAllRanges(),sel.addRange(rng)):(rng=document.body.createTextRange(),rng.moveToElementText(target),rng.select()))}function domainsEquals(url1,url2){var hostname1=$("<a>").prop("href",url1).prop("hostname"),hostname2=$("<a>").prop("href",url2).prop("hostname");return hostname1===hostname2}function getValueByKey(key,data){for(var len=data.length,i=0;i<len;i++)if(data[i]&&data[i].key===key)return data[i].value;return-1}function NewsletterSubscription($input,$button){const self=this;self.$input=$input;$input&&$input.keyup(function(ev){ev.which===13&&self.subscribe()});$button&&$button.click(function(){self.subscribe()})}function Notifications(ga){if(typeof window.global.currentUserId=="number"&&!(window.global.currentUserId<=0)){this.ga=ga;window.global.signalrManager.extendQueryString({userId:window.global.currentUserId});this.roomNotificationTypes=["PlayerJoinedSeat","PlayerLeftSeat","PlayerWasKicked","RoomClosed","GameStarted","RoomChatMessageAdded","PlayerInvitedToRoom","RoomReadyCheckStarted","RoomReadyCheckCancelled"];this.newNotificationSound=new Howl({urls:["/DefaultResources/Notifications/new_notification.mp3","/DefaultResources/Notifications/new_notification.ogg","/DefaultResources/Notifications/new_notification.wav"]});this.initHubMethods($.connection.nh);this.initNotificationsDialog();$("body").on("click",".messager-user-settings",function(){window.location.href="/playground/players/"+window.global.userShortUrl+"/edit#settings"})}}function SubscriptionsManager(unity,ga){this.unity=unity;this.ga=ga;const self=this;window.global.currentUserId!==0&&(typeof this.unity!="undefined"&&typeof this.unity.subscribe=="function"?(window.FinalizeSteamInAppOrderOsx=function(data){var json=JSON.parse(data);self.finalizeSteamInAppOrder(json.Authorized,json.AppID,json.OrderID)},window.FinalizeSteamInAppOrder=function(command,data){if(console.log("FinalizeSteamInAppOrder: command - '"+command+"', date - "+new Date),console.log("FinalizeSteamInAppOrder: data - '"+JSON.stringify(data)+"'"),typeof data=="object"&&typeof data.value!="undefined"){var json=JSON.parse(data.value);self.finalizeSteamInAppOrder(json.Authorized,json.AppID,json.OrderID)}},window.FinalizeSteamDlcOrderOsx=function(data){var json=JSON.parse(data);self.finalizeSteamDlcOrder(json.SteamAppId)},window.FinalizeSteamDlcOrder=function(command,data){if(typeof data=="object"&&typeof data.value!="undefined"){var json=JSON.parse(data.value);self.finalizeSteamDlcOrder(json.SteamAppId)}}):window.global.currentUserHasAnySubscriptions===0&&self.show({skipIntroDlg:!0}))}function App(unity,ga,gaFunc){var self=this;self.unity=unity;self.settings={};self.initUserData(function(){self.initTtCookie(gaFunc);self.reloginSteamUser();self.initTooltip();self.carousel($(".carousel:not(._modal)"));self.modalCarousel($(".carousel._modal"));self.modal();self.initWindowControlBtns();self.initPageUrl();self.initGames($(".game-short-item"));self.fixPasteToTextInputs();self.initGetPremium();self.initNotificationForDemoUser();self.initRating(unity,ga);self.welcomeManager=new WelcomeManager(ga,unity);self.initPlayingNowRoomsCount();self.initPlayingNowRooms();self.initInsertTextToActiveInput();self.initReposrtIssue();self.initSteamDlc()})}function ActiveRooms(){this.rooms=[];this.roomsCountChangedCallbacks=[]}function FavoriteGames(){this.init($(".favorite-game-js"))}function UsersManager(){this.userJoinedPageCallbacks=[];this.userLeftPageCallbacks=[];this.readyCheckOpenGameCallbacks=[];this.initHubMethods()}function WelcomeManager(ga,unity){this.ga=ga;this.unity=unity;this.$dlg=$("#welcome-dlg");this.init($(".welcome-slider-items",this.$dlg))}function RatingManager(ga,unity){this._isRateAvailable()&&(this.ga=ga,this.unity=unity,this.$dlg=$("#rate-dlg"),this.$rating=$("#rating-stars",this.$dlg),this._init())}var servicestack,Tabletopia;window.Log=function(message){typeof message=="string"&&message.length!==0&&$.ajax({url:location.protocol+"//"+location.host+"/api/client/log",type:"POST",global:!1,cache:!1,data:{message:message}})};Reset.prototype.clearCookies=function(){var date=new Date,dateStr;date.setTime(date.getTime()+-864e5);dateStr=date.toGMTString();document.cookie="tt-redirect=; expires="+dateStr+"; path=/; secure; SameSite=Lax";document.cookie="tt-ca=; expires="+dateStr+"; path=/; secure; SameSite=None";document.cookie="tt-dz=; expires="+dateStr+"; path=/; secure; SameSite=Lax";document.cookie="tt-user-invite=; expires="+dateStr+"; path=/; secure; SameSite=Lax"};SignalrManager.prototype.extendQueryString=function(queryString){if(typeof queryString=="object"&&!$.isEmptyObject(queryString)){var hubConnection=$.connection.hub;hubConnection.qs=hubConnection.qs||{};$.extend(hubConnection.qs,queryString)}};SignalrManager.prototype.registerConnectedCallback=function(connectedCallback){typeof connectedCallback=="function"&&this.connectedCallbacks.push(connectedCallback)};SignalrManager.prototype.connect=function(){var connectOptions={},hubConnection;connectOptions.waitForPageLoad=!1;this.isInSteamBrowser===1&&(connectOptions.transport="longPolling");hubConnection=$.connection.hub;hubConnection.start(connectOptions).done(function(){console.log("SignalR connected. ConnectionId: "+hubConnection.id)},this.connectedCallbacks).fail(function(){console.log("SignalR failed to connect")})};servicestack=function(){var JSC=function(baseUri){this.baseSyncReplyUri=path.combine(baseUri,"Json/SyncReply");this.baseAsyncOneWayUri=path.combine(baseUri,"Json/AsyncOneWay")},P=JSC.prototype,is,S,A,O,path,urn,dto;P.send=function(request,onSuccess,onError,ajaxOptions){var data,webMethod,k,ajax;if(ajaxOptions=ajaxOptions||{},data={},webMethod=typeof request=="string"?request:null,webMethod===null)for(webMethod in request){data=request[webMethod]||{};typeof data!="object"&&(data={Id:data});ajaxOptions.contentType===jsonContentType&&(data=JSON.stringify(data));break}var startCallTime=new Date,requestUrl=path.combine(this.baseSyncReplyUri,webMethod),id=JSC.id++,options={type:"GET",url:requestUrl,data:data,dataType:"json",success:function(response){var endCallTime=new Date,callDuration=endCallTime.getTime()-startCallTime.getTime(),status;if(!response){onSuccess&&onSuccess(null);return}if(status=JSC.parseResponseStatus(response.ResponseStatus),status.isSuccess){onSuccess&&onSuccess(response);JSC.onSuccess({id:id,webMethod:webMethod,request:data,response:response,durationMs:callDuration})}else{onError&&onError(status);JSC.onError({id:id,webMethod:webMethod,request:data,error:status,durationMs:callDuration})}},error:function(xhr){var endCallTime=new Date,callDuration=endCallTime.getTime()-startCallTime.getTime(),response;try{response=xhr.responseText;try{response=JSON.parse(response)}catch(e){}onError&&onError(response)}catch(e){}JSC.onError({id:id,webMethod:webMethod,request:data,error:xhr.responseText,durationMs:callDuration})}};for(k in ajaxOptions)options[k]=ajaxOptions[k];ajax=JSC.ajax(options)};P.getFromService=function(request,onSuccess,onError){var options=document.all?{cache:!1}:null;this.send(request,onSuccess,onError,options)};P.postFormDataToService=function(request,onSuccess,onError){this.send(request,onSuccess,onError,{type:"POST"})};P.postToService=function(request,onSuccess,onError){this.send(request,onSuccess,onError,{type:"POST",processData:!1,contentType:jsonContentType})};P.putToService=function(request,onSuccess,onError){this.send(request,onSuccess,onError,{type:"PUT",processData:!1,contentType:jsonContentType})};P.deleteFromService=function(request,onSuccess,onError){this.send(request,onSuccess,onError,{type:"DELETE",processData:!1,contentType:jsonContentType})};JSC.parseResponseStatus=function(status){var result,i,len,err,error;if(!status)return{isSuccess:!0};if(result={isSuccess:status.ErrorCode===undefined||status.ErrorCode===null,errorCode:status.ErrorCode,message:status.Message,errorMessage:status.ErrorMessage,stackTrace:status.StackTrace,fieldErrors:[],fieldErrorMap:{}},status.FieldErrors)for(i=0,len=status.FieldErrors.length;i<len;i++)err=status.FieldErrors[i],error={errorCode:err.ErrorCode,fieldName:err.FieldName,errorMessage:err.ErrorMessage||""},result.fieldErrors.push(error),error.fieldName&&(result.fieldErrorMap[error.fieldName]=error);return result};JSC.id=0;JSC.onError=function(){};JSC.onSuccess=function(){};JSC.toJsonDate=function(date){var jsDate=is.Date(date)?date:new Date(date)};var jsonContentType="application/json; charset=utf-8",rquery=/\?/,rts=/(\?|&)_=.*?(&|$)/,ajaxSettings={type:"GET",contentType:"application/x-www-form-urlencoded",dataType:"json",accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};return JSC.ajax=function(s){var k,xhr,ts,ret,headers,data,strData;if(typeof $!==undefined)return $.ajax(s);for(k in ajaxSettings)s[k]||(s[k]=ajaxSettings[k]);xhr=new goog.net.XhrIo;goog.events.listen(xhr,"complete",function(){if(xhr.isSuccess()){if(!s.success)return;s.dataType=="json"?s.success(xhr.getResponseJson()):s.dataType=="xml"?s.success(xhr.getResponseXml()):s.success(xhr.getResponseText())}else{if(!s.error)return;s.error(xhr,xhr.getLastErrorCode(),xhr.getLastError())}});s.cache===!1&&type==="GET"&&(ts=(new Date).getTime(),ret=s.url.replace(rts,"$1_="+ts+"$2"),s.url=ret+(ret===s.url?(rquery.test(s.url)?"&":"?")+"_="+ts:""));headers={"Content-Type":s.contentType};data=goog.Uri.QueryData.createFromMap(new goog.structs.Map(s.data));s.type=="GET"?(s.url+=(rquery.test(s.url)?"&":"?")+data.toString(),xhr.send(s.url,"GET",null,headers)):(strData=s.contentType==jsonContentType?s.data:data.toString(),xhr.send(s.url,s.type,strData,headers))},is={Null:function(a){return a===null},Undefined:function(a){return a===undefined},Empty:function(a){return a===null||a===undefined||a===""},Function:function(a){return typeof a=="function"?a.constructor.toString().match(/Function/)!==null:!1},String:function(a){return a===null||a===undefined||a.type?!1:typeof a=="string"?!0:typeof a=="object"?a.constructor.toString().match(/string/i)!==null:!1},Array:function(a){return is.Empty(a)||a.type?!1:typeof a=="object"?a.constructor.toString().match(/array/i)!==null||a.length!==undefined:!1},Boolean:function(a){return is.Empty(a)||a.type?!1:typeof a=="boolean"?!0:typeof a=="object"?a.constructor.toString().match(/boolean/i)!==null:!1},Date:function(a){return is.Empty(a)||a.type?!1:typeof a=="date"?!0:typeof a=="object"?a.constructor.toString().match(/date/i)!==null:!1},Number:function(a){return is.Empty(a)||a.type?!1:typeof a=="number"?!0:typeof a=="object"?a.constructor.toString().match(/Number/)!==null:!1},ValueType:function(a){return is.Empty(a)||a.type?!1:is.String(a)||is.Date(a)||is.Number(a)||is.Boolean(a)}},S={},S.rtrim=function(str,chars){return chars=chars||"\\s",str.replace(new RegExp("["+chars+"]+$","g"),"")},S.toString=function(){var s,i,arg,o,name;if(arguments.length==0||!arguments[0])return null;for(s="",i=0;i<arguments.length;i++)if(arg=arguments[i],s&&(s+="/"),is.String(arg))s+=arg;else if(is.ValueType(arg))s+=arg.toString();else if(is.Array(arg))s+="["+A.join(arg,",")+"]";else{o="";for(name in arg)o&&(o+=","),o+=name+":"+S.safeString(arg[name]);s+="{"+o+"}"}return s},S.safeString=function(str){return str?S.containsAny(str,["[","]","{","}",","])?'"'+str+'"':str:str},S.containsAny=function(str,tests){if(is.String(str)){for(var i=0,len=tests.length;i<len;i++)if(str.indexOf(tests[i])!=-1)return!0;return!1}},S.startsWith=function(text,startsWith){return!text||!startsWith?!1:text.lastIndexOf(startsWith,0)==0},S.pad=function(text,padLen,padChar,rpad){var padChar=padChar||(rpad?" ":"0");for(text=text.toString();text.length<padLen;)text=rpad?text+padChar:padChar+text;return text},S.padLeft=function(text,padLen,padChar){return S.pad(text,padLen,padChar,!1)},S.padRight=function(text,padLen,padChar){return S.pad(text,padLen,padChar,!0)},S.lpad=S.padLeft,S.rpad=S.padRight,A={},A.each=function(array,fn){if(array)for(var i=0,len=array.length;i<len;i++)fn(array[i])},A.convertAll=function(array,convertFn){for(var to=[],i=0,len=array.length;i<len;i++)to[i]=convertFn(array[i]);return to},A.join=function(array,on){var s="",i,len;for(on=on||",",i=0,len=array.length;i<len;i++)s&&(s+=on),s+=array[i];return s},A.toTable=function(array,tableFormatFns){var cols,sb,i,len,obj,j,colsLen,k,data;for(tableFormatFns=tableFormatFns||{},cols=[],sb=[],i=0,len=array.length;i<len;i++)if(obj=array[i],obj){if(i==0){sb.push("<table><thead><tr>");for(k in obj)cols.push(k),sb.push("<th>"+k+"<\/th>");sb.push("<\/tr><\/thead><tbody>")}for(sb.push("<tr>"),j=0,colsLen=cols.length;j<colsLen;j++)k=cols[j],data=tableFormatFns[k]?tableFormatFns[k](obj[k]):dto.formatValue(obj[k]),sb.push("<td>"+data+"<\/td>");sb.push("<\/tr>")}return sb.push("<\/tbody><\/table>"),sb.join("")},O={},O.keys=function(obj){var keys=[];for(var key in obj)keys.push(key);return keys},path={},path.combine=function(){for(var paths="",i=0,len=arguments.length;i<len;i++)paths.length>0&&(paths+="/"),paths+=S.rtrim(arguments[i],"/");return paths},path.getFirstArg=function(path){return path?path.split("/")[0]:null},path.getFirstValue=function(path){return!path||path.indexOf("/")==-1?null:path.substr(path.indexOf("/")+1)},path.getArgs=function(path){return path?path.split("/"):null},urn={},urn.toId=function(urn){return urn.replace(/:/g,"_")},urn.getIdValue=function(urn){return urn.split(":")[2]},urn.fromId=function(urn){return urn.replace(/_/g,":")},dto={},dto.toArray=function(array){return is.Array(array)?S.toString(array):"["+S.toString(array)+"]"},dto.toUtcDate=function(date){return date.getUTCFullYear()+"-"+S.lpad(date.getUTCMonth()+1,2)+"-"+S.lpad(date.getUTCDate(),2)+"T"+S.lpad(date.getUTCHours(),2)+":"+S.lpad(date.getUTCMinutes(),2)+":"+S.lpad(date.getUTCSeconds(),2)+"Z"},dto.isJsonDate=function(str){return is.String(str)?S.startsWith(str,dto.WcfDatePrefix):!1},dto.WcfDatePrefix="/Date(",dto.toJsonDate=function(date){return date=dto.parseJsonDate(date),dto.WcfDatePrefix+date.getTime()+"+0000)/"},dto.parseJsonDate=function(date){return is.Date(date)?date:S.startsWith(date,dto.WcfDatePrefix)?new Date(parseInt(date.substring(dto.WcfDatePrefix.length,date.length-2))):new Date(date)},dto.formatDate=function(date){return date=dto.parseJsonDate(date),date.getUTCFullYear()+"/"+S.lpad(date.getUTCMonth()+1,2)+"/"+S.lpad(date.getUTCDate(),2)},dto.formatValue=function(value){return dto.isJsonDate(value)?dto.formatDate(value):is.Empty(value)?"":value},{ClientGateway:JSC,dto:dto,string:S,array:A,object:O,path:path,urn:urn}}();this.JSON||(JSON=function(){function f(n){return n<10?"0"+n:n}function stringify(value,whitelist){var a,i,k,l,r=/["\\\x00-\x1f\x7f-\x9f]/g,v;switch(typeof value){case"string":return r.test(value)?'"'+value.replace(r,function(a){var c=m[a];return c?c:(c=a.charCodeAt(),"\\u00"+Math.floor(c/16).toString(16)+(c%16).toString(16))})+'"':'"'+value+'"';case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value)return"null";if(typeof value.toJSON=="function")return stringify(value.toJSON());if(a=[],typeof value.length=="number"&&!value.propertyIsEnumerable("length")){for(l=value.length,i=0;i<l;i+=1)a.push(stringify(value[i],whitelist)||"null");return"["+a.join(",")+"]"}if(whitelist)for(l=whitelist.length,i=0;i<l;i+=1)k=whitelist[i],typeof k=="string"&&(v=stringify(value[k],whitelist),v&&a.push(stringify(k)+":"+v));else for(k in value)typeof k=="string"&&(v=stringify(value[k],whitelist),v&&a.push(stringify(k)+":"+v));return"{"+a.join(",")+"}"}}Date.prototype.toJSON=function(){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};var m={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:stringify,parse:function(text,filter){function walk(k,v){var i,n;if(v&&typeof v=="object")for(i in v)Object.prototype.hasOwnProperty.apply(v,[i])&&(n=walk(i,v[i]),n!==undefined&&(v[i]=n));return filter(k,v)}var j;if(/^[\],:{}\s]*$/.test(text.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof filter=="function"?walk("",j):j;throw new SyntaxError("parseJSON");}}}());History.prototype.goBack=function(){var regex=new RegExp("/playground/players/[^/]+/[a-zA-Z0-9]{6}");if(regex.test(document.location.href.toLowerCase())){document.location.href="/";return}window.history.back()};History.prototype.registerPopStateHandler=function(callback){typeof callback=="function"&&this.popStateHandlers.push(callback)};History.pushState=function(state,title,url){var curState=history.state;state&&curState&&curState.historyLength&&(state.historyLength=curState.historyLength+1);History.apiPushState(state,title,url);History.setPageUrl()};History.replaceState=function(state,title,url){var curState=history.state;state&&curState&&curState.historyLength&&(state.historyLength=curState.historyLength);History.apiReplaceState(state,title,url);History.setPageUrl()};History.enableNavigation=function(state){var $backBtn,$forwardBtn;window.history.length!==1&&state&&state.historyLength&&(state.historyLength>1&&($backBtn=$("#go-back-history-btn"),$backBtn.addClass("_active")),state.historyLength<window.history.length&&($forwardBtn=$("#go-forward-history-btn"),$forwardBtn.addClass("_active")))};History.setPageUrl=function(){$("#page-url-input").val(window.location.href)};Search.prototype.init=function(){this.currentItemIndex=-1;this.$currentItem=undefined;this.$dropdown.find("[data-dropdown-search-item]").removeClass("_active")};Search.prototype.next=function(){var $items=this.$dropdown.find("[data-dropdown-search-item]");$items.removeClass("_active");this.currentItemIndex<$items.length-1&&(this.currentItemIndex+=1);this.makeItemActive($items)};Search.prototype.prev=function(){var $items=this.$dropdown.find("[data-dropdown-search-item]");$items.removeClass("_active");this.currentItemIndex>0&&(this.currentItemIndex-=1);this.makeItemActive($items)};Search.prototype.makeItemActive=function($items){this.currentItemIndex>=0&&(this.$currentItem=$items.eq(this.currentItemIndex),this.$currentItem.addClass("_active"))};CarouselHelper.prototype.initModalCarousel=function($carousels,carouselSettings){function initCarusel(self){var $parentModal=$(self).parents(".modal-dialog"),slidesLength;$parentModal.removeClass(function(index,css){return(css.match(/(^|\s)_slides_\S+/g)||[]).join(" ")});slidesLength=$(self).find(".carousel__item").length;slidesLength>0&&(slidesLength>4?(window.innerWidth>=window.global.breakpointXLg&&$parentModal.addClass("_slides_more"),slidesLength>5||window.innerWidth<=window.global.breakpointXLg&&slidesLength>4?$(".slick-slider",$parentModal).addClass("_more"):$(".slick-slider",$parentModal).removeClass("_more")):slidesLength===1?$parentModal.addClass("_slides_2"):$parentModal.addClass("_slides_"+slidesLength))}$carousels.on("init reInit",function(){initCarusel(this)});$carousels.slick(carouselSettings);var $window=$(window);$window.resize(function(){$carousels.each(function(idx,el){initCarusel(el)})})};Tabletopia=Tabletopia||{};Tabletopia.Common=Tabletopia.Common||{};Tabletopia.Common.createHiddenInput=function(name,value){return $("<input name='"+name+"' type='hidden' value='"+value+"'>")};Tabletopia.Common.createArrayHiddenInput=function(name,value,type){var allInputsCount=$("input[name*="+name+"]").length,count=allInputsCount>0?allInputsCount/3:allInputsCount,inputArray;return count===0?(inputArray=[],inputArray.push($("<input type='hidden' name='"+name+"["+count+"].Type' value='"+type+"'>")),inputArray.push($("<input type='hidden' name='"+name+"["+count+"].Id' value='"+value+"'>")),inputArray.push($("<input type='hidden' name='"+name+"["+count+"].LanguageIdentity' value>")),inputArray):null};Tabletopia.Common.objectEquals=function(obj1,obj2){var i,j;for(i in obj1)if(obj1.hasOwnProperty(i)&&(!obj2.hasOwnProperty(i)||obj1[i]!==obj2[i]))return!1;for(j in obj2)if(obj2.hasOwnProperty(j)&&(!obj1.hasOwnProperty(j)||obj1[j]!==obj2[j]))return!1;return!0};NewsletterSubscription.prototype.subscribe=function(){const email=this.$input.val();if(email.length!==0){const gateway=new servicestack.ClientGateway(location.protocol+"//"+location.host+"/api/");gateway.postToService({SubscribeEmail:{email:email}});Messenger().post({extraClasses:"messenger-fixed messenger-on-bottom messenger-on-right",message:"Thank you! You successfully subscribed to the Tabletopia newsletter.",showCloseButton:!0,hideAfter:6});this.$input.val("")}};Notifications.prototype.initHubMethods=function(proxy){var self=this;proxy.client.addNotification=function(notification){typeof notification!="undefined"&&self.addNotification(notification)};proxy.client.removeNotifications=function(notificationId){typeof notificationId!="undefined"&&self.removeNotification(notificationId)}};Notifications.prototype.addNotification=function(notification){typeof notification!="undefined"&&(this.roomNotificationTypes.indexOf(notification.TypeStr)!==-1&&notification.TypeStr!=="PlayerWasKicked"&&notification.TypeStr!=="RoomReadyCheckCancelled"&&this.isInRoom(notification.Content.UserShortUrl,notification.Content.RoomShortUrl)||(notification.Id>0&&this.addDialogNotification(notification),this.showMessenger(notification)))};Notifications.prototype.isInRoom=function(userShortUrl,roomShortUrl){return typeof room!="undefined"&&window.room.creatorShortUrl===userShortUrl&&window.room.shortUrl.toLowerCase()===roomShortUrl.toLowerCase()};Notifications.prototype.showMessenger=function(notification){var options=this.getMessengerOptions(notification);Messenger({extraClasses:"messenger-fixed messenger-on-bottom messenger-on-right"}).post(options);this.newNotificationSound.stop().play()};Notifications.prototype.getMessengerOptions=function(notification){var options={type:"info",hideAfter:10,showCloseButton:!0};return this.roomNotificationTypes.indexOf(notification.TypeStr)!==-1?this.fillMessagerOptionsForRoom(notification,options):notification.TypeStr==="GameSuggested"&&this.fillMessagerOptionsForGameSuggested(notification,options),options.message=this.createMessagerMessage(notification),options};Notifications.prototype.fillMessagerOptionsForRoom=function(notification,options){var self=this;options.onClickClose=function(){};notification.Content.HasNoActions!==!0&&(options.actions=notification.TypeStr==="PlayerInvitedToRoom"?{playAction:{label:window.SR.Join,action:function(){var n=this;self.acceptInvitation(notification.Id,notification.Content.InvitationId,function(jqXHR){n.hide();window.location.href=jqXHR.result||jqXHR.reason!=="PremiumSetupNotAvailable"?window.urls.roomTemplate.replace("user-short-url",notification.Content.UserShortUrl).replace("room-short-url",notification.Content.RoomShortUrl):window.urls.zoneBuySubscription.replace("user-short-url",notification.Content.UserShortUrl).replace("room-short-url",notification.Content.RoomShortUrl)},function(jqXHR){jqXHR.status===403&&(n.hide(),window.location.href=window.urls.sessionManager.replace("user-short-url",notification.Content.UserShortUrl).replace("room-short-url",notification.Content.RoomShortUrl))})}},cancelAction:{label:window.SR.Reject,action:function(){this.hide();self.declineInvitation(notification.Id,notification.Content.InvitationId)}}}:notification.TypeStr==="RoomReadyCheckStarted"?{playAction:{label:window.SR.Ready,action:function(){var n=this;self.readyCheckSetReady(notification.Id,notification.Content.RoomShortUrl,function(res){n.hide();typeof res!="undefined"&&res.gameIsOpening&&self.isInRoom(notification.Content.UserShortUrl,notification.Content.RoomShortUrl)||(window.location.href=window.urls.roomTemplate.replace("user-short-url",notification.Content.UserShortUrl).replace("room-short-url",notification.Content.RoomShortUrl))})}},cancelAction:{label:window.SR.LeaveRoom,action:function(){this.hide();self.readyCheckLeaveGame(notification.Id,notification.Content.RoomShortUrl)}}}:{playAction:{label:notification.TypeStr==="GameStarted"?window.SR.Play:window.SR.GoToRoom,action:function(){this.hide();self.markAsRead(notification.Id,function(){var templateUrl;templateUrl=notification.TypeStr==="GameStarted"?window.urls.roomPlayTemplate:window.urls.roomTemplate;window.location.href=templateUrl.replace("user-short-url",notification.Content.UserShortUrl).replace("room-short-url",notification.Content.RoomShortUrl)})}}});(notification.TypeStr==="PlayerJoinedSeat"||notification.TypeStr==="PlayerLeftSeat")&&notification.Content.MinPlayersNeeded===0?(options.id=notification.TypeStr+notification.Content.UserShortUrl+notification.Content.RoomShortUrl+notification.Content.MinPlayersNeeded,options.hideAfter=3600):notification.TypeStr==="PlayerInvitedToRoom"?options.hideAfter=3600:(notification.TypeStr==="RoomReadyCheckStarted"||notification.TypeStr==="RoomReadyCheckCancelled")&&(options.id="RoomReadyCheckStartedOrCancelled"+notification.Content.UserShortUrl+notification.Content.RoomShortUrl,notification.TypeStr==="RoomReadyCheckStarted"&&(options.hideAfter=typeof window.global.readyCheckTimeoutSeconds!="undefined"?window.global.readyCheckTimeoutSeconds:300))};Notifications.prototype.fillMessagerOptionsForGameSuggested=function(notification,options){var self=this;options.actions={playAction:{label:window.SR.Yes,action:function(){var n=this;self.acceptGameSuggestion(notification.Id,notification.Content.GamePublicId,notification.Content.GameName,function(resp){n.hide();resp.reachedSessionsLimit?self.showReachedSessionsLimitMessage():self.showGameSuggestionAcceptedMessage()})}},laterAction:{label:window.SR.NotNow,action:function(){this.hide();self.rejectGameSuggestion(notification.Id,notification.Content.GamePublicId,notification.Content.GameName)}}};options.hideAfter=3600};Notifications.prototype.showGameSuggestionAcceptedMessage=function(){Messenger({extraClasses:"messenger-fixed messenger-on-bottom messenger-on-right"}).post({type:"success",hideAfter:30,showCloseButton:!0,message:window.SR.GameWillStartWhenEnoughUsersAccept})};Notifications.prototype.showReachedSessionsLimitMessage=function(){Messenger({extraClasses:"messenger-fixed messenger-on-bottom messenger-on-right"}).post({type:"warning",hideAfter:60,showCloseButton:!0,message:window.SR.CloseSessionsToPlayGame})};Notifications.prototype.createMessagerMessage=function(notification){var $message=$("#messager-message-template").clone().removeClass("hidden"),$img;return $message.find("table").attr("data-id",notification.Id),typeof notification.Content!="undefined"&&($img=$message.find(".messager-image-cell img"),typeof notification.Content.ImageUrl!="undefined"&&notification.Content.ImageUrl.length>0&&$img.attr("src",notification.Content.ImageUrl+$img.attr("data-img-query")).css("opacity",1),typeof notification.Content.Title!="undefined"&&notification.Content.Title.length>0&&($message.find(".messager-title-cell").append("<strong>"+notification.Content.Title+"<\/strong>"),$img.attr("alt",notification.Content.Title)),typeof notification.Content.Message!="undefined"&&notification.Content.Message.length>0&&$message.find(".messager-text-cell").append(notification.Content.Message)),$message.html()};Notifications.prototype.initNotificationsDialog=function(){var self=this,$dlg=$("#notifications-dialog"),$indicator=$("#page-notifications-indicator");$dlg.find(".overall-notify__clear").click(function(){self.markAsReadAll()});$indicator.click(function(e){(e.preventDefault(),$indicator.hasClass("disabled"))||$dlg.toggleClass("hidden")});$(document).click(function(e){var $target=$(e.target);$target.is($indicator)||$target.closest($indicator).length!==0||$target.hasClass("notify-item__closer")||$target.hasClass("notify-item__button")||$target.is($dlg)||$target.closest($dlg).length!==0||$dlg.hasClass("hidden")||$dlg.addClass("hidden")});this.loadDialogNotifications()};Notifications.prototype.loadDialogNotifications=function(){var self=this;$.ajax({url:window.urls.notificationGet,cache:!1,global:!1,dataType:"html",success:function(html){typeof html!="undefined"&&html!==""&&self.processDialogNotifications($(html))}})};Notifications.prototype.processDialogNotifications=function($notifications){this.processRoomInvitationNotifications($notifications.filter("[data-type=PlayerInvitedToRoom]"));this.processReadyCheckNotifications($notifications.filter("[data-type=RoomReadyCheckStarted]"));this.processGameSuggestedNotifications($notifications.filter("[data-type=GameSuggested]"));var $standardNotifications=$notifications.filter(function(){var type=$(this).attr("data-type");return type!=="PlayerInvitedToRoom"&&type!=="RoomReadyCheckStarted"&&type!=="GameSuggested"});this.processStandardNotifications($standardNotifications);$("#notifications-dialog").find(".overall-notify__list").prepend($notifications);this.updateDialogNotificationsCount()};Notifications.prototype.processRoomInvitationNotifications=function($roomInvitations){var self=this;$roomInvitations.find(".notify-item__closer").click(function(){var $notification=$(this).parents(".notify-item"),invData=$notification.find("input[name=invitation-data]");self.declineInvitation($notification.attr("data-id"),invData.attr("data-inv-id"))});$roomInvitations.find(".notify-item__buttons .notify-item__button").click(function(e){e.preventDefault();var $this=$(this),$notification=$this.parents(".notify-item"),invData=$notification.find("input[name=invitation-data]");$this.hasClass("_play")?self.acceptInvitation($notification.attr("data-id"),invData.attr("data-inv-id"),function(jqXHR){window.location.href=jqXHR.result||jqXHR.reason!=="PremiumSetupNotAvailable"?window.urls.roomTemplate.replace("user-short-url",invData.attr("data-user-url")).replace("room-short-url",invData.attr("data-room-url")):window.urls.zoneBuySubscription.replace("user-short-url",invData.attr("data-user-url")).replace("room-short-url",invData.attr("data-room-url"))},function(jqXHR){jqXHR.status===403&&(window.location.href=window.urls.sessionManager.replace("user-short-url",invData.attr("data-user-url")).replace("room-short-url",invData.attr("data-room-url")))}):$this.hasClass("js-cancel")&&self.declineInvitation($notification.attr("data-id"),invData.attr("data-inv-id"))})};Notifications.prototype.processReadyCheckNotifications=function($readyChecks){var self=this;$readyChecks.find(".notify-item__closer").click(function(){var $notification=$(this).parents(".notify-item");self.markAsRead($notification.attr("data-id"))});$readyChecks.find(".notify-item__buttons .notify-item__button").click(function(e){var $this=$(this),$notification=$this.parents(".notify-item"),readyCheckData=$notification.find("input[name=ready-check-data]");$this.hasClass("_play")?(e.preventDefault(),self.readyCheckSetReady($notification.attr("data-id"),readyCheckData.attr("data-room-url"),function(){window.location.href=window.urls.roomTemplate.replace("user-short-url",readyCheckData.attr("data-user-url")).replace("room-short-url",readyCheckData.attr("data-room-url"))})):$this.hasClass("js-cancel")&&(e.preventDefault(),self.readyCheckLeaveGame($notification.attr("data-id"),readyCheckData.attr("data-room-url")))})};Notifications.prototype.processGameSuggestedNotifications=function($suggestions){var self=this;$suggestions.find(".notify-item__closer").click(function(){var $notification=$(this).parents(".notify-item"),suggestData=$notification.find("input[name=game-suggestion-data]");self.rejectGameSuggestion($notification.attr("data-id"),suggestData.attr("data-game-public-id"),suggestData.attr("data-game-name"))});$suggestions.find(".notify-item__buttons .notify-item__button").click(function(e){e.preventDefault();var $this=$(this),$notification=$this.parents(".notify-item"),suggestData=$notification.find("input[name=game-suggestion-data]");$this.hasClass("_play")?self.acceptGameSuggestion($notification.attr("data-id"),suggestData.attr("data-game-public-id"),suggestData.attr("data-game-name"),function(resp){resp.reachedSessionsLimit?self.showReachedSessionsLimitMessage():self.showGameSuggestionAcceptedMessage()}):$this.hasClass("js-cancel")&&self.rejectGameSuggestion($notification.attr("data-id"),suggestData.attr("data-game-public-id"),suggestData.attr("data-game-name"))})};Notifications.prototype.processStandardNotifications=function($notifications){var self=this;$notifications.find(".notify-item__closer").click(function(){var $notification=$(this).parents(".notify-item");self.markAsRead(parseInt($notification.attr("data-id")))});$notifications.find(".notify-item__buttons .notify-item__button._play").click(function(e){e.preventDefault();var $this=$(this),$notification=$this.parents(".notify-item");self.markAsRead($notification.attr("data-id"),function(){window.location.href=$this.attr("href")})})};Notifications.prototype.updateDialogNotificationsCount=function(){var $dlg=$("#notifications-dialog"),count=$dlg.find(".notify-item").length,$notyCount,$notyBtn;count===0?this.clearAndHideNotificationsDialog():($dlg.find(".overall-notify__title").text(count+" "+(count>1?window.SR.Notifications:window.SR.Notification)),$notyCount=$("#page-notifications-counter"),$notyCount.fadeTo(1e3,.3,function(){$notyCount.text(count);$notyCount.fadeTo(300,1)}),$notyBtn=$("#page-notifications-indicator"),$notyBtn.fadeTo(1e3,.5,function(){$notyBtn.removeClass("disabled");$notyBtn.fadeTo(300,1)}))};Notifications.prototype.clearAndHideNotificationsDialog=function(){var $dlg=$("#notifications-dialog"),$notyBtn;$dlg.addClass("hidden");$dlg.find(".overall-notify__list").empty();$notyBtn=$("#page-notifications-indicator");$notyBtn.fadeTo(700,1,function(){$notyBtn.addClass("disabled");$notyBtn.fadeTo(300,.5,function(){$("#page-notifications-counter",$notyBtn).text("")})})};Notifications.prototype.addDialogNotification=function(notification){var $n=$("#dialog-notification-template").clone().removeAttr("id").removeClass("hidden").attr("data-id",notification.Id).attr("data-type",notification.TypeStr),$img,$invDataInput,$readyCheckDataInput,roomUrl,templateUrl,$suggestDataInput;if($n.toggleClass("_nobuttons",notification.Content.HasNoActions),typeof notification.Content.ImageUrl=="undefined"||notification.Content.ImageUrl.length===0?$n.find(".notify-item__image").remove():($img=$n.find(".notify-item__image img"),$img.attr("src",notification.Content.ImageUrl+$img.attr("data-img-query")).css("opacity",1)),$n.find(".notify-item__game span").text(notification.Content.Title),$n.find(".notify-item__info").html(notification.Content.Message),$n.find(".notify-item__time").text(notification.Timestamp),notification.Content.HasNoActions!==!0){var $playAction=$n.find(".notify-item__buttons ._play"),$cancelAction=$n.find(".notify-item__buttons .js-cancel"),$linkAction=$n.find(".notify-item__buttons ._link");this.roomNotificationTypes.indexOf(notification.TypeStr)!==-1?notification.TypeStr==="PlayerInvitedToRoom"?($invDataInput=$("<input type='hidden' name='invitation-data'/>").attr("data-inv-id",notification.Content.InvitationId).attr("data-user-url",notification.Content.UserShortUrl).attr("data-room-url",notification.Content.RoomShortUrl),$invDataInput.insertAfter($cancelAction),$playAction.text(window.SR.Join),$cancelAction.addClass("_cancel").removeClass("hidden").text(window.SR.Reject)):notification.TypeStr==="RoomReadyCheckStarted"?($readyCheckDataInput=$("<input type='hidden' name='ready-check-data'/>").attr("data-user-url",notification.Content.UserShortUrl).attr("data-room-url",notification.Content.RoomShortUrl),$readyCheckDataInput.insertAfter($cancelAction),$playAction.text(window.SR.Ready),$cancelAction.addClass("_cancel").removeClass("hidden").text(window.SR.LeaveRoom),roomUrl=window.urls.roomTemplate.replace("user-short-url",notification.Content.UserShortUrl).replace("room-short-url",notification.Content.RoomShortUrl),$linkAction.attr("href",roomUrl).removeClass("hidden").text(window.SR.GoToRoom)):(templateUrl=notification.TypeStr==="GameStarted"?window.urls.roomPlayTemplate:window.urls.roomTemplate,$playAction.attr("href",templateUrl.replace("user-short-url",notification.Content.UserShortUrl).replace("room-short-url",notification.Content.RoomShortUrl)),$playAction.text(notification.TypeStr==="GameStarted"?window.SR.Play:window.SR.GoToRoom)):notification.TypeStr==="GameSuggested"&&($suggestDataInput=$("<input type='hidden' name='game-suggestion-data'/>").attr("data-game-public-id",notification.Content.GamePublicId).attr("data-game-name",notification.Content.GameName),$suggestDataInput.insertAfter($cancelAction),$playAction.text(window.SR.Yes),$cancelAction.addClass("_bordered").removeClass("hidden").text(window.SR.NotNow))}this.processDialogNotifications($n)};Notifications.prototype.markAsRead=function(notificationId,successCallback){if(typeof notificationId!="number"||notificationId<=0){typeof successCallback=="function"&&successCallback();return}$.ajax({type:"POST",cache:!1,url:window.urls.notificationMarkAsRead,data:{id:notificationId},success:successCallback});this.removeNotification(notificationId)};Notifications.prototype.markAsReadAll=function(){$.ajax({type:"POST",url:window.urls.notificationMarkAsReadAll});this.clearAndHideNotificationsDialog()};Notifications.prototype.acceptInvitation=function(notificationId,invitationId,successCallback,errorCallback){$.ajax({type:"POST",cache:!1,url:window.urls.notificationAcceptInvitation,data:{inviteId:invitationId},success:successCallback,error:errorCallback});this.removeNotification(notificationId)};Notifications.prototype.declineInvitation=function(notificationId,invitationId){$.ajax({type:"POST",cache:!1,url:window.urls.notificationDeclineInvitation,data:{inviteId:invitationId}});this.removeNotification(notificationId)};Notifications.prototype.readyCheckSetReady=function(notificationId,roomShortUrl,successCallback){$.ajax({type:"POST",cache:!1,url:window.urls.readyCheckSetReady,data:{roomShortUrl:roomShortUrl},success:successCallback});this.removeNotification(notificationId)};Notifications.prototype.readyCheckLeaveGame=function(notificationId,roomShortUrl){$.ajax({type:"POST",cache:!1,url:window.urls.leaveRoom,data:{roomShortUrl:roomShortUrl,userId:window.global.currentUserId}});this.removeNotification(notificationId)};Notifications.prototype.removeNotification=function(notificationId){typeof notificationId=="undefined"||notificationId<=0||(Messenger().$el.find("table[data-id="+notificationId+"]").parents(".messenger-message-slot").remove(),$("#notifications-dialog").find(".notify-item[data-id="+notificationId+"]").remove(),this.updateDialogNotificationsCount())};Notifications.prototype.acceptGameSuggestion=function(notificationId,gamePublicId,gameName,successCallback){$.ajax({type:"POST",cache:!1,url:"/api/games/suggestions/"+gamePublicId+"/accept",dataType:"json",success:successCallback});this.removeNotification(notificationId)};Notifications.prototype.rejectGameSuggestion=function(notificationId,gamePublicId){$.ajax({type:"POST",cache:!1,url:"/api/games/suggestions/"+gamePublicId+"/reject",dataType:"json"});this.removeNotification(notificationId)},function($){function httpRequest(url,options){const self=this;typeof url=="function"&&(url=url());let o=$.extend(!0,{},httpRequestDefaults,options),ajax=null;self.data=$.isArray(o.emptyValue)?ko.observableArray(o.emptyValue):ko.observable(o.emptyValue);self.rawData=$.isArray(o.emptyValue)?ko.observableArray(o.emptyValue):ko.observable(o.emptyValue);self.hasData=ko.observable(!1);self.isLoading=ko.observable(!1);self.error=ko.observable("");self.requestCanceled=ko.observable(!1);self.state=ko.pureComputed(function(){return{data:self.data(),hasData:self.hasData(),isLoading:self.isLoading(),error:self.error()}});self.load=function(data,timeout){if(!self.isLoading()){self.isLoading(!0);self.hasData(!1);self.data(o.emptyValue);self.rawData(o.emptyValue);self.error("");self.requestCanceled(!1);let finished=$.Deferred(),request={url:url,type:o.type,traditional:o.traditional,processData:o.processData,data:data,cache:o.cache,context:self};return request.processData===!1&&(request.contentType=!1),setTimeout(function(){ajax=$.ajax(request).done(function(rawJson,textStatus,xhr){self.checkUnauthorizedResponse(xhr);try{let values=o.responseConverter(rawJson);self.data(values);self.rawData(rawJson);self.hasData(!0);self.isLoading(!1)}catch(err){self.error(o.errorMessage);self.hasData(!1);console.error(err)}finished.resolve(rawJson)}).fail(function(e){let errorMessage=e.responseJSON&&e.responseJSON.message?e.responseJSON.message:o.errorMessage;e.getAllResponseHeaders()||(self.requestCanceled(!0),errorMessage="Request Canceled.");self.error(errorMessage);$(window).scrollTop(0);console.error(e);finished.reject(e)}).always(function(){self.isLoading(!1)})},timeout?timeout:0),finished.promise()}};self.checkUnauthorizedResponse=function(xhr){try{let header=xhr.getResponseHeader("X-Responded-JSON");if(header){let obj=JSON.parse(header);obj.status==401&&(window.location.href=obj.headers.location)}}catch(err){console.error(err)}};self.loadIfNoData=function(data){self.hasData()||self.isLoading()||self.load(data)};self.cancel=function(){ajax&&(ajax.abort(),self.requestCanceled(!0))};self.setData=function(data){self.data(data);self.hasData(JSON.stringify(data)!=JSON.stringify(o.emptyValue));self.isLoading(!1);self.error("");self.requestCanceled(!1)}}function httpGet(url,options){var o=$.extend(!0,{type:"GET"},options);httpRequest.call(this,url,o)}function httpPost(url,options){var o=$.extend(!0,{type:"POST"},options);httpRequest.call(this,url,o)}var $routes=$.tabletopia.routes,httpRequestDefaults={errorMessage:"Loading Error.",responseConverter:function(data){return data},emptyValue:{},type:undefined,traditional:!1,processData:!0,cache:!1};const getRequests={users:{current:function(){httpGet.call(this,$routes.users.current(),{emptyValue:{}})}},findPlay:{playNow:function(){httpGet.call(this,$routes.findPlay.playNow(),{traditional:!0})},playLater:function(){httpGet.call(this,$routes.findPlay.playLater(),{traditional:!0})},playInProgress:function(){httpGet.call(this,$routes.findPlay.playInProgress(),{traditional:!0})},recommendedWidgetGames:function(){httpGet.call(this,$routes.findPlay.recommendedWidgetGames(),{traditional:!0,cache:!0})},recommendedGames:function(){httpGet.call(this,$routes.findPlay.recommendedGames(),{emptyValue:{},cache:!0})}}},postRequests={users:{activateCoupon:function(coupon){httpPost.call(this,$routes.users.activateCoupon(coupon))}}};$.extend(!0,$,{tabletopia:{get:getRequests,post:postRequests}})}(jQuery);SubscriptionsManager.prototype.show=function(options){var defaultOptions,self;if(window.user.isDemoUser!==1){if(defaultOptions={loadFromServer:!0,skipIntroDlg:!1},typeof options=="undefined"&&(options={}),this.options=$.extend({},defaultOptions,options),this.currentSubscriptionId=0,self=this,this.options.updatePaymentInfo){this._showChangePaymentInfoDlg(options);return}if(window.user.isInSteamBrowser===0&&this.options.subscriptionType?(window.user.selectedSubscriptionType(this.options.subscriptionType),window.user.selectedSubscriptionType()==="1"&&window.user.trialAllowed()&&(this.options.chooseWindowTitle=window.SR.TakeFreeTrial)):window.user.selectedSubscriptionType(null),this.options.loadFromServer){let url=window.urls.getPurchasingSubscriptionsWeb;window.user.isInSteamBrowser===1&&(url=window.urls.getPurchasingSubscriptionsSteam);$.ajax({url:url+"?userId="+self._userId(),cache:!1,success:function(html){if(typeof html!="string"||html.length===0){$("#error-dlg").modal();return}let bindElement=$("#buy-subscription-all-dlgs")[0];ko.cleanNode(bindElement);$("#buy-subscription-all-dlgs").empty().html(html);window.user.isInSteamBrowser===1?(self._initForSteam(),self._start()):(self._initForWeb(),self._start());bindElement=$("#buy-subscription-all-dlgs")[0];ko.applyBindings(null,bindElement)},error:function(){$("#error-dlg").modal()}})}else window.user.isInSteamBrowser===1?(self._initForSteam(),self._start()):(self._initForWeb(),self._start())}};SubscriptionsManager.prototype._start=function(){const self=this;if(self.$IdempotencyKey=Date.now().toString(36)+Math.random().toString(36).substr(2),window.user.isInSteamBrowser===1)if(self.options.skipIntroDlg){window.dataLayer.push({platform:"steam",current_plan:self.currentSubscriptionId,event:"modal_window__plan_selection"});const buyButtons=self.$chooseDlg.find(".buy-subscription");buyButtons.length!==1&&self._modalChooseSubs(self.$chooseDlg)}else window.dataLayer.push({platform:"steam",event:"modal_window__game_only_for_premium"}),self.$introDlg.modal({backdrop:"static",keyboard:!1});else self.options.skipIntroDlg?(window.dataLayer.push({platform:"web",current_plan:self.currentSubscriptionId,event:"modal_window__plan_selection"}),self._modalChooseSubs(self.$chooseDlg)):(window.dataLayer.push({platform:"web",event:"modal_window__game_only_for_premium"}),self.$introDlg.modal({backdrop:"static",keyboard:!1}))};SubscriptionsManager.prototype._modalChooseSubs=function($modalDlg){var self=this;self.options&&(self.options.closable?$modalDlg.modal():$modalDlg.modal({backdrop:"static",keyboard:!1}))};SubscriptionsManager.prototype._getPledgeDays=function(subscriptionShortName){switch(subscriptionShortName){case"premium3days":return 3;case"premium7days":return 7;case"premium14days":return 14;case"premium1month":return 30;default:return 0}};SubscriptionsManager.prototype._hideBuyDlg=function(){this.$chooseDlg.skipCloseHandler=!0;this.$chooseDlg.modal("hide");this.$cardDlg&&(this.$cardDlg.skipCloseHandler=!0,this.$cardDlg.modal("hide"))};SubscriptionsManager.prototype._completePurchase=function(){var $medal=$("#congratulate-medal"),self;$medal.removeClass("hidden");$medal.offset($("img",this.$congratsDlg).offset());var $nameMenuItem=$("#user-name-menu-item"),position=$nameMenuItem.offset(),topPosition=position.top+$nameMenuItem.height()/2,leftPosition=position.left+$nameMenuItem.width()/2;this.$congratsDlg.modal("hide");$(".js-get-premium-container, .js-get-premium").addClass("hidden");typeof this.options.successCallback=="function"&&this.options.successCallback();self=this;$medal.animate({height:0,width:0,top:topPosition,left:leftPosition},1e3,function(){$("a",$nameMenuItem).addClass("user-premium");typeof self.options.successCallback=="undefined"&&(typeof self.options.buySuccessUrl!="undefined"?window.location.href=self.options.buySuccessUrl:window.location.reload())})};SubscriptionsManager.prototype._cancelPurchase=function(e){typeof this.options.buyCancelUrl!="undefined"&&(e.preventDefault(),window.location.href=this.options.buyCancelUrl)};SubscriptionsManager.prototype._initForSteam=function(){const self=this;self.$chooseDlg=$("#choose-subscription-dlg");const buyButtons=self.$chooseDlg.find(".buy-subscription");self.$waitDlg=$("#wait-subscription-dlg");self.$introDlg=$("#intro-subscription-dlg");self.$introDlg.find(".js-get-premium-btn").click(function(e){window.user.isInSteamBrowser===1?(e.preventDefault(),buyButtons.length===1?self._initSteamInAppOrder($(buyButtons[0])):(self.$introDlg.skipCloseHandler=!0,self.$introDlg.modal("hide"),self._modalChooseSubs(self.$chooseDlg))):window.location.href="/profile"});self.$introDlg.on("hide.bs.modal",function(e){if(self.$introDlg.skipCloseHandler){self.$introDlg.skipCloseHandler=!1;return}self._cancelPurchase(e)});if(self.$congratsDlg=$("#congratulate-subscription-dlg"),self.$congratsDlg.find(".js-congratulate-continue").click(function(e){e.preventDefault();self._completePurchase()}),self.$failDlg=$("#fail-subscription-dlg"),self.$failDlg.find(".js-steam-in-app-try-again-btn").click(function(){self.$failDlg.modal("hide");self._modalChooseSubs(self.$chooseDlg)}),buyButtons.length===1&&self.options.skipIntroDlg){self._initSteamInAppOrder($(buyButtons[0]));return}self.$chooseDlg.find(".buy-subscription").click(function(){self._initSteamInAppOrder($(this))});self.$chooseDlg.on("shown.bs.modal",function(){});self.$chooseDlg.on("hide.bs.modal",function(e){if(self.$chooseDlg.skipCloseHandler){self.$chooseDlg.skipCloseHandler=!1;return}self._cancelPurchase(e)})};SubscriptionsManager.prototype._initSteamInAppOrder=function($button){const self=this;if(!$button.hasClass("disabled")){const subscriptionId=$button.attr("data-subscription-id");$.isNumeric(subscriptionId)&&(self._hideBuyDlg(),self.$waitDlg.modal({backdrop:"static",keyboard:!1}),self._sendRequest("POST",location.protocol+"//"+location.host+"/api/2.0/subscriptions/steam/"+subscriptionId+"/buy",null,function(resp){if(typeof resp!="object"||!resp.result){self.$failDlg.modal();return}typeof self.unity!="undefined"&&typeof self.unity.sendMessage=="function"&&self.unity.sendMessage("RefreshWindow",{})},function(){self.$waitDlg.modal("hide");self.$failDlg.modal()}))}};SubscriptionsManager.prototype.finalizeSteamInAppOrder=function(isAuthorized,appId,orderId){const self=this,data={isAuthorized:isAuthorized,appId:appId,orderId:orderId};console.log("prototype.finalizeSteamInAppOrder: data: '"+JSON.stringify(data)+"'");self._sendRequest("POST",location.protocol+"//"+location.host+"/api/2.0/subscriptions/steam/finalize",data,function(resp){if(console.log("prototype.finalizeSteamInAppOrder - Success Response: '"+JSON.stringify(resp)+"'"),self.$waitDlg.modal("hide"),typeof resp!="object"){$("#error-dlg").modal();return}switch(resp.status){case"Success":var $conDlgImg=$("img",self.$congratsDlg),$conMedalImg=$("#congratulate-medal"),pledgeDays=self._getPledgeDays(resp.subscriptionShortName);window.dataLayer.push({event:"upgrade_success"});$conDlgImg.attr("src",window.urls.cdnUrl+"/Areas/Playground/Content/Images/Premium/premium_"+pledgeDays+"_sun.png");$conMedalImg.attr("src",window.urls.cdnUrl+"/Areas/Playground/Content/Images/Premium/premium_"+pledgeDays+"_sun.png");$conMedalImg.offset($conDlgImg.offset());self._hideBuyDlg();self._modalChooseSubs(self.$congratsDlg);break;case"Canceled":const buyButtons=self.$chooseDlg.find(".buy-subscription");buyButtons.length!==1&&self._modalChooseSubs(self.$chooseDlg);break;case"Error":$("#error-dlg").modal()}},function(){console.log("prototype.finalizeSteamInAppOrder - Error");self.$waitDlg.modal("hide");self.$failDlg.modal()})};SubscriptionsManager.prototype.initSteamDlc=function(){var self=this;$(".js-steam-dlc-buy-button").click(function(){var steamAppId=$(this).attr("data-steam-app-id");typeof self.unity!="undefined"&&typeof self.unity.sendMessage=="function"&&self.unity.sendMessage("BuySteamDlc",{steamAppId:steamAppId})})};SubscriptionsManager.prototype.finalizeSteamDlcOrder=function(steamAppId){$.ajax({url:location.protocol+"//"+location.host+"/api/2.0/subscriptions/steam/dlc/synchronize",data:{SteamDlcId:steamAppId},dataType:"json",type:"POST",cache:!1,async:!0,success:function(){window.location.refresh()},error:function(){window.location.refresh()}})};SubscriptionsManager.prototype._initForWeb=function(){var self=this;self.$stripe=Stripe(window.StripePublishKey);self._initForWebObjects();self._initForWebEvents();self.$cardNumberIsSaved.val()==="False"&&self._initStripeElements();self._modificationWindow()};SubscriptionsManager.prototype._showStripeError=function(result){const self=this;if(result.error){let element;switch(result.error.code){case"incomplete_number":case"invalid_number":element=self.$cardNumber;break;case"incomplete_cvc":element=self.$cardCvc;break;case"incomplete_expiry":case"invalid_expiry_year_past":case"invalid_expiry_year":element=self.$cardExpirationYearMonth;break;default:element=self.$cardNumber}element?(element.tooltip({"class":"tooltip_error",placement:"top",trigger:"manual",html:!0,title:result.error.message}),element.tooltip("show"),setTimeout(function(){element.tooltip("destroy")},5e3)):alert(result.error.message)}};SubscriptionsManager.prototype._initStripeElements=function(){const self=this;self.$cardNumber=self.$cardDlg.find("#StripeCardNumber");self.$cardExpirationYearMonth=self.$cardDlg.find("#StripeCardExpirationYearMonth");self.$cardCvc=self.$cardDlg.find("#StripeCardCvc");self.$cardNumber.removeClass("hidden");self.$cardExpirationYearMonth.removeClass("hidden");self.$cardCvc.removeClass("hidden");const style={base:{height:"25px",lineHeight:"25px",backgroundColor:"#fff",fontSize:"16px"}},elements=self.$stripe.elements();self.$stripeCardNumber=elements.create("cardNumber",{style:style,placeholder:window.SR.CardNumber});self.$stripeCardNumber.mount("#StripeCardNumber");self.$stripeCardNumber.on("ready",function(){self.$stripeCardNumber.focus()});const cardCvc=elements.create("cardCvc",{style:style});cardCvc.mount("#StripeCardCvc");const cardExpiry=elements.create("cardExpiry",{style:style});cardExpiry.mount("#StripeCardExpirationYearMonth");$("#card-payment-form iframe").attr("title","")};SubscriptionsManager.prototype._initForWebObjects=function(){var self=this;self.userTab=window.SR.Silver;self.designerTab=window.SR.Basic;self.$introDlg=$("#intro-subscription-dlg");self.$chooseDlg=$("#choose-subscription-dlg");self.$chooseTabs=$(".modal-plan__tabs",self.$chooseDlg);self.$chooseBtn=$("#choose-subscription-btn",self.$chooseDlg);self.$selectSubsRadioButtons=$(".modal-plan__tab-panel input[type=radio]");self.$chooseDlgSecondTitle=$(".modal-plan-info");self.$choosePlanInfo=$(".modal-plan__info");self.$cardDlg=$("#pay-subscription-dlg");self.$cardGoBackChooseSubsBtn=$("#go-back-to-choose-subs-btn");self.$cardBtns=$("#pay-btn, #go-back-to-choose-subs-btn");self.$cardBillingExpand=$("#card-billing-expand");self.$changeCardBtn=$("#change-card-js");self.$cardNumberIsSaved=self.$cardDlg.find("input[name=CardNumberIsSaved]");self.$cardNumber=self.$cardDlg.find("#CardNumber");self.$cardHolderName=self.$cardDlg.find("input[name=CardHolderName]");self.$cardExpirationYearMonth=self.$cardDlg.find("#CardExpirationYearMonth");self.$cardCvc=self.$cardDlg.find("#CardCvc");self.$cardUid=self.$cardDlg.find("input[name=CardUid]");self.$cardHolderEmail=self.$cardDlg.find("input[name=CardHolderEmail]");self.$cardAddressCountry=self.$cardDlg.find("select[name=CardAddressCountry]");self.$cardAddressCity=self.$cardDlg.find("input[name=CardAddressCity]");self.$cardAddressStreet=self.$cardDlg.find("input[name=CardAddressStreet]");self.$cardAddressZip=self.$cardDlg.find("input[name=CardAddressZip]");self.$cardAddressStateRegion=self.$cardDlg.find("input[name=CardAddressStateRegion]");self.$selectCountryDropdown=$("#pay-subscription-dlg .country");self.$couponCode=self.$cardDlg.find("input[name=CouponCode]");self.$userAgreeWithGeneralTerms=$("#PaymentAgreements");self.$cardForm=self.$cardDlg.find("#card-payment-form")};SubscriptionsManager.prototype._initForWebEvents=function(){var self=this,$tabs,$contents,cvcRequired;$(".js-example-basic-single").select2();self.$introDlg.find(".js-get-premium-btn").click(function(e){e.preventDefault();self.$introDlg.skipCloseHandler=!0;self.$introDlg.modal("hide");self._modalChooseSubs(self.$chooseDlg)});self.$chooseBtn.click(function(){if(self.subscriptionIds=[],self.$chooseDlg.find("input[type=radio]:checked").each(function(i,e){var $element=$(e);self.subscriptionIds.push({id:$element.val(),isFree:$element.attr("data-is-free")})}),self.$chooseDlg.skipCloseHandler=!0,self.subscriptionIds.every(function(subs){return subs.isFree==="1"})){self._buySubscriptions({UserId:self._userId(),SubscriptionIds:self._getChosenSubscriptionIds()});return}self.options.upgradeSubs||(self.$chooseDlg.modal("hide"),self._modalChooseSubs(self.$cardDlg))});self.$introDlg.on("hide.bs.modal",function(e){self.options.redirectToCancelUrl&&!self.$introDlg.skipCloseHandler&&(self.$introDlg.skipCloseHandler=!1,self._cancelPurchase(e))});self.$chooseDlg.on("hide.bs.modal",function(e){self.options.redirectToCancelUrl&&!self.$chooseDlg.skipCloseHandler&&(self.$chooseDlg.skipCloseHandler=!1,self._cancelPurchase(e))});self.$cardDlg.on("hide.bs.modal",function(e){self.options.redirectToCancelUrl&&!self.$cardDlg.skipCloseHandler&&(self.$cardDlg.skipCloseHandler=!1,self._cancelPurchase(e));$(".js-example-basic-single").select2("close")});self.$cardDlg.on("shown.bs.modal",function(){window.dataLayer.push({current_plan:self.currentSubscriptionId,event:"modal_window__card_information"});self.$cardNumberIsSaved.val()==="False"&&self.$stripeCardNumber.focus()});self.$chooseDlg.on("shown.bs.modal",function(){});self.$cardGoBackChooseSubsBtn.click(function(){if($(this).hasClass("disabled"))return!1;$(".plan-list .plan-unit__btn").removeClass("disabled");self.$cardDlg.skipCloseHandler=!0;self.$cardDlg.modal("hide");self._modalChooseSubs(self.$chooseDlg)});self.$cardBillingExpand.click(function(){self.$userAgreeWithGeneralTerms.tooltip("destroy")});$tabs=self.$chooseDlg.find(".modal-plan__tabs li div");$contents=self.$chooseDlg.find(".modal-plan__tab-panel");$tabs.click(function(){$tabs.removeClass("_active");$contents.removeClass("_active");var $currentTab=$(this),activeTabId=$currentTab.attr("data-tab-opener-id");$currentTab.addClass("_active");$contents.filter("[data-tab-id="+activeTabId+"]").addClass("_active");switch(activeTabId){case"01":self.$chooseDlgSecondTitle.removeClass("hidden");self.$choosePlanInfo.removeClass("hidden");break;case"02":self.$chooseDlgSecondTitle.addClass("hidden");self.$choosePlanInfo.addClass("hidden")}});self.$selectSubsRadioButtons.click(function(){var $selectedSubscription=$(this),$activeTab=$(".modal-plan__tab._active span");$activeTab.attr("class","");switch($selectedSubscription.attr("id")){case"gold-player-basic":$activeTab.addClass("_light_grey");$activeTab.text(window.SR.Bronze);self.userTab=window.SR.Bronze;break;case"designer-basic":$activeTab.addClass("_light_grey");$activeTab.text(window.SR.Basic);self.designerTab=window.SR.Basic;break;case"gold-player-adv":$activeTab.addClass("_light_blue");$activeTab.text(window.SR.Silver);self.userTab=window.SR.Silver;break;case"designer-adv":$activeTab.addClass("_light_blue");$activeTab.text(window.SR.Advanced);self.designerTab=window.SR.Advanced;break;case"gold-player-pro":$activeTab.addClass("_gold");$activeTab.text(window.SR.Gold);self.userTab=window.SR.Gold;break;case"designer-pro":$activeTab.addClass("_gold");$activeTab.text(window.SR.Pro);self.designerTab=window.SR.Pro}self.userTab===window.SR.Bronze?self.$chooseBtn.text(window.SR.selectSubsBtnTxt.replace("[tmpUserSbsc]",self.userTab).replace("[tmpDesignerSbsc]",self.designerTab)):self.$chooseBtn.text(window.SR.selectSubsBtnTxt2)});self.$cardAddressZip.mask("AAAAAAAAAAAAAAAA");self.$cardHolderName.bind("keyup",function(){self.$cardHolderName.val(self.$cardHolderName.val().toUpperCase())});self.$cardAddressStateRegion.bind("keyup",function(){self.$cardAddressStateRegion.val(self.$cardAddressStateRegion.val().toUpperCase())});cvcRequired=!self.options.updatePaymentInfo||self.$cardNumberIsSaved.val()==="False";self._setFormRequire();cvcRequired||(self.$cardCvc.prop("disabled",!0),self.$cardCvc.addClass("disabled"),self.$cardCvc.val("***"));self.$changeCardBtn.click(function(){$("#NumberBlock").remove();$("#ExpirationBlock").remove();$("#CvcBlock").remove();self.$cardHolderName.removeClass("disabled");self.$cardHolderName.val("");self.$cardHolderName.prop("disabled",!1);self.$cardNumberIsSaved.val("False");self.$cardUid.val("");self.$changeCardBtn.remove();self._initStripeElements()});self.$cardForm.submit(function(e){if(e.preventDefault(),self.$cardBtns.button("loading"),self.$cardForm.valid()){if(self.$cardNumberIsSaved.val()==="True"&&self.options.updatePaymentInfo){let model={UserId:self._userId(),CardUId:self.$cardUid.val(),CardNumberIsSaved:self.$cardNumberIsSaved.val(),CardHolderEmail:self.$cardHolderEmail.val(),City:self.$cardAddressCity.val(),State:self.$cardAddressStateRegion.val(),Country:self.$cardAddressCountry.val(),Address:self.$cardAddressStreet.val(),Zip:self.$cardAddressZip.val()};self._updatePaymentInfo(model);return}self.$stripe.createPaymentMethod("card",self.$stripeCardNumber,{billing_details:{name:self.$cardHolderName.val(),email:self.$cardHolderEmail.val(),address:{line1:self.$cardAddressStreet.val(),city:self.$cardAddressCity.val(),state:self.$cardAddressStateRegion.val(),country:self.$cardAddressCountry.val(),postal_code:self.$cardAddressZip.val()}}}).then(function(result){if(result.error){self._showStripeError(result);self.$cardBtns.button("reset");return}let model={CardUId:result.paymentMethod.id,CardNumberIsSaved:self.$cardNumberIsSaved.val(),CardHolderEmail:self.$cardHolderEmail.val(),CouponCode:self.$couponCode.val()};if(model.UserId=self._userId(),self.options.updatePaymentInfo){self._updatePaymentInfo(model);return}if(self.options.upgradeSubs){model.NewSubscriptionId=self.subscriptionIds.map(function(val){return parseInt(val.id)})[0];const checkedSubscriptionId=$(".modal-plan__tab-panel._active input[type=radio]:checked",self.$chooseDlg).val();model.SubscriptionId=typeof self.options.lastSubscriptionId!="undefined"&&parseInt(self.options.lastSubscriptionId)>0?self.options.lastSubscriptionId:checkedSubscriptionId;self._updateSubscription(model)}else model.SubscriptionIds=self._getChosenSubscriptionIds(),self._buySubscriptions(model)})}else self.$cardBtns.button("reset")})};SubscriptionsManager.prototype._setFormRequire=function(){const self=this;self.$validator=self.$cardForm.validate({ignore:[],rules:{CardHolderName:{required:!0},CardCoupon:{},CardHolderEmail:{required:!0,email:!0},PaymentAgreements:{required:!0},CardAddressCountry:{required:!0},CardAddressZip:{required:!0}},tooltip_options:{CardHolderName:{trigger:"focus",placement:"top","class":"tooltip_error"},CardHolderEmail:{trigger:"focus",placement:"top","class":"tooltip_error"},PaymentAgreements:{trigger:"focus",placement:"top","class":"tooltip_error"},CardAddressCountry:{trigger:"focus",placement:"top","class":"tooltip_error"},CardAddressZip:{trigger:"focus",placement:"top","class":"tooltip_error"}}})};SubscriptionsManager.prototype._modificationWindow=function(){const self=this;if(self.options.upgradeSubs&&(self.$chooseTabs.find("_active").removeClass("_active"),self.$chooseBtn.addClass("hidden"),self.$chooseTabs.addClass("hidden")),self.options.chooseWindowTitle&&self.$chooseDlg.find(".modal-plan-title").text(self.options.chooseWindowTitle),self.options.chooseTab&&($(".modal-plan__tab").removeClass("_active"),$(".modal-plan__tab-panel").removeClass("_active"),$(".modal-plan__tab[data-tab-opener-id="+self.options.chooseTab+"]").addClass("_active"),$(".modal-plan__tab-panel[data-tab-id="+self.options.chooseTab+"]").addClass("_active")),self.options.upgradeSubs){self.options.subscriptionId&&self.options.subscriptionId!==0||(self.options.subscriptionId=$(".modal-plan__tab-panel._active input[type=radio]:first",self.$chooseDlg).val());let currentSubscriptionId=undefined;currentSubscriptionId=typeof self.options.lastSubscriptionId!="undefined"&&parseInt(self.options.lastSubscriptionId)>0&&typeof self.options.subscriptionId!="undefined"&&self.options.subscriptionId===self.options.lastSubscriptionId?self.options.lastSubscriptionId:typeof self.options.subscriptionId!="undefined"&&parseInt(self.options.subscriptionId)>0?self.options.subscriptionId:$(".modal-plan__tab-panel._active input[type=radio]:checked",self.$chooseDlg).val();self.currentSubscriptionId=currentSubscriptionId;$(".modal-plan__tab-panel._active input[type=radio][value="+currentSubscriptionId+"]",self.$chooseDlg).prop("checked",!0);let toDownGrade=!0;$(".modal-plan__tab-panel._active input[type=radio]").each(function(index,element){var $element=$(element),subsId=$element.val(),$radioButton=$(".modal-plan__tab-panel._active input[type=radio][value="+subsId+"]",self.$chooseDlg);if(subsId===currentSubscriptionId)toDownGrade=!1,$radioButton.parent().find(".plan-unit__btn").remove();else{let $button=$(".modal-plan__tab-panel._active input[type=radio][value="+subsId+"]",self.$chooseDlg).parent().find(".plan-unit__btn");$button.click(function(e){if(e.preventDefault(),!$button.hasClass("disabled")){if(self.subscriptionIds=[],self.subscriptionIds.push({id:subsId,isFree:$element.attr("data-is-free")}),self.$chooseDlg.skipCloseHandler=!0,self.subscriptionIds.every(function(subs){return subs.isFree==="1"})){self.$chooseDlg.modal("hide");var $confirmDlg=$("#confirm-dlg").clone();$confirmDlg.find(".modal__title").text(window.SR.ConfirmCancelSubscription);window.dataLayer.push({downgrade_to_plan:self.subscriptionIds[0].id,current_plan:currentSubscriptionId,event:"modal_window__downgrade_confirmation"});$confirmDlg.modal("show").off("click",".ok-btn").one("click",".ok-btn",function(){$(".plan-list .plan-unit__btn").addClass("disabled");let model={};model.UserId=self._userId();model.NewSubscriptionId=self.subscriptionIds[0].id;model.SubscriptionId=currentSubscriptionId;self._updateSubscription(model)}).off("click",".cancel-btn").one("click",".cancel-btn",function(){$(".plan-list .plan-unit__btn").removeClass("disabled");self._modalChooseSubs(self.$chooseDlg)});return}if($("#pay-subscription-dlg").length>0)self.$chooseDlg.modal("hide"),self._modalChooseSubs(self.$cardDlg);else{$(".plan-list .plan-unit__btn").addClass("disabled");let model={};model.UserId=self._userId();model.NewSubscriptionId=self.subscriptionIds[0].id;model.SubscriptionId=currentSubscriptionId;model.CardNumberIsSaved=!0;self._updateSubscription(model)}}});toDownGrade?$button.text(window.SR.Downgrade):$button.text(window.SR.Upgrade)}})}};SubscriptionsManager.prototype._getChosenSubscriptionIds=function(){return this.subscriptionIds.map(function(val){return parseInt(val.id)}).join(",")};SubscriptionsManager.prototype._validateCardField=function(errorCode,errorMessageFromApi){var self=this,currentInput,errorMessage,$commonError;if(errorCode!=="invalid_request_error")switch(errorCode){case"incorrect_number":currentInput=self.$cardNumber;errorMessage=window.SR.CardIncorrectNumber;break;case"incorrect_cvc":currentInput=self.$cardCvc;errorMessage=window.SR.CardIncorrectCvc;break;case"InvalidSwipeData":errorMessage=errorMessageFromApi?errorMessageFromApi:window.SR.CardInvalidSwipeData;break;case"expired_card":errorMessage=errorMessageFromApi?errorMessageFromApi:window.SR.CardExpiredCard;break;case"address_zip_check":currentInput=self.$cardAddressZip;errorMessage=window.SR.CardIncorrectZip;break;case"card_declined":errorMessage=errorMessageFromApi?errorMessageFromApi:window.SR.CardDeclined;break;case"Missing":errorMessage=errorMessageFromApi?errorMessageFromApi:window.SR.CardMissing;break;case"processing_error":errorMessage=errorMessageFromApi?errorMessageFromApi:window.SR.CardProcessingError;break;case"resource_missing":errorMessage=errorMessageFromApi}else errorCode==="invalid_request_error"&&errorMessageFromApi&&(errorMessage=errorMessageFromApi);errorMessage?currentInput?self.$cardDlg.length>0?(currentInput.tooltip({"class":"tooltip_error",placement:"top",trigger:"manual",html:!0,title:errorMessage}),currentInput.tooltip("show")):self.$chooseDlg.find(".errors-info").html(errorMessage):self.$cardDlg.length>0?($commonError=$("#card-common-error"),$commonError.removeClass("hidden"),$commonError.text(errorMessage),setTimeout(function(){$commonError.addClass("hidden")},5e3)):self.$chooseDlg.find(".errors-info").html(errorMessage):$("#error-dlg").modal()};SubscriptionsManager.prototype._buySubscriptions=function(model){const self=this;model.IdempotencyKey=self.$IdempotencyKey;self._sendRequest("POST",location.protocol+"//"+location.host+"/api/2.0/subscriptions",model,function(data){self._successPayment(data,self,"plan_chosen_first")},function(data){self._errorPayment(data,self)})};SubscriptionsManager.prototype._updateSubscription=function(model){const self=this;model.IdempotencyKey=self.$IdempotencyKey;self._sendRequest("PUT",location.protocol+"//"+location.host+"/api/2.0/subscriptions",model,function(data){self._successPayment(data,self,"plan_changed")},function(data){self._errorPayment(data,self)})};SubscriptionsManager.prototype._confirmPayment=function(data,self,eventName){const userId=self._userId(),subscriptionId=data.subscriptionId,subscriptionName=data.subscriptionName,prevSubscriptionName=data.prevSubscriptionName;self.$stripe.confirmCardPayment(data.clientSecret).then(function(result){if(result.error)self.$IdempotencyKey=Date.now().toString(36)+Math.random().toString(36).substr(2),self._sendRequest("DELETE",location.protocol+"//"+location.host+"/api/2.0/subscriptions/payment-info?userId="+userId),self._validateCardField(result.error.type,result.error.message),self.$cardBtns.button("reset");else{let model={SubscriptionId:subscriptionId};self._sendRequest("POST",location.protocol+"//"+location.host+"/api/2.0/subscriptions/activate",model,function(data){data.subscriptions.every(function(result){result.status.status!=="fail"&&window.dataLayer.push({user_id:userId,trial:result.status.status==="trialing",plan_new:subscriptionName,plan_previous:prevSubscriptionName,user_subscription_id:subscriptionId,event:eventName})});window.dataLayer.push({event:"upgrade_success"});window.location.href=self.options.buySuccessUrl?self.options.buySuccessUrl:window.urls.currentUserProfile})}})};SubscriptionsManager.prototype._successPayment=function(data,self,eventName){if(!data.subscriptions||data.subscriptions.every(function(result){return result.status.status==="fail"})){$(".plan-list .plan-unit__btn").removeClass("disabled");const firstUnsuccessfulResult=$.grep(data.subscriptions,function(result){return result.status.status==="fail"})[0];self._validateCardField(firstUnsuccessfulResult.status.errorCode,firstUnsuccessfulResult.status.errorMessageFromApi);self.$cardBtns.button("reset");self.$IdempotencyKey=Date.now().toString(36)+Math.random().toString(36).substr(2);window.dataLayer.push({event:"upgrade_failed"})}else{const requiresActions=$.grep(data.subscriptions,function(result){return result.status.status==="requires_action"||result.status.status==="incomplete"});if(requiresActions.length>0){self._confirmPayment(requiresActions[0],self,eventName);return}const userId=self._userId();data.subscriptions.every(function(result){result.status.status!=="fail"&&window.dataLayer.push({user_id:userId,trial:result.status.status==="trialing",plan_new:result.subscriptionName,plan_previous:result.prevSubscriptionName,user_subscription_id:result.subscriptionId,event:eventName})});window.dataLayer.push({event:"upgrade_success"});window.location.href=self.options.buySuccessUrl?self.options.buySuccessUrl:window.urls.currentUserProfile}};SubscriptionsManager.prototype._errorPayment=function(data,self){window.dataLayer.push({event:"upgrade_failed"});self.$cardDlg.modal("hide");$(".plan-list .plan-unit__btn").removeClass("disabled");$("#error-dlg").modal();self.$cardBtns.button("reset")};SubscriptionsManager.prototype._sendRequest=function(type,url,model,successCallback,errorCallback){$.ajax({url:url,data:model,dataType:"json",type:type,cache:!1,async:!0,success:function(data){successCallback&&successCallback(data)},error:function(data){errorCallback&&errorCallback(data)}})};SubscriptionsManager.prototype._cancelSubscription=function(model){var self=this;$.ajax({url:location.protocol+"//"+location.host+"/api/subscriptions/general/"+model.SubscriptionId+"/cancel",data:model,dataType:"json",type:"POST",cache:!1,async:!0,success:function(data){data.result&&data.result.success?window.location.href=window.urls.currentUserProfile:(self.$cardDlg.modal("hide"),self.$chooseDlg.modal("hide"),$("#error-dlg").modal())},error:function(){self.$cardDlg.modal("hide");self.$chooseDlg.modal("hide");$("#error-dlg").modal()}})};SubscriptionsManager.prototype._userId=function(){return window.global.currentUserId};SubscriptionsManager.prototype._showChangePaymentInfoDlg=function(){var self=this;$.ajax({url:window.urls.getPaymentInfo+"?userId="+self._userId(),cache:!1,success:function(html){var $cancelBtn,$submitBtn;if(typeof html!="string"||html.length===0){$("#error-dlg").modal();return}$("#buy-subscription-all-dlgs").empty().html(html);self._initForWeb();$cancelBtn=self.$cardDlg.find("#go-back-to-choose-subs-btn");$cancelBtn.text(window.SR.Cancel);$cancelBtn.attr("data-loading-text",window.SR.Cancel);$submitBtn=self.$cardDlg.find("#pay-btn");$submitBtn.text(window.SR.SaveChanges);self.$cardDlg.find(".modal-plan-title").text(window.SR.UpdatePaymentInformation);window.dataLayer.push({current_plan:self.currentSubscriptionId,event:"modal_window__card_information"});self.$cardDlg.modal()},error:function(){$("#error-dlg").modal()}})};SubscriptionsManager.prototype._updatePaymentInfo=function(model){var self=this;self._sendRequest("PUT",location.protocol+"//"+location.host+"/api/2.0/subscriptions/payment-info",model,function(data){data.status&&data.status.status==="complete"?window.location.href="/playground/players/"+window.user.shortUrl+"/edit":(self._validateCardField(data.status.errorCode,data.status.errorMessageFromApi),self.$cardBtns.button("reset"))},function(){$("#error-dlg").modal()})};App.prototype.initTtCookie=function(){var cookie=window.cookie.environmentCookieName+"="+window.cookie.retinaValueName+"="+(window.devicePixelRatio>1)+"&"+window.cookie.timezoneOffsetValueName+"="+(new Date).getTimezoneOffset();document.cookie=cookie+"; path=/; secure; SameSite=Lax"};App.prototype.initPlayingNowRoomsCount=function(){this.settings.loadPlayingNowRoomsCount!==!1&&window.global.currentUserId!=="0"&&window.global.currentUserId!==0&&$.ajax({url:window.urls.playingNowRoomsCount,cache:!1,success:function(data){if(data&&data.count&&data.count>0){var $roomsBtn=$(".playing-now-rooms-show-hidden-js"),$roomsCount=$(".playing-now-rooms-count-dynamic-js");$roomsBtn.fadeTo(700,.5,function(){$roomsBtn.removeClass("disabled");$roomsCount.html(data.count);$roomsBtn.fadeTo(300,1)})}}})};App.prototype.initPlayingNowRooms=function(){var self=this;$("#playing-now-room-btn").click(function(){$(this).hasClass("disabled")||$.ajax({url:window.urls.playingNowRooms,cache:!1,success:function(data){$(".playing-now-rooms-dynamic-js").each(function(i,e){$(e).html(data);$("#playing-now-room-dlg").modal();var count=$("#playing-now-room-dlg .carousel__item").not("._empty").length;$(".playing-now-rooms-count-dynamic-js").html(count);self.modalCarousel($("#playing-now-room-dlg .carousel._modal"));initPlayingNowRooms()})}})})};App.prototype.initTooltip=function(){$("body").tooltip({selector:"[title]",html:!0,container:"body"})};App.prototype.carousel=function($carousels,settings){typeof settings=="undefined"&&(settings=window.global.carouselSettings);$carousels.not(".slick-initialized").slick(settings);$carousels.removeClass("hidden")};App.prototype.modalCarousel=function($carousels){this.carouselHelper=new CarouselHelper;this.carouselHelper.initModalCarousel($carousels,window.global.carouselSettings)};App.prototype.modal=function(){$(".modal").on("shown.bs.modal",function(){$(this).find(".carousel").slick("setPosition")})};App.prototype.initWindowControlBtns=function(){if(this.unity&&typeof this.unity.sendMessage=="function"){var self=this,unity=self.unity;window.SetFullscreen=function(fullscreen,json){self.setMaximizeButtonType(json.value)};$("#maximize-wnd-btn").removeClass("hidden").click(function(){unity.sendMessage("SwitchFullscreen",{})});window.global.isWinOs()&&$("#minimize-wnd-btn").removeClass("hidden").click(function(){unity.sendMessage("MinimizeWindow",{})});$("#close-wnd-btn").removeClass("hidden").click(function(){unity.sendMessage("ApplicationExit",{})})}};App.prototype.setMaximizeButtonType=function(fullScreen){fullScreen?$("#maximize-wnd-btn").addClass("_off"):$("#maximize-wnd-btn").removeClass("_off")};App.prototype.initPageUrl=function(){var self=this;$("#page-url-input").click(function(){if(this.innerText&&this.innerText.length>0){var range,selection;window.getSelection&&document.createRange?(selection=window.getSelection(),range=document.createRange(),range.selectNodeContents(this),selection.removeAllRanges(),selection.addRange(range)):document.selection&&document.body.createTextRange&&(range=document.body.createTextRange(),range.moveToElementText(this),range.select())}});$("#page-url-copy-btn").click(function(){var text=$("#page-url-input").text();self.unity&&typeof self.unity.sendMessage=="function"&&text&&self.unity.sendMessage("CopyToClipboard",{data:text})})};App.prototype.initGames=function($games){$games.click(function(){var $this=$(this),url=$this.attr("data-game-url");url&&(window.location.href=url)});$games.find(".play-now-button-js").click(App.prototype.createRoom)};App.prototype.urlClickOnce=function(e){e.stopPropagation();var $this=$(this);return $this.attr("data-clicked")!==undefined?!1:($this.attr("data-clicked",!0),!0)};App.prototype.fixPasteToTextInputs=function(){if(window.global.isMacOs()&&this.unity&&typeof this.unity.sendMessage=="function")$("input[type=text]").on("paste",function(){var self=this,selStart=this.selectionStart,selEnd=this.selectionEnd,origLength=this.value.length;setTimeout(function(){var newVal=self.value,halfPasted,fixedVal;if(newVal.length!==0){var pastedLength=newVal.length-(origLength-(selEnd-selStart)),pastedEnd=selStart+pastedLength,pasted=newVal.slice(selStart,pastedEnd);pasted.length!==0&&(halfPasted=pasted.substring(0,pasted.length/2),fixedVal="",selStart>0&&(fixedVal+=newVal.substring(0,selStart)),fixedVal+=halfPasted,pastedEnd<newVal.length&&(fixedVal+=newVal.substring(pastedEnd)),self.value=fixedVal)}},10)})};App.prototype.initGetPremium=function(){$(".js-get-premium").click(function(){var $self=$(this),skipIntroDlg=$self.attr("skip-intro-dlg")==="1",upgradeSubs=$self.attr("upgrade-subs")==="1",upgradingSubscriptionId=$self.attr("data-subscription-id"),lastSubscriptionId=$self.attr("data-last-subscription-id"),subscriptionType=$self.attr("data-subscription-type"),chooseWindowTitle=$self.attr("choose-window-title"),chooseTab=$self.attr("choose-tab");window.global.subscriptionsManager.show({skipIntroDlg:skipIntroDlg,closable:!0,upgradeSubs:upgradeSubs,subscriptionId:upgradingSubscriptionId,subscriptionType:subscriptionType,lastSubscriptionId:lastSubscriptionId,chooseTab:chooseTab,chooseWindowTitle:chooseWindowTitle})})};App.prototype.initNotificationForDemoUser=function(){window.user.isDemoUser===1&&$("#notification-container").show()};App.prototype.initRating=function(unity,ga){var gameDurationSeconds,seconds,ratingManager;window.user.isInSteamBrowser===1&&(gameDurationSeconds=getCookieValue("tt-gds"),gameDurationSeconds&&(seconds=parseInt(gameDurationSeconds),seconds>=1800&&seconds<=10800&&(ratingManager=new RatingManager(ga,unity))))};App.prototype.reloginSteamUser=function(){var self=this;typeof self.unity!="undefined"&&typeof self.unity.sendMessage=="function"&&window.global.currentUserId===0&&self.unity.sendMessage("Relogin",{})};App.prototype.initUserData=function(callback){$.ajax({url:"/api/security/currentuser",cache:!1,dataType:"JSON",success:function(data){var $premiumBtnArea,$userLink,$mainAvatar,$img;window.global.isAuthenticated=data.isAuthenticated;data.isAuthenticated&&data.userId>0?(window.global.currentUserId=data.userId,window.user.id=data.userId,window.user.email=data.email,window.user.isAuthenticated=1,window.user.trialAllowed(data.trialAllowed)):(window.global.currentUserId=0,window.user.id=0,window.user.email="",window.user.isAuthenticated=0);window.user.isDemoUser=data.isDemoUser;data.isPremium||data.isDemoUser||($premiumBtnArea=$(".js-get-premium"),$premiumBtnArea.fadeTo(700,.5,function(){$premiumBtnArea.removeClass("hidden");$premiumBtnArea.fadeTo(300,1,function(){})}));window.user.isInSteamBrowser===1?($userLink=$("#user-name-menu-item a"),$userLink.length>0&&$userLink.fadeTo(700,.3,function(){data.isPremium&&$userLink.addClass("user-premium");$userLink.text(data.displayName);$userLink.fadeTo(300,1,function(){})})):($mainAvatar=$("#popup-profile"),$mainAvatar.length>0&&($img=$("img",$mainAvatar),$img.attr("alt",data.displayName),$img.fadeTo(700,.1,function(){data.avatarUri?$img.attr("src",data.avatarUri+"?width=40&height=40&scale=both&mode=crop"):$img.attr("src",window.urls.cdnUrl+window.urls.defaultUserAvatar+"?width=40&height=40&scale=both&mode=crop");$img.on("load",function(){$img.fadeTo(300,1)})})));callback&&callback()}})};App.prototype.showAskUserEmail=function(successCallback,closeCallback,errorCallback){var self=this,$dlg,$form,$email,url,userId;if((!localStorage["ask-user-email"]||!(new Date<new Date(localStorage["ask-user-email"])))&&($dlg=$("#ask-user-email-dlg"),$dlg.lenght!==0)){if($dlg.attr("data-is-initialized")!=="1"){$dlg.attr("data-is-initialized","1");$dlg.find(".js-close-btn").click(function(){typeof closeCallback=="function"&&closeCallback()});$dlg.on("hide.bs.modal",function(){var date=new Date;date.setDate(date.getDate()+3);localStorage["ask-user-email"]=date});$form=$("#ask-user-email-form",$dlg);$email=$("#Email-Add-Email",$form);$email.keyup(function(){self.destroyErrorTooltip($email)});url=$form.prop("action");userId=$("#Email-Add-UserId",$form).val();$form.submit(function(e){e.preventDefault();var email=$("#Email-Add-Email",$form).val(),subscribeOnNews=$("#SubscribeOnNews",$form).is(":checked");if(!self.isEmail(email)){self.destroyErrorTooltip($email);self.showErrorTooltip($email,"Enter correct email.");return}$.ajax({url:url,data:{userId:userId,email:email,subscribeOnNews:subscribeOnNews},type:"POST",cache:!1,success:function(data){self.destroyErrorTooltip($email);data.success?($dlg.modal("hide"),typeof successCallback=="function"&&successCallback()):data.emailError&&(data.emailDublicate?self.showErrorTooltip($email,"This email is using by another user."):self.showErrorTooltip($email,"Enter correct email."),$email.tooltip("show"),typeof errorCallback=="function"&&errorCallback())},error:function(){$dlg.modal("hide");typeof errorCallback=="function"?errorCallback():$("#error-dlg").modal()}})})}$dlg.modal()}};App.prototype.showErrorTooltip=function($element,text){setTimeout(function(){$element.tooltip({"class":"tooltip_error",placement:"right",trigger:"manual",title:text}).tooltip("show")},500)};App.prototype.destroyErrorTooltip=function($element){$element.tooltip("destroy")};App.prototype.isEmail=function(email){return/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(email)};App.prototype.openUrl=function(e,unity,url,isSteamBrowser){e.preventDefault();isSteamBrowser===1?url&&typeof unity!="undefined"&&unity.sendMessage("OpenUrl",{openUrl:url}):window.open(url,"_blank")};App.prototype.initCommentBlock=function(){$.ajax({url:"/playground/home/commentblock",type:"GET",cache:!1,async:!1,success:function(data){$("#comment-block-container").html(data)}})};App.prototype.initInsertTextToActiveInput=function(){this.unity&&typeof this.unity.subscribe=="function"&&window.global.isMacOs()&&(window.InsertTextToActiveInput=function(funcName,json){$(document.activeElement).val(json.value)})};App.prototype.initAdRiver=function(){};App.prototype.initReposrtIssue=function(){var $form=$("#reposrt-an-issue-form"),url;$(".js-example-basic-single",$form).select2();$("#report-an-issue").click(function(){$("#reposrt-an-issue").modal()});$form.validate({ignore:[],rules:{Summary:{required:!0},Description:{required:!0},Name:{required:!0},Email:{required:!0,email:!0},FeedbackType:{required:!0}},tooltip_options:{Summary:{trigger:"focus",placement:"top","class":"tooltip_error"},Description:{trigger:"focus",placement:"top","class":"tooltip_error"},Name:{trigger:"focus",placement:"top","class":"tooltip_error"},Email:{trigger:"focus",placement:"top","class":"tooltip_error"},FeedbackType:{trigger:"focus",placement:"top","class":"tooltip_error"}}});url=$form.attr("action");$("#reposrt-an-issue-submit").click(function(){$form.valid()&&$.ajax({url:url,type:"POST",dataType:"json",data:{Summary:$("#Summary",$form).val(),Description:$("#Description",$form).val(),Name:$("#Name",$form).val(),Email:$("#feedback-email",$form).val(),FeedbackType:$("#FeedbackType",$form).val()},success:function(){$("#reposrt-an-issue-form-container").addClass("hidden");$("#reposrt-an-issue-result-container").removeClass("hidden");setTimeout(function(){$("#reposrt-an-issue").modal("hide");$("body").click();setTimeout(function(){$("#reposrt-an-issue-form-container").removeClass("hidden");$("#reposrt-an-issue-result-container").addClass("hidden");$("#Summary,#Description,#Name,#feedback-email",$form).val("")},1e3)},3e3)},error:function(){}})})};App.prototype.initSteamDlc=function(){window.isInSteamBrowser===1&&window.global.subscriptionsManager.initSteamDlc()};ActiveRooms.prototype.add=function($container,roomsCountChangedCallback){var self=this;roomsCountChangedCallback&&self.roomsCountChangedCallbacks.push(roomsCountChangedCallback);$container.find(".continue-button").click(function(e){e.stopPropagation()});$(".carousel__item",$container).not("._empty").not(".hidden").each(function(i,el){self.rooms.push(el)});$(".carousel__item",$container).click(function(){var link=$(this).attr("data-room-url");link&&(window.location.href=link)});$("._abandon-game",$container).click(function(e){e.stopPropagation();var $this=$(this),isMyRoom=parseInt($this.attr("data-is-my-room")),$modalTitle=$("#leave-room-model-title");if(isMyRoom===1){$modalTitle.text(window.SR.areYouSureYouWantToFinishGameAndDeleteRoom);$("#confirm-abandon-room").modal("show").off("click",".ok-btn").one("click",".ok-btn",function(){self.closeRoom($this.attr("data-room-id"),window.urls.closeRoom,$this)})}else{$modalTitle.text(window.SR.areYouSureYouWantToLeaveRoom);$("#confirm-abandon-room").modal("show").off("click",".ok-btn").one("click",".ok-btn",function(){self.closeRoom($this.attr("data-room-id"),window.urls.leaveRoom,$this,window.global.currentUserId)})}})};ActiveRooms.prototype.closeRoom=function(id,url,$closeBtn,userId){var self=this,roomsForCloseArr=self.rooms.filter(function(elem){return $(elem).attr("data-room-id")===id}),roomShortUrl=$closeBtn.attr("data-room-url");$.ajax({type:"POST",url:url,data:{roomShortUrl:roomShortUrl,userId:userId},cache:!1,success:function(){var roomsCount,i;for($(roomsForCloseArr).each(function(i,room){var $room=$(room),$parentCarousel=$room.parents(".carousel"),itemIndex=$parentCarousel.find(".carousel__item").index($room);$parentCarousel.slick("slickRemove",itemIndex,!1);$parentCarousel.slick("setPosition")}),self.rooms=self.rooms.filter(function(elem){return $(elem).attr("data-room-id")!==id}),roomsCount=self.getUniqRoomsCount(),i=0;i<self.roomsCountChangedCallbacks.length;i++)self.roomsCountChangedCallbacks[i](roomsCount)}})};ActiveRooms.prototype.getUniqRoomsCount=function(){for(var hashTable={},i=0;i<this.rooms.length;++i)hashTable[this.rooms[i].getAttribute("data-room-id")]=1;return Object.keys(hashTable).length};FavoriteGames.prototype.registerCallbacks=function(addCallback,removeCallback){this.addCallback=addCallback;this.removeCallback=removeCallback};FavoriteGames.prototype.init=function($favorites){var self=this;$favorites&&$favorites.length!==0&&(window.global.currentUserId!=="0"&&window.global.currentUserId!==0&&$.ajax({url:"/api/games/bookmarks/id?format=json",cache:!1,success:function(data){var $usersBookmarks=$favorites.filter(function(){var $bookmark=$(this);return $.inArray(parseInt($bookmark.attr("data-public-id")),data.publicIds)!==-1});$usersBookmarks.each(function(i,e){var $element=$(e);$element.hasClass("_active")||($element.attr("title",window.SR.RemoveFromBookmarks),$element.fadeTo(700,.3,function(){$element.addClass("_active");$element.fadeTo(300,1,function(){})}))})}}),$favorites.click(function(e){e.stopPropagation();var $this=$(this),publicId=$this.attr("data-public-id");publicId&&($this.hasClass("_active")?$.ajax({url:"/api/games/unfavor?format=json",data:{gamePublicId:publicId},cache:!1,async:!1,type:"POST",success:function(){var $favorite=$(".favorite[data-public-id="+publicId+"]");$favorite.removeClass("_active");$favorite.attr("data-original-title",window.SR.addFavorite);self.removeCallback&&self.removeCallback(publicId)}}):$.ajax({url:"/api/games/favor?format=json",data:{gamePublicId:publicId},cache:!1,type:"POST",success:function(){var $favorite=$(".favorite[data-public-id="+publicId+"]"),$item;$favorite.addClass("_active");$favorite.attr("data-original-title",window.SR.removeFavorite);self.addCallback&&($item=$this.parents(".item"),self.addCallback(publicId,$item))}}))}))};UsersManager.prototype.initHubMethods=function(){var self=this,usersHubProxy=$.connection.uh;usersHubProxy.client.userJoinedPage=function(userId,pageType,userInfo){for(var i=0;i<self.userJoinedPageCallbacks.length;i++)self.userJoinedPageCallbacks[i](userId,pageType,userInfo)};usersHubProxy.client.userLeftPage=function(userId,pageType,completelyLeft){for(var i=0;i<self.userLeftPageCallbacks.length;i++)self.userLeftPageCallbacks[i](userId,pageType,completelyLeft)};usersHubProxy.client.readyCheckOpenGame=function(roomShortUrl){for(var i=0;i<self.readyCheckOpenGameCallbacks.length;i++)self.readyCheckOpenGameCallbacks[i](roomShortUrl)}};UsersManager.prototype.addUserJoinedPageCallback=function(callBack){typeof callBack=="function"&&this.userJoinedPageCallbacks.push(callBack)};UsersManager.prototype.addUserLeftPageCallback=function(callBack){typeof callBack=="function"&&this.userLeftPageCallbacks.push(callBack)};UsersManager.prototype.addReadyCheckOpenGameCallback=function(callBack){typeof callBack=="function"&&this.readyCheckOpenGameCallbacks.push(callBack)};window.global=window.global||{};window.global.breakpointXLg=1480;window.global.breakpointLg=1199;window.global.carouselSettings={slidesToShow:5,slidesToScroll:5,arrows:!1,dots:!0,variableWidth:!0,infinite:!1,draggable:!1,lazyLoad:"ondemand",responsive:[{breakpoint:window.global.breakpointXLg,settings:{slidesToShow:4,slidesToScroll:4}}]};window.global.linkifySettings={format:{url:function(value){return value.length>30?value.slice(0,30)+"...":value}}};window.global.htmlRegex=/<(br|basefont|hr|input|source|frame|param|area|meta|!--|col|link|option|base|img|wbr|!DOCTYPE).*?>|<(a|abbr|acronym|address|applet|article|aside|audio|b|bdi|bdo|big|blockquote|body|button|canvas|caption|center|cite|code|colgroup|command|datalist|dd|del|details|dfn|dialog|dir|div|dl|dt|em|embed|fieldset|figcaption|figure|font|footer|form|frameset|head|header|hgroup|h1|h2|h3|h4|h5|h6|html|i|iframe|ins|kbd|keygen|label|legend|li|map|mark|menu|meter|nav|noframes|noscript|object|ol|optgroup|output|p|pre|progress|q|rp|rt|ruby|s|samp|script|section|select|small|span|strike|strong|style|sub|summary|sup|table|tbody|td|textarea|tfoot|th|thead|time|title|tr|track|tt|u|ul|var|video).*?<\/\2>/i;window.global.isWinOs=function(){return window.navigator.platform&&window.navigator.platform.toLowerCase().indexOf("win")>-1};window.global.isMacOs=function(){return window.navigator.platform&&window.navigator.platform.toLowerCase().indexOf("mac")>-1};window.global.browserSupportsLocalStorage=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(e){return!1}};$.ajaxSetup({beforeSend:function(jqxhr,settings){var errorCallback=settings.error;settings.error=function(jqxhr,textStatus,errorThrown){typeof jqxhr=="object"&&jqxhr.status===401?window.location.href=window.urls.login.replace("redirect_url",window.location.pathname+window.location.search):typeof errorCallback=="function"&&errorCallback(jqxhr,textStatus,errorThrown)}}}),function(){var myNav=navigator.userAgent.toLowerCase(),html=document.documentElement,ie;myNav.indexOf("msie")!==-1?(ie=myNav.indexOf("msie")!==-1?parseInt(myNav.split("msie")[1]):!1,html.className+=" ie ie"+ie):!myNav.match(/trident.*rv\:11\./)||(html.className+=" ie ie11");myNav.indexOf("safari")!==-1&&(html.className+=myNav.indexOf("chrome")===-1?" safari":" chrome");myNav.indexOf("firefox")!==-1&&(html.className+=" firefox");myNav.indexOf("windows")!==-1&&(html.className+=" windows")}();$(function(){$.ajax({url:window.urls.UserData,cache:!1,dataType:"HTML",async:!1,success:function(html){$("#user-data").html(html)}});window.global.reset=new Reset;window.global.signalrManager=new SignalrManager(typeof window.unity.client!="undefined"?1:0);window.global.subscriptionsManager=new SubscriptionsManager(typeof window.unity.client=="undefined"?{}:window.unity.client,typeof ga!="function"?function(){}:ga);window.global.app=new App(typeof window.unity.client=="undefined"?{}:window.unity.client,typeof ga!="function"?function(){}:ga,typeof gaFunc!="function"?function(){}:gaFunc);window.global.history=new History;window.global.usersManager=new UsersManager;window.global.search=new Search;window.global.activeRooms=new ActiveRooms;window.global.favoriteGames=new FavoriteGames;window.global.newsletterSubscription=new NewsletterSubscription($("#subscribe-newsletter"),$("#subscribeme"));window.global.notifications=new Notifications(typeof ga!="function"?function(){}:ga)});WelcomeManager.prototype.init=function($carousel){var self=this;if(window.global.currentUserHasAnySubscriptions!==0&&$carousel.length!==0&&localStorage["welcome-showed"]!=="1"){var currentPageIndex=0,itemLength=$(".welcome-slider-item",$carousel).length-1,$nextBtn=$("._next",self.$dlg);$carousel.slick({slidesToShow:1,slidesToScroll:1,arrows:!1,dots:!0,variableWidth:!0,draggable:!1,autoplay:!1,lazyLoad:"ondemand"});$(".slick-dots > li:first",self.$dlg).addClass("hidden");$(".slick-dots",self.$dlg).addClass("hidden");$nextBtn.addClass("hidden");$carousel.on("afterChange",function(e,slick,currentSlide){currentPageIndex=currentSlide+1;currentSlide!==0&&($(".slick-dots",self.$dlg).removeClass("hidden"),$nextBtn.removeClass("hidden"));itemLength===currentSlide?($nextBtn.text(window.SR.GotIt),$nextBtn.unbind("click"),$nextBtn.click(function(){self.$dlg.modal("hide")})):($nextBtn.text(window.SR.Next),$nextBtn.unbind("click"),$nextBtn.click(function(){$carousel.slick("slickNext")}))});$(".ok-btn",self.$dlg).click(function(e){e.preventDefault();$carousel.slick("slickNext")});window.user.isInSteamBrowser===1&&$("#welcome-screen-discord",self.$dlg).click(function(e){e.preventDefault();var link=$(this).attr("href");self.unity&&typeof self.unity.sendMessage=="function"&&link&&self.unity.sendMessage("OpenUrlInSteamOverlay",{openUrl:link})});$nextBtn.click(function(){$carousel.slick("slickNext")});self.$dlg.modal();self.$dlg.on("hidden.bs.modal",function(){localStorage["welcome-showed"]="1"})}};RatingManager.prototype._init=function(){var self=this,$input;$(".js-no-thanks",self.$dlg).click(function(e){e.preventDefault();localStorage["rate-tt"]=self._addMonthsToCurrentDate(3)});$(".js-remind-later",self.$dlg).click(function(e){e.preventDefault()});self.$rating.barrating({_initialRating:0,allowEmpty:!0,emptyValue:"",showSelectedRating:!1,theme:"css-stars",readonly:!1,onSelect:function(value,text,event){self._onSelectRate(value,text,event)}});$input=$(".review-message",self.$dlg);$input.on("focus",function(){$input.addClass("focus")});$input.on("focusout",function(){$input.removeClass("focus")});self._showRateDlg(self.$dlg)};RatingManager.prototype._onSelectRate=function(value,text,event){var self=this,rating;typeof event!="undefined"?(self.$rating.barrating("readonly",!0),rating=parseInt(value),localStorage["rate-tt"]=self._addMonthsToCurrentDate(6),rating>3?self._effectRateDlg(function(){self._showThanksDlg()}):self._effectRateDlg(function(){self._showFeedbackDlg(rating)})):$("#error-dlg").modal()};RatingManager.prototype._showRateDlg=function(){var self=this;self.$dlg.modal("show")};RatingManager.prototype._afterRate=function(){var self=this;$(".rate-refuse-button",self.$dlg).addClass("hidden");$(".small-close-btn",self.$dlg).removeClass("hidden");$(".invitations-text",self.$dlg).text(window.SR.RateThankYouTitle)};RatingManager.prototype._showThanksDlg=function(){var self=this,$reviewBtn;self._afterRate(self.$dlg);$(".rate-tabletopia-text",self.$dlg).text(window.SR.RateThankYouText);$(".modal__buttons",self.$dlg).addClass("_call-to-action");$reviewBtn=$(".js-write-review-button",self.$dlg);$reviewBtn.removeClass("hidden");$reviewBtn.click(function(e){if(e.preventDefault(),self.unity&&typeof self.unity.sendMessage=="function"){var reviewUrl=$(this).attr("href");self.unity.sendMessage("OpenUrlInSteamOverlay",{openUrl:reviewUrl})}})};RatingManager.prototype._showFeedbackDlg=function(rating){var self=this,$feedbackBtn;self._afterRate(self.$dlg);$(".rate-tabletopia-text",self.$dlg).text(window.SR.RateTabletopiaWhatToMake);$(".review-message",self.$dlg).removeClass("hidden");$(".modal__buttons",self.$dlg).addClass("_review-button");$feedbackBtn=$(".js-send-feed-back-button",self.$dlg);$feedbackBtn.removeClass("hidden");$feedbackBtn.click(function(e){var sourceMessage,messageText;e.preventDefault();sourceMessage=$(".review-message",self.$dlg).val();sourceMessage&&(messageText="[rate] "+rating+"-stars: "+sourceMessage,$.ajax({url:"/api/support/bugs/submit",data:{userId:window.global.currentUserId,message:messageText},type:"POST",cache:!1,success:function(){},error:function(){$("#error-dlg").modal()}}))})};RatingManager.prototype._effectRateDlg=function(callback){var self=this;$("#rate-dlg-content",self.$dlg).animate({left:"+=450"},700,function(){$(this).css("left","0px").css("display","block");callback&&callback()})};RatingManager.prototype._addMonthsToCurrentDate=function(addMonthsCount){var date=new Date;return date.setMonth(date.getMonth()+addMonthsCount),date};RatingManager.prototype._isRateAvailable=function(){return window.global.browserSupportsLocalStorage()?localStorage["rate-tt"]?new Date>=new Date(localStorage["rate-tt"]):!0:!1}