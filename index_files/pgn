function StringBuilder(n){var t={};t.strings=[""];var i=function(n){n&&t.strings.push(n)},r=function(){t.strings.length=1},u=function(){return t.strings.reduce(function(n,t){return n+t.length},0)},f=function(){for(var n=0;n<t.strings.length;n++)if(t.strings[n].length>0)return!1;return!0},e=function(){return t.strings.length===0?null:t.strings[t.strings.length-1].slice(-1)},o=function(){return t.strings.join("")};return i(n),{append:i,clear:r,toString:o,length:u,isEmpty:f,lastChar:e}}var PEG=function(n){var t={define:function(n,i){function f(n){for(var i=u+n,r=/[^\/]+\/\.\.\/|\.\//;r.test(i);)i=i.replace(r,"");return t[i]}var u=n.replace(/(^|\/)[^/]+$/,"$1"),r={exports:{}};i(r,f);this[n]=r.exports}};return t.define("utils",function(t){var i={range:function(t,i){var u,f,r;for(i===n&&(i=t,t=0),u=new Array(Math.max(0,i-t)),f=0,r=t;r<i;f++,r++)u[f]=r;return u},find:function(n,t){for(var r=n.length,i=0;i<r;i++)if(t(n[i]))return n[i]},indexOf:function(n,t){for(var r=n.length,i=0;i<r;i++)if(t(n[i]))return i;return-1},contains:function(n,t){for(var r=n.length,i=0;i<r;i++)if(n[i]===t)return!0;return!1},each:function(n,t){for(var r=n.length,i=0;i<r;i++)t(n[i],i)},map:function(n,t){for(var r=[],u=n.length,i=0;i<u;i++)r[i]=t(n[i],i);return r},pluck:function(n,t){return i.map(n,function(n){return n[t]})},keys:function(n){var i=[],t;for(t in n)n.hasOwnProperty(t)&&i.push(t);return i},values:function(n){var i=[],t;for(t in n)n.hasOwnProperty(t)&&i.push(n[t]);return i},clone:function(n){var i={},t;for(t in n)n.hasOwnProperty(t)&&(i[t]=n[t]);return i},defaults:function(n,t){for(var i in t)t.hasOwnProperty(i)&&(i in n||(n[i]=t[i]))},subclass:function(n,t){function i(){this.constructor=n}i.prototype=t.prototype;n.prototype=new i},padLeft:function(n,t,i){for(var r=n,f=i-n.length,u=0;u<f;u++)r=t+r;return r},escape:function(n){var u=n.charCodeAt(0),t,r;return u<=255?(t="x",r=2):(t="u",r=4),"\\"+t+i.padLeft(u.toString(16).toUpperCase(),"0",r)},quote:function(n){return'"'+n.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,i.escape)+'"'},quoteForRegexpClass:function(n){return n.replace(/\\/g,"\\\\").replace(/\//g,"\\/").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\v/g,"\\x0B").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x01-\x08\x0E-\x1F\x80-\uFFFF]/g,i.escape)},buildNodeVisitor:function(n){return function(t){return n[t.type].apply(null,arguments)}},findRuleByName:function(n,t){return i.find(n.rules,function(n){return n.name===t})},indexOfRuleByName:function(n,t){return i.indexOf(n.rules,function(n){return n.name===t})}};t.exports=i}),t.define("grammar-error",function(n,t){var i=t("./utils");n.exports=function(n){this.name="GrammarError";this.message=n};i.subclass(n.exports,Error)}),t.define("parser",function(n,t){n.exports=function(){function i(n,t){function i(){this.constructor=n}i.prototype=t.prototype;n.prototype=new i}function n(n,t,i,r,u,f){this.message=n;this.expected=t;this.found=i;this.offset=r;this.line=u;this.column=f;this.name="SyntaxError"}function r(i){function yh(n){throw dt(n,null,s);}function kt(n){function t(n,t,r){for(var u,f=t;f<r;f++)u=i.charAt(f),u==="\n"?(n.seenCR||n.line++,n.column=1,n.seenCR=!1):u==="\r"||u==="\u2028"||u==="\u2029"?(n.line++,n.column=1,n.seenCR=!0):(n.column++,n.seenCR=!1)}return k!==n&&(k>n&&(k=0,wt={line:1,column:1,seenCR:!1}),t(wt,k,n),k=n),wt}function o(n){r<nt||(r>nt&&(nt=r,bt=[]),bt.push(n))}function dt(t,r,u){function o(n){var t=1;for(n.sort(function(n,t){return n.description<t.description?-1:n.description>t.description?1:0});t<n.length;)n[t-1]===n[t]?n.splice(t,1):t++}function s(n,t){function e(n){function t(n){return n.charCodeAt(0).toString(16).toUpperCase()}return n.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(n){return"\\x0"+t(n)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(n){return"\\x"+t(n)}).replace(/[\u0180-\u0FFF]/g,function(n){return"\\u0"+t(n)}).replace(/[\u1080-\uFFFF]/g,function(n){return"\\u"+t(n)})}for(var r=new Array(n.length),u,f,i=0;i<n.length;i++)r[i]=n[i].description;return u=n.length>1?r.slice(0,-1).join(", ")+" or "+r[n.length-1]:r[0],f=t?'"'+e(t)+'"':"end of input","Expected "+u+" but "+f+" found."}var f=kt(u),e=u<i.length?i.charAt(u):null;return r!==null&&o(r),new n(t!==null?t:s(r,e),r,e,u,f.line,f.column)}function ir(){var n,o,t,i,e;if(n=r,o=h(),o!==u)if(t=ph(),t===u&&(t=l),t!==u){if(i=[],e=rr(),e!==u)while(e!==u)i.push(e),e=rr();else i=f;i!==u?(s=n,o=nu(t,i),n=o):(r=n,n=f)}else r=n,n=f;else r=n,n=f;return n}function ph(){var n,t,i;return n=r,t=ft(),t!==u?(i=hr(),i===u&&(i=l),i!==u?(s=n,t=tu(t),n=t):(r=n,n=f)):(r=n,n=f),n}function rr(){var n,t,i,h,o,e;return n=r,t=ti(),t!==u?(i=vr(),i===u&&(i=l),i!==u?(h=sr(),h!==u?(o=ur(),o!==u?(e=hr(),e===u&&(e=l),e!==u?(s=n,t=iu(t,i,o),n=t):(r=n,n=f)):(r=n,n=f)):(r=n,n=f)):(r=n,n=f)):(r=n,n=f),n}function ur(){var i,o,h,n,t,e;if(i=r,o=gt(),o!==u){for(h=[],n=r,t=cr(),t!==u?(e=gt(),e!==u?(t=[t,e],n=t):(r=n,n=f)):(r=n,n=f);n!==u;)h.push(n),n=r,t=cr(),t!==u?(e=gt(),e!==u?(t=[t,e],n=t):(r=n,n=f)):(r=n,n=f);h!==u?(s=i,o=ru(o,h),i=o):(r=i,i=f)}else r=i,i=f;return i}function gt(){var n,t,i;for(n=r,t=[],i=it();i!==u;)t.push(i),i=it();if(t!==u?(i=ft(),i!==u?(s=n,t=uu(t,i),n=t):(r=n,n=f)):(r=n,n=f),n===u){for(n=r,t=[],i=it();i!==u;)t.push(i),i=it();t!==u&&(s=n,t=fu(t));n=t}return n}function it(){var n,t,e,i;return n=r,t=ti(),t!==u?(e=wh(),e!==u?(i=fr(),i!==u?(s=n,t=eu(t,i),n=t):(r=n,n=f)):(r=n,n=f)):(r=n,n=f),n===u&&(n=fr()),n}function fr(){var n,t,i;return n=r,t=bh(),t!==u?(i=rt(),i!==u?(s=n,t=ou(i),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=r,t=lr(),t!==u?(i=ft(),i!==u?(s=n,t=su(i),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=r,t=lr(),t!==u?(i=rt(),i!==u?(s=n,t=hu(i),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=r,t=ar(),t!==u?(i=ft(),i!==u?(s=n,t=cu(i),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=r,t=ar(),t!==u?(i=rt(),i!==u?(s=n,t=lu(i),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=rt()))))),n}function rt(){var n,t,i;return n=r,t=ut(),t!==u?(i=kh(),i!==u?(s=n,t=au(t),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=r,t=ut(),t!==u?(i=dh(),i!==u?(s=n,t=vu(t),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=r,t=ut(),t!==u?(i=gh(),i!==u?(s=n,t=yu(t),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=ut()))),n}function ut(){var n,t,o,i,h,a;return n=r,t=ti(),t!==u?(o=r,e++,i=r,h=vr(),h===u&&(h=l),h!==u?(a=sr(),a!==u?(h=[h,a],i=h):(r=i,i=f)):(r=i,i=f),e--,i===u?o=c:(r=o,o=f),o!==u?(s=n,t=pu(t),n=t):(r=n,n=f)):(r=n,n=f),n===u&&(n=rc(),n===u&&(n=ec(),n===u&&(n=r,t=ic(),t!==u&&(s=n,t=wu()),n=t,n===u&&(n=r,t=nc(),t!==u?(o=ur(),o!==u?(i=tc(),i!==u?(s=n,t=bu(o),n=t):(r=n,n=f)):(r=n,n=f)):(r=n,n=f))))),n}function ft(){var n,t,i;return e++,n=r,t=ni(),t!==u?(i=h(),i!==u?(s=n,t=du(t),n=t):(r=n,n=f)):(r=n,n=f),e--,n===u&&(t=u,e===0&&o(ku)),n}function ni(){var c,t,s,h,n;if(c=r,t=r,i.charCodeAt(r)===123?(s=gu,r++):(s=u,e===0&&o(nf)),s!==u){for(h=[],n=ni(),n===u&&(n=er());n!==u;)h.push(n),n=ni(),n===u&&(n=er());h!==u?(i.charCodeAt(r)===125?(n=tf,r++):(n=u,e===0&&o(rf)),n!==u?(s=[s,h,n],t=s):(r=t,t=f)):(r=t,t=f)}else r=t,t=f;return t!==u&&(t=i.substring(c,r)),t}function er(){var t,n;if(t=[],n=or(),n!==u)while(n!==u)t.push(n),n=or();else t=f;return t}function or(){var n;return uf.test(i.charAt(r))?(n=i.charAt(r),r++):(n=u,e===0&&o(ff)),n}function sr(){var n,t,c;return n=r,i.charCodeAt(r)===61?(t=ef,r++):(t=u,e===0&&o(of)),t!==u?(c=h(),c!==u?(s=n,t=sf(),n=t):(r=n,n=f)):(r=n,n=f),n}function wh(){var n,t,c;return n=r,i.charCodeAt(r)===58?(t=hf,r++):(t=u,e===0&&o(cf)),t!==u?(c=h(),c!==u?(s=n,t=lf(),n=t):(r=n,n=f)):(r=n,n=f),n}function hr(){var n,t,c;return n=r,i.charCodeAt(r)===59?(t=af,r++):(t=u,e===0&&o(vf)),t!==u?(c=h(),c!==u?(s=n,t=yf(),n=t):(r=n,n=f)):(r=n,n=f),n}function cr(){var n,t,c;return n=r,i.charCodeAt(r)===47?(t=pf,r++):(t=u,e===0&&o(wf)),t!==u?(c=h(),c!==u?(s=n,t=bf(),n=t):(r=n,n=f)):(r=n,n=f),n}function lr(){var n,t,c;return n=r,i.charCodeAt(r)===38?(t=kf,r++):(t=u,e===0&&o(df)),t!==u?(c=h(),c!==u?(s=n,t=gf(),n=t):(r=n,n=f)):(r=n,n=f),n}function ar(){var n,t,c;return n=r,i.charCodeAt(r)===33?(t=ne,r++):(t=u,e===0&&o(te)),t!==u?(c=h(),c!==u?(s=n,t=ie(),n=t):(r=n,n=f)):(r=n,n=f),n}function bh(){var n,t,c;return n=r,i.charCodeAt(r)===36?(t=re,r++):(t=u,e===0&&o(ue)),t!==u?(c=h(),c!==u?(s=n,t=fe(),n=t):(r=n,n=f)):(r=n,n=f),n}function kh(){var n,t,c;return n=r,i.charCodeAt(r)===63?(t=ee,r++):(t=u,e===0&&o(oe)),t!==u?(c=h(),c!==u?(s=n,t=se(),n=t):(r=n,n=f)):(r=n,n=f),n}function dh(){var n,t,c;return n=r,i.charCodeAt(r)===42?(t=he,r++):(t=u,e===0&&o(ce)),t!==u?(c=h(),c!==u?(s=n,t=le(),n=t):(r=n,n=f)):(r=n,n=f),n}function gh(){var n,t,c;return n=r,i.charCodeAt(r)===43?(t=ae,r++):(t=u,e===0&&o(ve)),t!==u?(c=h(),c!==u?(s=n,t=ye(),n=t):(r=n,n=f)):(r=n,n=f),n}function nc(){var n,t,c;return n=r,i.charCodeAt(r)===40?(t=pe,r++):(t=u,e===0&&o(we)),t!==u?(c=h(),c!==u?(s=n,t=be(),n=t):(r=n,n=f)):(r=n,n=f),n}function tc(){var n,t,c;return n=r,i.charCodeAt(r)===41?(t=ke,r++):(t=u,e===0&&o(de)),t!==u?(c=h(),c!==u?(s=n,t=ge(),n=t):(r=n,n=f)):(r=n,n=f),n}function ic(){var n,t,c;return n=r,i.charCodeAt(r)===46?(t=no,r++):(t=u,e===0&&o(to)),t!==u?(c=h(),c!==u?(s=n,t=io(),n=t):(r=n,n=f)):(r=n,n=f),n}function ti(){var c,l,t,a,v,n;if(e++,c=r,l=r,t=r,a=oi(),a===u&&(i.charCodeAt(r)===95?(a=st,r++):(a=u,e===0&&o(ht))),a!==u){for(v=[],n=oi(),n===u&&(n=ot(),n===u&&(i.charCodeAt(r)===95?(n=st,r++):(n=u,e===0&&o(ht))));n!==u;)v.push(n),n=oi(),n===u&&(n=ot(),n===u&&(i.charCodeAt(r)===95?(n=st,r++):(n=u,e===0&&o(ht))));v!==u?(a=[a,v],t=a):(r=t,t=f)}else r=t,t=f;return t!==u&&(t=i.substring(l,r)),l=t,l!==u?(t=h(),t!==u?(s=c,l=uo(l),c=l):(r=c,c=f)):(r=c,c=f),e--,c===u&&(l=u,e===0&&o(ro)),c}function rc(){var n,t,c,a;return e++,n=r,t=yr(),t===u&&(t=wr()),t!==u?(i.charCodeAt(r)===105?(c=li,r++):(c=u,e===0&&o(ai)),c===u&&(c=l),c!==u?(a=h(),a!==u?(s=n,t=eo(t,c),n=t):(r=n,n=f)):(r=n,n=f)):(r=n,n=f),e--,n===u&&(t=u,e===0&&o(fo)),n}function vr(){var n,t,i;return e++,n=r,t=yr(),t===u&&(t=wr()),t!==u?(i=h(),i!==u?(s=n,t=so(t),n=t):(r=n,n=f)):(r=n,n=f),e--,n===u&&(t=u,e===0&&o(oo)),n}function yr(){var n,h,c,t;if(n=r,i.charCodeAt(r)===34?(h=ct,r++):(h=u,e===0&&o(lt)),h!==u){for(c=[],t=pr();t!==u;)c.push(t),t=pr();c!==u?(i.charCodeAt(r)===34?(t=ct,r++):(t=u,e===0&&o(lt)),t!==u?(s=n,h=vi(c),n=h):(r=n,n=f)):(r=n,n=f)}else r=n,n=f;return n}function pr(){var n;return n=uc(),n===u&&(n=ii(),n===u&&(n=ri(),n===u&&(n=ui(),n===u&&(n=fi(),n===u&&(n=ei()))))),n}function uc(){var t,h,n;return t=r,h=r,e++,i.charCodeAt(r)===34?(n=ct,r++):(n=u,e===0&&o(lt)),n===u&&(i.charCodeAt(r)===92?(n=w,r++):(n=u,e===0&&o(b)),n===u&&(n=p())),e--,n===u?h=c:(r=h,h=f),h!==u?(i.length>r?(n=i.charAt(r),r++):(n=u,e===0&&o(a)),n!==u?(s=t,h=at(n),t=h):(r=t,t=f)):(r=t,t=f),t}function wr(){var n,h,c,t;if(n=r,i.charCodeAt(r)===39?(h=vt,r++):(h=u,e===0&&o(yt)),h!==u){for(c=[],t=br();t!==u;)c.push(t),t=br();c!==u?(i.charCodeAt(r)===39?(t=vt,r++):(t=u,e===0&&o(yt)),t!==u?(s=n,h=vi(c),n=h):(r=n,n=f)):(r=n,n=f)}else r=n,n=f;return n}function br(){var n;return n=fc(),n===u&&(n=ii(),n===u&&(n=ri(),n===u&&(n=ui(),n===u&&(n=fi(),n===u&&(n=ei()))))),n}function fc(){var t,h,n;return t=r,h=r,e++,i.charCodeAt(r)===39?(n=vt,r++):(n=u,e===0&&o(yt)),n===u&&(i.charCodeAt(r)===92?(n=w,r++):(n=u,e===0&&o(b)),n===u&&(n=p())),e--,n===u?h=c:(r=h,h=f),h!==u?(i.length>r?(n=i.charAt(r),r++):(n=u,e===0&&o(a)),n!==u?(s=t,h=at(n),t=h):(r=t,t=f)):(r=t,t=f),t}function ec(){var n,c,a,y,t,v,p;if(e++,n=r,i.charCodeAt(r)===91?(c=co,r++):(c=u,e===0&&o(lo)),c!==u)if(i.charCodeAt(r)===94?(a=ao,r++):(a=u,e===0&&o(vo)),a===u&&(a=l),a!==u){for(y=[],t=kr(),t===u&&(t=et());t!==u;)y.push(t),t=kr(),t===u&&(t=et());y!==u?(i.charCodeAt(r)===93?(t=yi,r++):(t=u,e===0&&o(pi)),t!==u?(i.charCodeAt(r)===105?(v=li,r++):(v=u,e===0&&o(ai)),v===u&&(v=l),v!==u?(p=h(),p!==u?(s=n,c=yo(a,y,v),n=c):(r=n,n=f)):(r=n,n=f)):(r=n,n=f)):(r=n,n=f)}else r=n,n=f;else r=n,n=f;return e--,n===u&&(c=u,e===0&&o(ho)),n}function kr(){var n,t,h,c;return n=r,t=et(),t!==u?(i.charCodeAt(r)===45?(h=po,r++):(h=u,e===0&&o(wo)),h!==u?(c=et(),c!==u?(s=n,t=bo(t,c),n=t):(r=n,n=f)):(r=n,n=f)):(r=n,n=f),n}function et(){var t,n;return t=r,n=oc(),n!==u&&(s=t,n=ko(n)),n}function oc(){var n;return n=sc(),n===u&&(n=ii(),n===u&&(n=ri(),n===u&&(n=ui(),n===u&&(n=fi(),n===u&&(n=ei()))))),n}function sc(){var t,h,n;return t=r,h=r,e++,i.charCodeAt(r)===93?(n=yi,r++):(n=u,e===0&&o(pi)),n===u&&(i.charCodeAt(r)===92?(n=w,r++):(n=u,e===0&&o(b)),n===u&&(n=p())),e--,n===u?h=c:(r=h,h=f),h!==u?(i.length>r?(n=i.charAt(r),r++):(n=u,e===0&&o(a)),n!==u?(s=t,h=at(n),t=h):(r=t,t=f)):(r=t,t=f),t}function ii(){var t,h,l,n;return t=r,i.charCodeAt(r)===92?(h=w,r++):(h=u,e===0&&o(b)),h!==u?(l=r,e++,n=ot(),n===u&&(i.charCodeAt(r)===120?(n=go,r++):(n=u,e===0&&o(ns)),n===u&&(i.charCodeAt(r)===117?(n=ts,r++):(n=u,e===0&&o(is)),n===u&&(n=p()))),e--,n===u?l=c:(r=l,l=f),l!==u?(i.length>r?(n=i.charAt(r),r++):(n=u,e===0&&o(a)),n!==u?(s=t,h=rs(n),t=h):(r=t,t=f)):(r=t,t=f)):(r=t,t=f),t}function ri(){var n,t,h,l;return n=r,i.substr(r,2)===wi?(t=wi,r+=2):(t=u,e===0&&o(us)),t!==u?(h=r,e++,l=ot(),e--,l===u?h=c:(r=h,h=f),h!==u?(s=n,t=fs(),n=t):(r=n,n=f)):(r=n,n=f),n}function ui(){var t,h,c,n,l,a;return t=r,i.substr(r,2)===bi?(h=bi,r+=2):(h=u,e===0&&o(es)),h!==u?(c=r,n=r,l=y(),l!==u?(a=y(),a!==u?(l=[l,a],n=l):(r=n,n=f)):(r=n,n=f),n!==u&&(n=i.substring(c,r)),c=n,c!==u?(s=t,h=ki(c),t=h):(r=t,t=f)):(r=t,t=f),t}function fi(){var t,h,c,n,l,a,v,p;return t=r,i.substr(r,2)===di?(h=di,r+=2):(h=u,e===0&&o(os)),h!==u?(c=r,n=r,l=y(),l!==u?(a=y(),a!==u?(v=y(),v!==u?(p=y(),p!==u?(l=[l,a,v,p],n=l):(r=n,n=f)):(r=n,n=f)):(r=n,n=f)):(r=n,n=f),n!==u&&(n=i.substring(c,r)),c=n,c!==u?(s=t,h=ki(c),t=h):(r=t,t=f)):(r=t,t=f),t}function ei(){var n,t,h;return n=r,i.charCodeAt(r)===92?(t=w,r++):(t=u,e===0&&o(b)),t!==u?(h=si(),h!==u?(s=n,t=ss(h),n=t):(r=n,n=f)):(r=n,n=f),n}function ot(){var n;return hs.test(i.charAt(r))?(n=i.charAt(r),r++):(n=u,e===0&&o(cs)),n}function y(){var n;return ls.test(i.charAt(r))?(n=i.charAt(r),r++):(n=u,e===0&&o(as)),n}function oi(){var n;return n=hc(),n===u&&(n=cc()),n}function hc(){var n;return vs.test(i.charAt(r))?(n=i.charAt(r),r++):(n=u,e===0&&o(ys)),n}function cc(){var n;return ps.test(i.charAt(r))?(n=i.charAt(r),r++):(n=u,e===0&&o(ws)),n}function h(){var t,n;for(t=[],n=gr(),n===u&&(n=si(),n===u&&(n=dr()));n!==u;)t.push(n),n=gr(),n===u&&(n=si(),n===u&&(n=dr()));return t}function dr(){var n,t;return e++,n=lc(),n===u&&(n=ac()),e--,n===u&&(t=u,e===0&&o(bs)),n}function lc(){var h,l,v,t,n,s;if(h=r,i.substr(r,2)===gi?(l=gi,r+=2):(l=u,e===0&&o(ks)),l!==u){for(v=[],t=r,n=r,e++,s=p(),e--,s===u?n=c:(r=n,n=f),n!==u?(i.length>r?(s=i.charAt(r),r++):(s=u,e===0&&o(a)),s!==u?(n=[n,s],t=n):(r=t,t=f)):(r=t,t=f);t!==u;)v.push(t),t=r,n=r,e++,s=p(),e--,s===u?n=c:(r=n,n=f),n!==u?(i.length>r?(s=i.charAt(r),r++):(s=u,e===0&&o(a)),s!==u?(n=[n,s],t=n):(r=t,t=f)):(r=t,t=f);v!==u?(l=[l,v],h=l):(r=h,h=f)}else r=h,h=f;return h}function ac(){var h,l,y,n,t,s;if(h=r,i.substr(r,2)===nr?(l=nr,r+=2):(l=u,e===0&&o(ds)),l!==u){for(y=[],n=r,t=r,e++,i.substr(r,2)===v?(s=v,r+=2):(s=u,e===0&&o(pt)),e--,s===u?t=c:(r=t,t=f),t!==u?(i.length>r?(s=i.charAt(r),r++):(s=u,e===0&&o(a)),s!==u?(t=[t,s],n=t):(r=n,n=f)):(r=n,n=f);n!==u;)y.push(n),n=r,t=r,e++,i.substr(r,2)===v?(s=v,r+=2):(s=u,e===0&&o(pt)),e--,s===u?t=c:(r=t,t=f),t!==u?(i.length>r?(s=i.charAt(r),r++):(s=u,e===0&&o(a)),s!==u?(t=[t,s],n=t):(r=n,n=f)):(r=n,n=f);y!==u?(i.substr(r,2)===v?(n=v,r+=2):(n=u,e===0&&o(pt)),n!==u?(l=[l,y,n],h=l):(r=h,h=f)):(r=h,h=f)}else r=h,h=f;return h}function si(){var n,t;return e++,i.charCodeAt(r)===10?(n=nh,r++):(n=u,e===0&&o(th)),n===u&&(i.substr(r,2)===tr?(n=tr,r+=2):(n=u,e===0&&o(ih)),n===u&&(i.charCodeAt(r)===13?(n=rh,r++):(n=u,e===0&&o(uh)),n===u&&(i.charCodeAt(r)===8232?(n=fh,r++):(n=u,e===0&&o(eh)),n===u&&(i.charCodeAt(r)===8233?(n=oh,r++):(n=u,e===0&&o(sh)))))),e--,n===u&&(t=u,e===0&&o(gs)),n}function p(){var n;return hh.test(i.charAt(r))?(n=i.charAt(r),r++):(n=u,e===0&&o(ch)),n}function gr(){var n,t;return e++,ah.test(i.charAt(r))?(n=i.charAt(r),r++):(n=u,e===0&&o(vh)),e--,n===u&&(t=u,e===0&&o(lh)),n}var g=arguments.length>1?arguments[1]:{},u={},hi={grammar:ir},ci=ir,f=u,l=null,nu=function(n,t){return{type:"grammar",initializer:n,rules:t}},tu=function(n){return{type:"initializer",code:n}},iu=function(n,t,i){return{type:"rule",name:n,expression:t!==null?{type:"named",name:t,expression:i}:i}},ru=function(n,t){if(t.length>0){var i=[n].concat(d.map(t,function(n){return n[1]}));return{type:"choice",alternatives:i}}return n},uu=function(n,t){var i=n.length!==1?{type:"sequence",elements:n}:n[0];return{type:"action",expression:i,code:t}},fu=function(n){return n.length!==1?{type:"sequence",elements:n}:n[0]},eu=function(n,t){return{type:"labeled",label:n,expression:t}},ou=function(n){return{type:"text",expression:n}},su=function(n){return{type:"semantic_and",code:n}},hu=function(n){return{type:"simple_and",expression:n}},cu=function(n){return{type:"semantic_not",code:n}},lu=function(n){return{type:"simple_not",expression:n}},au=function(n){return{type:"optional",expression:n}},vu=function(n){return{type:"zero_or_more",expression:n}},yu=function(n){return{type:"one_or_more",expression:n}},c=void 0,pu=function(n){return{type:"rule_ref",name:n}},wu=function(){return{type:"any"}},bu=function(n){return n},ku={type:"other",description:"action"},du=function(n){return n.substr(1,n.length-2)},gu="{",nf={type:"literal",value:"{",description:'"{"'},tf="}",rf={type:"literal",value:"}",description:'"}"'},uf=/^[^{}]/,ff={type:"class",value:"[^{}]",description:"[^{}]"},ef="=",of={type:"literal",value:"=",description:'"="'},sf=function(){return"="},hf=":",cf={type:"literal",value:":",description:'":"'},lf=function(){return":"},af=";",vf={type:"literal",value:";",description:'";"'},yf=function(){return";"},pf="/",wf={type:"literal",value:"/",description:'"/"'},bf=function(){return"/"},kf="&",df={type:"literal",value:"&",description:'"&"'},gf=function(){return"&"},ne="!",te={type:"literal",value:"!",description:'"!"'},ie=function(){return"!"},re="$",ue={type:"literal",value:"$",description:'"$"'},fe=function(){return"$"},ee="?",oe={type:"literal",value:"?",description:'"?"'},se=function(){return"?"},he="*",ce={type:"literal",value:"*",description:'"*"'},le=function(){return"*"},ae="+",ve={type:"literal",value:"+",description:'"+"'},ye=function(){return"+"},pe="(",we={type:"literal",value:"(",description:'"("'},be=function(){return"("},ke=")",de={type:"literal",value:")",description:'")"'},ge=function(){return")"},no=".",to={type:"literal",value:".",description:'"."'},io=function(){return"."},ro={type:"other",description:"identifier"},st="_",ht={type:"literal",value:"_",description:'"_"'},uo=function(n){return n},fo={type:"other",description:"literal"},li="i",ai={type:"literal",value:"i",description:'"i"'},eo=function(n,t){return{type:"literal",value:n,ignoreCase:t==="i"}},oo={type:"other",description:"string"},so=function(n){return n},ct='"',lt={type:"literal",value:'"',description:'"\\""'},vi=function(n){return n.join("")},w="\\",b={type:"literal",value:"\\",description:'"\\\\"'},a={type:"any",description:"any character"},at=function(n){return n},vt="'",yt={type:"literal",value:"'",description:'"\'"'},ho={type:"other",description:"character class"},co="[",lo={type:"literal",value:"[",description:'"["'},ao="^",vo={type:"literal",value:"^",description:'"^"'},yi="]",pi={type:"literal",value:"]",description:'"]"'},yo=function(n,t,i){var r=d.map(t,function(n){return n.data}),u="["+(n!==null?n:"")+d.map(t,function(n){return n.rawText}).join("")+"]"+(i!==null?i:"");return{type:"class",parts:r,rawText:u,inverted:n==="^",ignoreCase:i==="i"}},po="-",wo={type:"literal",value:"-",description:'"-"'},bo=function(n,t){return n.data.charCodeAt(0)>t.data.charCodeAt(0)&&yh("Invalid character range: "+n.rawText+"-"+t.rawText+"."),{data:[n.data,t.data],rawText:n.rawText+"-"+t.rawText}},ko=function(n){return{data:n,rawText:d.quoteForRegexpClass(n)}},go="x",ns={type:"literal",value:"x",description:'"x"'},ts="u",is={type:"literal",value:"u",description:'"u"'},rs=function(n){return n.replace("b","\b").replace("f","\f").replace("n","\n").replace("r","\r").replace("t","\t").replace("v","\x0b")},wi="\\0",us={type:"literal",value:"\\0",description:'"\\\\0"'},fs=function(){return"\x00"},bi="\\x",es={type:"literal",value:"\\x",description:'"\\\\x"'},ki=function(n){return String.fromCharCode(parseInt(n,16))},di="\\u",os={type:"literal",value:"\\u",description:'"\\\\u"'},ss=function(n){return n},hs=/^[0-9]/,cs={type:"class",value:"[0-9]",description:"[0-9]"},ls=/^[0-9a-fA-F]/,as={type:"class",value:"[0-9a-fA-F]",description:"[0-9a-fA-F]"},vs=/^[a-z]/,ys={type:"class",value:"[a-z]",description:"[a-z]"},ps=/^[A-Z]/,ws={type:"class",value:"[A-Z]",description:"[A-Z]"},bs={type:"other",description:"comment"},gi="//",ks={type:"literal",value:"//",description:'"//"'},nr="/*",ds={type:"literal",value:"/*",description:'"/*"'},v="*/",pt={type:"literal",value:"*/",description:'"*/"'},gs={type:"other",description:"end of line"},nh="\n",th={type:"literal",value:"\n",description:'"\\n"'},tr="\r\n",ih={type:"literal",value:"\r\n",description:'"\\r\\n"'},rh="\r",uh={type:"literal",value:"\r",description:'"\\r"'},fh="\u2028",eh={type:"literal",value:"\u2028",description:'"\\u2028"'},oh="\u2029",sh={type:"literal",value:"\u2029",description:'"\\u2029"'},hh=/^[\n\r\u2028\u2029]/,ch={type:"class",value:"[\\n\\r\\u2028\\u2029]",description:"[\\n\\r\\u2028\\u2029]"},lh={type:"other",description:"whitespace"},ah=/^[ \t\x0B\f\xA0\uFEFF\u1680\u180E\u2000-\u200A\u202F\u205F\u3000]/,vh={type:"class",value:"[ \\t\\x0B\\f\\xA0\\uFEFF\\u1680\\u180E\\u2000-\\u200A\\u202F\\u205F\\u3000]",description:"[ \\t\\x0B\\f\\xA0\\uFEFF\\u1680\\u180E\\u2000-\\u200A\\u202F\\u205F\\u3000]"},r=0,s=0,k=0,wt={line:1,column:1,seenCR:!1},nt=0,bt=[],e=0,tt,d;if("startRule"in g){if(!(g.startRule in hi))throw new Error("Can't start parsing from rule \""+g.startRule+'".');ci=hi[g.startRule]}if(d=t("./utils"),tt=ci(),tt!==u&&r===i.length)return tt;tt!==u&&r<i.length&&o({type:"end",description:"end of input"});throw dt(null,bt,nt);}return i(n,Error),{SyntaxError:n,parse:r}}()}),t.define("compiler/opcodes",function(n){n.exports={PUSH:0,PUSH_CURR_POS:1,POP:2,POP_CURR_POS:3,POP_N:4,NIP:5,APPEND:6,WRAP:7,TEXT:8,IF:9,IF_ERROR:10,IF_NOT_ERROR:11,WHILE_NOT_ERROR:12,MATCH_ANY:13,MATCH_STRING:14,MATCH_STRING_IC:15,MATCH_REGEXP:16,ACCEPT_N:17,ACCEPT_STRING:18,FAIL:19,REPORT_SAVED_POS:20,REPORT_CURR_POS:21,CALL:22,RULE:23,SILENT_FAILS_ON:24,SILENT_FAILS_OFF:25}}),t.define("compiler/passes/generate-bytecode",function(n,t){var r=t("../../utils"),i=t("../opcodes");n.exports=function(n){function u(n){var t=r.indexOf(o,function(t){return t===n});return t===-1?o.push(n)-1:t}function s(n,t){return u("function("+n.join(", ")+") {"+t+"}")}function t(){return Array.prototype.concat.apply([],arguments)}function e(n,t,i){return n.concat([t.length,i.length],t,i)}function v(n,t){return n.concat([t.length],t)}function h(n,t,u,f){var e=r.map(r.values(u),function(n){return f-n});return[i.CALL,n,t,e.length].concat(e)}function c(n,r,o){var s=u("void 0"),h=u("peg$FAILED");return t([i.PUSH_CURR_POS],[i.SILENT_FAILS_ON],f(n,{sp:o.sp+1,env:{},action:null}),[i.SILENT_FAILS_OFF],e([r?i.IF_ERROR:i.IF_NOT_ERROR],t([i.POP],[r?i.POP:i.POP_CURR_POS],[i.PUSH,s]),t([i.POP],[r?i.POP_CURR_POS:i.POP],[i.PUSH,h])))}function l(n,f,o){var a=s(r.keys(o.env),n),c=u("void 0"),l=u("peg$FAILED");return t([i.REPORT_CURR_POS],h(a,0,o.env,o.sp),e([i.IF],t([i.POP],[i.PUSH,f?l:c]),t([i.POP],[i.PUSH,f?c:l])))}function a(n){return v([i.WHILE_NOT_ERROR],t([i.APPEND],n))}var o=[],f=r.buildNodeVisitor({grammar:function(n){r.each(n.rules,f);n.consts=o},rule:function(n){n.bytecode=f(n.expression,{sp:-1,env:{},action:null})},named:function(n,o){var s=u('{ type: "other", description: '+r.quote(n.name)+" }");return t([i.SILENT_FAILS_ON],f(n.expression,o),[i.SILENT_FAILS_OFF],e([i.IF_ERROR],[i.FAIL,s],[]))},choice:function(n,r){function u(n,r){return t(f(n[0],{sp:r.sp,env:{},action:null}),n.length>1?e([i.IF_ERROR],t([i.POP],u(n.slice(1),r)),[]):[])}return u(n.alternatives,r)},action:function(n,u){var o={},c=n.expression.type!=="sequence"||n.expression.elements.length===0,l=f(n.expression,{sp:u.sp+(c?1:0),env:o,action:n}),a=s(r.keys(o),n.code);return c?t([i.PUSH_CURR_POS],l,e([i.IF_NOT_ERROR],t([i.REPORT_SAVED_POS,1],h(a,1,o,u.sp+2)),[]),[i.NIP]):l},sequence:function(n,o){function l(u,o){var c,a;return u.length>0?(c=n.elements.length-u.slice(1).length,t(f(u[0],{sp:o.sp,env:o.env,action:null}),e([i.IF_NOT_ERROR],l(u.slice(1),{sp:o.sp+1,env:o.env,action:o.action}),t(c>1?[i.POP_N,c]:[i.POP],[i.POP_CURR_POS],[i.PUSH,failedIndex])))):o.action?(a=s(r.keys(o.env),o.action.code),t([i.REPORT_SAVED_POS,n.elements.length],h(a,n.elements.length,o.env,o.sp),[i.NIP])):t([i.WRAP,n.elements.length],[i.NIP])}var c;return n.elements.length>0?(failedIndex=u("peg$FAILED"),t([i.PUSH_CURR_POS],l(n.elements,{sp:o.sp+1,env:o.env,action:o.action}))):(c=u("[]"),[i.PUSH,c])},labeled:function(n,t){return t.env[n.label]=t.sp+1,f(n.expression,{sp:t.sp,env:{},action:null})},text:function(n,r){return t([i.PUSH_CURR_POS],f(n.expression,{sp:r.sp+1,env:{},action:null}),e([i.IF_NOT_ERROR],[i.TEXT],[]),[i.NIP])},simple_and:function(n,t){return c(n.expression,!1,t)},simple_not:function(n,t){return c(n.expression,!0,t)},semantic_and:function(n,t){return l(n.code,!1,t)},semantic_not:function(n,t){return l(n.code,!0,t)},optional:function(n,r){var o=u("null");return t(f(n.expression,{sp:r.sp,env:{},action:null}),e([i.IF_ERROR],t([i.POP],[i.PUSH,o]),[]))},zero_or_more:function(n,r){var e=u("[]");return expressionCode=f(n.expression,{sp:r.sp+1,env:{},action:null}),t([i.PUSH,e],expressionCode,a(expressionCode),[i.POP])},one_or_more:function(n,r){var o=u("[]");return failedIndex=u("peg$FAILED"),expressionCode=f(n.expression,{sp:r.sp+1,env:{},action:null}),t([i.PUSH,o],expressionCode,e([i.IF_NOT_ERROR],t(a(expressionCode),[i.POP]),t([i.POP],[i.POP],[i.PUSH,failedIndex])))},rule_ref:function(t){return[i.RULE,r.indexOfRuleByName(n,t.name)]},literal:function(n){var t,f;return n.value.length>0?(t=u(n.ignoreCase?r.quote(n.value.toLowerCase()):r.quote(n.value)),f=u(["{",'type: "literal",',"value: "+r.quote(n.value)+",","description: "+r.quote(r.quote(n.value)),"}"].join(" ")),e(n.ignoreCase?[i.MATCH_STRING_IC,t]:[i.MATCH_STRING,t],n.ignoreCase?[i.ACCEPT_N,n.value.length]:[i.ACCEPT_STRING,t],[i.FAIL,f])):(t=u('""'),[i.PUSH,t])},"class":function(n){var t,f,o;return t=n.parts.length>0?"/^["+(n.inverted?"^":"")+r.map(n.parts,function(n){return n instanceof Array?r.quoteForRegexpClass(n[0])+"-"+r.quoteForRegexpClass(n[1]):r.quoteForRegexpClass(n)}).join("")+"]/"+(n.ignoreCase?"i":""):n.inverted?"/^[\\S\\s]/":"/^(?!)/",f=u(t),o=u(["{",'type: "class",',"value: "+r.quote(n.rawText)+",","description: "+r.quote(n.rawText),"}"].join(" ")),e([i.MATCH_REGEXP,f],[i.ACCEPT_N,1],[i.FAIL,o])},any:function(){var n=u('{ type: "any", description: "any character" }');return e([i.MATCH_ANY],[i.ACCEPT_N,1],[i.FAIL,n])}});f(n)}}),t.define("compiler/passes/generate-javascript",function(n,t){var r=t("../../utils"),i=t("../opcodes");n.exports=function(n,t){function f(n){return n.replace(/^(.+)$/gm,"  $1")}function o(n){return n.replace(/^(.+)$/gm,"    $1")}function y(n){return n.replace(/^(.+)$/gm,"        $1")}function e(n){return n.replace(/^(.+)$/gm,"          $1")}function p(){return t.optimize==="size"?["peg$consts = [",f(n.consts.join(",\n")),"],","","peg$bytecode = [",f(r.map(n.rules,function(n){return"peg$decode("+r.quote(r.map(n.bytecode,function(n){return String.fromCharCode(n+32)}).join(""))+")"}).join(",\n")),"],"].join("\n"):r.map(n.consts,function(n,t){return"peg$c"+t+" = "+n+","}).join("\n")}function s(t){return["var key    = peg$currPos * "+n.rules.length+" + "+t+",","    cached = peg$cache[key];","","if (cached) {","  peg$currPos = cached.nextPos;","  return cached.result;","}",""].join("\n")}function h(n){return["","peg$cache[key] = { nextPos: peg$currPos, result: "+n+" };"].join("\n")}function w(){function n(n,t){var i=t+3,r="bc[ip + "+(i-2)+"]",u="bc[ip + "+(i-1)+"]";return["ends.push(end);","ips.push(ip + "+i+" + "+r+" + "+u+");","","if ("+n+") {","  end = ip + "+i+" + "+r+";","  ip += "+i+";","} else {","  end = ip + "+i+" + "+r+" + "+u+";","  ip += "+i+" + "+r+";","}","","break;"].join("\n")}function u(n){var t=2,i="bc[ip + "+(t-1)+"]";return["if ("+n+") {","  ends.push(end);","  ips.push(ip);","","  end = ip + "+t+" + "+i+";","  ip += "+t+";","} else {","  ip += "+t+" + "+i+";","}","","break;"].join("\n")}function o(){var n=4,t="bc[ip + "+(n-1)+"]";return["params = bc.slice(ip + "+n+", ip + "+n+" + "+t+");","for (i = 0; i < "+t+"; i++) {","  params[i] = stack[stack.length - 1 - params[i]];","}","","stack.splice(","  stack.length - bc[ip + 2],","  bc[ip + 2],","  peg$consts[bc[ip + 1]].apply(null, params)",");","","ip += "+n+" + "+t+";","break;"].join("\n")}var r=[];return r.push("function peg$decode(s) {\n  var bc = new Array(s.length), i;\n\n  for (i = 0; i < s.length; i++) {\n    bc[i] = s.charCodeAt(i) - 32;\n  }\n\n  return bc;\n}\n\nfunction peg$parseRule(index) {\n  var bc    = peg$bytecode[index],\n      ip    = 0,\n      ips   = [],\n      end   = bc.length,\n      ends  = [],\n      stack = [],\n      params, i;\n"),t.cache&&r.push(f(s("index"))),r.push(["  function protect(object) {",'    return Object.prototype.toString.apply(object) === "[object Array]" ? [] : object;',"  }","","  while (true) {","    while (ip < end) {","      switch (bc[ip]) {","        case "+i.PUSH+":","          stack.push(protect(peg$consts[bc[ip + 1]]));","          ip += 2;","          break;","","        case "+i.PUSH_CURR_POS+":","          stack.push(peg$currPos);","          ip++;","          break;","","        case "+i.POP+":","          stack.pop();","          ip++;","          break;","","        case "+i.POP_CURR_POS+":","          peg$currPos = stack.pop();","          ip++;","          break;","","        case "+i.POP_N+":","          stack.length -= bc[ip + 1];","          ip += 2;","          break;","","        case "+i.NIP+":","          stack.splice(-2, 1);","          ip++;","          break;","","        case "+i.APPEND+":","          stack[stack.length - 2].push(stack.pop());","          ip++;","          break;","","        case "+i.WRAP+":","          stack.push(stack.splice(stack.length - bc[ip + 1], bc[ip + 1]));","          ip += 2;","          break;","","        case "+i.TEXT+":","          stack.pop();","          stack.push(input.substring(stack[stack.length - 1], peg$currPos));","          ip++;","          break;","","        case "+i.IF+":",e(n("stack[stack.length - 1]",0)),"","        case "+i.IF_ERROR+":",e(n("stack[stack.length - 1] === peg$FAILED",0)),"","        case "+i.IF_NOT_ERROR+":",e(n("stack[stack.length - 1] !== peg$FAILED",0)),"","        case "+i.WHILE_NOT_ERROR+":",e(u("stack[stack.length - 1] !== peg$FAILED")),"","        case "+i.MATCH_ANY+":",e(n("input.length > peg$currPos",0)),"","        case "+i.MATCH_STRING+":",e(n("input.substr(peg$currPos, peg$consts[bc[ip + 1]].length) === peg$consts[bc[ip + 1]]",1)),"","        case "+i.MATCH_STRING_IC+":",e(n("input.substr(peg$currPos, peg$consts[bc[ip + 1]].length).toLowerCase() === peg$consts[bc[ip + 1]]",1)),"","        case "+i.MATCH_REGEXP+":",e(n("peg$consts[bc[ip + 1]].test(input.charAt(peg$currPos))",1)),"","        case "+i.ACCEPT_N+":","          stack.push(input.substr(peg$currPos, bc[ip + 1]));","          peg$currPos += bc[ip + 1];","          ip += 2;","          break;","","        case "+i.ACCEPT_STRING+":","          stack.push(peg$consts[bc[ip + 1]]);","          peg$currPos += peg$consts[bc[ip + 1]].length;","          ip += 2;","          break;","","        case "+i.FAIL+":","          stack.push(peg$FAILED);","          if (peg$silentFails === 0) {","            peg$fail(peg$consts[bc[ip + 1]]);","          }","          ip += 2;","          break;","","        case "+i.REPORT_SAVED_POS+":","          peg$reportedPos = stack[stack.length - 1 - bc[ip + 1]];","          ip += 2;","          break;","","        case "+i.REPORT_CURR_POS+":","          peg$reportedPos = peg$currPos;","          ip++;","          break;","","        case "+i.CALL+":",e(o()),"","        case "+i.RULE+":","          stack.push(peg$parseRule(bc[ip + 1]));","          ip += 2;","          break;","","        case "+i.SILENT_FAILS_ON+":","          peg$silentFails++;","          ip++;","          break;","","        case "+i.SILENT_FAILS_OFF+":","          peg$silentFails--;","          ip++;","          break;","","        default:",'          throw new Error("Invalid opcode: " + bc[ip] + ".");',"      }","    }","","    if (ends.length > 0) {","      end = ends.pop();","      ip = ips.pop();","    } else {","      break;","    }","  }"].join("\n")),t.cache&&r.push(f(h("stack[0]"))),r.push("\n  return stack[0];\n}"),r.join("\n")}function b(u){function c(n){return"peg$c"+n}function o(n){return"s"+n}function a(bc){function compileCondition(n,t){var r=t+3,u=bc[ip+r-2],i=bc[ip+r-1],l=e.sp,o,s,h,c;if(ip+=r,o=a(bc.slice(ip,ip+u)),h=e.sp,ip+=u,i>0&&(e.sp=l,s=a(bc.slice(ip,ip+i)),c=e.sp,ip+=i,h!==c))throw new Error("Branches of a condition must move the stack pointer in the same way.");parts.push("if ("+n+") {");parts.push(f(o));i>0&&(parts.push("} else {"),parts.push(f(s)));parts.push("}")}function compileLoop(n){var t=2,i=bc[ip+t-1],o=e.sp,r,u;if(ip+=t,r=a(bc.slice(ip,ip+i)),u=e.sp,ip+=i,u!==o)throw new Error("Body of a loop can't move the stack pointer.");parts.push("while ("+n+") {");parts.push(f(r));parts.push("}")}function compileCall(){var n=4,t=bc[ip+n-1],i=c(bc[ip+1])+"("+r.map(bc.slice(ip+n,ip+n+t),stackIndex).join(", ")+")";e.pop(bc[ip+2]);parts.push(e.push(i));ip+=n+t}function stackIndex(n){return e.index(n)}for(var ip=0,end=bc.length,parts=[],value;ip<end;)switch(bc[ip]){case i.PUSH:parts.push(e.push(n.consts[bc[ip+1]]==="[]"?"[]":c(bc[ip+1])));ip+=2;break;case i.PUSH_CURR_POS:parts.push(e.push("peg$currPos"));ip++;break;case i.POP:e.pop();ip++;break;case i.POP_CURR_POS:parts.push("peg$currPos = "+e.pop()+";");ip++;break;case i.POP_N:e.pop(bc[ip+1]);ip+=2;break;case i.NIP:value=e.pop();e.pop();parts.push(e.push(value));ip++;break;case i.APPEND:value=e.pop();parts.push(e.top()+".push("+value+");");ip++;break;case i.WRAP:parts.push(e.push("["+e.pop(bc[ip+1]).join(", ")+"]"));ip+=2;break;case i.TEXT:e.pop();parts.push(e.push("input.substring("+e.top()+", peg$currPos)"));ip++;break;case i.IF:compileCondition(e.top(),0);break;case i.IF_ERROR:compileCondition(e.top()+" === peg$FAILED",0);break;case i.IF_NOT_ERROR:compileCondition(e.top()+" !== peg$FAILED",0);break;case i.WHILE_NOT_ERROR:compileLoop(e.top()+" !== peg$FAILED",0);break;case i.MATCH_ANY:compileCondition("input.length > peg$currPos",0);break;case i.MATCH_STRING:compileCondition(eval(n.consts[bc[ip+1]]).length>1?"input.substr(peg$currPos, "+eval(n.consts[bc[ip+1]]).length+") === "+c(bc[ip+1]):"input.charCodeAt(peg$currPos) === "+eval(n.consts[bc[ip+1]]).charCodeAt(0),1);break;case i.MATCH_STRING_IC:compileCondition("input.substr(peg$currPos, "+eval(n.consts[bc[ip+1]]).length+").toLowerCase() === "+c(bc[ip+1]),1);break;case i.MATCH_REGEXP:compileCondition(c(bc[ip+1])+".test(input.charAt(peg$currPos))",1);break;case i.ACCEPT_N:parts.push(e.push(bc[ip+1]>1?"input.substr(peg$currPos, "+bc[ip+1]+")":"input.charAt(peg$currPos)"));parts.push(bc[ip+1]>1?"peg$currPos += "+bc[ip+1]+";":"peg$currPos++;");ip+=2;break;case i.ACCEPT_STRING:parts.push(e.push(c(bc[ip+1])));parts.push(eval(n.consts[bc[ip+1]]).length>1?"peg$currPos += "+eval(n.consts[bc[ip+1]]).length+";":"peg$currPos++;");ip+=2;break;case i.FAIL:parts.push(e.push("peg$FAILED"));parts.push("if (peg$silentFails === 0) { peg$fail("+c(bc[ip+1])+"); }");ip+=2;break;case i.REPORT_SAVED_POS:parts.push("peg$reportedPos = "+e.index(bc[ip+1])+";");ip+=2;break;case i.REPORT_CURR_POS:parts.push("peg$reportedPos = peg$currPos;");ip++;break;case i.CALL:compileCall();break;case i.RULE:parts.push(e.push("peg$parse"+n.rules[bc[ip+1]].name+"()"));ip+=2;break;case i.SILENT_FAILS_ON:parts.push("peg$silentFails++;");ip++;break;case i.SILENT_FAILS_OFF:parts.push("peg$silentFails--;");ip++;break;default:throw new Error("Invalid opcode: "+bc[ip]+".");}return parts.join("\n")}var l=[],v,e={sp:-1,maxSp:-1,push:function(n){var t=o(++this.sp)+" = "+n+";";return this.sp>this.maxSp&&(this.maxSp=this.sp),t},pop:function(){var n,t;return arguments.length===0?o(this.sp--):(n=arguments[0],t=r.map(r.range(this.sp-n+1,this.sp+1),o),this.sp-=n,t)},top:function(){return o(this.sp)},index:function(n){return o(this.sp-n)}};return v=a(u.bytecode),l.push(["function peg$parse"+u.name+"() {","  var "+r.map(r.range(0,e.maxSp+1),o).join(", ")+";",""].join("\n")),t.cache&&l.push(f(s(r.indexOfRuleByName(n,u.name)))),l.push(f(v)),t.cache&&l.push(f(h(o(0)))),l.push(["","  return "+o(0)+";","}"].join("\n")),l.join("\n")}var u=[],c,l,a,v;u.push('(function() {\n  /*\n   * Generated by PEG.js 0.8.0.\n   *\n   * http://pegjs.majda.cz/\n   */\n\n  function peg$subclass(child, parent) {\n    function ctor() { this.constructor = child; }\n    ctor.prototype = parent.prototype;\n    child.prototype = new ctor();\n  }\n\n  function SyntaxError(message, expected, found, offset, line, column) {\n    this.message  = message;\n    this.expected = expected;\n    this.found    = found;\n    this.offset   = offset;\n    this.line     = line;\n    this.column   = column;\n\n    this.name     = "SyntaxError";\n  }\n\n  peg$subclass(SyntaxError, Error);\n\n  function parse(input) {\n    var options = arguments.length > 1 ? arguments[1] : {},\n\n        peg$FAILED = {},\n');t.optimize==="size"?(c="{ "+r.map(t.allowedStartRules,function(t){return t+": "+r.indexOfRuleByName(n,t)}).join(", ")+" }",l=r.indexOfRuleByName(n,t.allowedStartRules[0]),u.push(["        peg$startRuleIndices = "+c+",","        peg$startRuleIndex   = "+l+","].join("\n"))):(a="{ "+r.map(t.allowedStartRules,function(n){return n+": peg$parse"+n}).join(", ")+" }",v="peg$parse"+t.allowedStartRules[0],u.push(["        peg$startRuleFunctions = "+a+",","        peg$startRuleFunction  = "+v+","].join("\n")));u.push("");u.push(y(p()));u.push("\n        peg$currPos          = 0,\n        peg$reportedPos      = 0,\n        peg$cachedPos        = 0,\n        peg$cachedPosDetails = { line: 1, column: 1, seenCR: false },\n        peg$maxFailPos       = 0,\n        peg$maxFailExpected  = [],\n        peg$silentFails      = 0,\n");t.cache&&u.push("        peg$cache = {},");u.push("        peg$result;\n");t.optimize==="size"?u.push('    if ("startRule" in options) {\n      if (!(options.startRule in peg$startRuleIndices)) {\n        throw new Error("Can\'t start parsing from rule \\"" + options.startRule + "\\".");\n      }\n\n      peg$startRuleIndex = peg$startRuleIndices[options.startRule];\n    }'):u.push('    if ("startRule" in options) {\n      if (!(options.startRule in peg$startRuleFunctions)) {\n        throw new Error("Can\'t start parsing from rule \\"" + options.startRule + "\\".");\n      }\n\n      peg$startRuleFunction = peg$startRuleFunctions[options.startRule];\n    }');u.push('\n    function text() {\n      return input.substring(peg$reportedPos, peg$currPos);\n    }\n\n    function offset() {\n      return peg$reportedPos;\n    }\n\n    function line() {\n      return peg$computePosDetails(peg$reportedPos).line;\n    }\n\n    function column() {\n      return peg$computePosDetails(peg$reportedPos).column;\n    }\n\n    function expected(description) {\n      throw peg$buildException(\n        null,\n        [{ type: "other", description: description }],\n        peg$reportedPos\n      );\n    }\n\n    function error(message) {\n      throw peg$buildException(message, null, peg$reportedPos);\n    }\n\n    function peg$computePosDetails(pos) {\n      function advance(details, startPos, endPos) {\n        var p, ch;\n\n        for (p = startPos; p < endPos; p++) {\n          ch = input.charAt(p);\n          if (ch === "\\n") {\n            if (!details.seenCR) { details.line++; }\n            details.column = 1;\n            details.seenCR = false;\n          } else if (ch === "\\r" || ch === "\\u2028" || ch === "\\u2029") {\n            details.line++;\n            details.column = 1;\n            details.seenCR = true;\n          } else {\n            details.column++;\n            details.seenCR = false;\n          }\n        }\n      }\n\n      if (peg$cachedPos !== pos) {\n        if (peg$cachedPos > pos) {\n          peg$cachedPos = 0;\n          peg$cachedPosDetails = { line: 1, column: 1, seenCR: false };\n        }\n        advance(peg$cachedPosDetails, peg$cachedPos, pos);\n        peg$cachedPos = pos;\n      }\n\n      return peg$cachedPosDetails;\n    }\n\n    function peg$fail(expected) {\n      if (peg$currPos < peg$maxFailPos) { return; }\n\n      if (peg$currPos > peg$maxFailPos) {\n        peg$maxFailPos = peg$currPos;\n        peg$maxFailExpected = [];\n      }\n\n      peg$maxFailExpected.push(expected);\n    }\n\n    function peg$buildException(message, expected, pos) {\n      function cleanupExpected(expected) {\n        var i = 1;\n\n        expected.sort(function(a, b) {\n          if (a.description < b.description) {\n            return -1;\n          } else if (a.description > b.description) {\n            return 1;\n          } else {\n            return 0;\n          }\n        });\n\n        while (i < expected.length) {\n          if (expected[i - 1] === expected[i]) {\n            expected.splice(i, 1);\n          } else {\n            i++;\n          }\n        }\n      }\n\n      function buildMessage(expected, found) {\n        function stringEscape(s) {\n          function hex(ch) { return ch.charCodeAt(0).toString(16).toUpperCase(); }\n\n          return s\n            .replace(/\\\\/g,   \'\\\\\\\\\')\n            .replace(/"/g,    \'\\\\"\')\n            .replace(/\\x08/g, \'\\\\b\')\n            .replace(/\\t/g,   \'\\\\t\')\n            .replace(/\\n/g,   \'\\\\n\')\n            .replace(/\\f/g,   \'\\\\f\')\n            .replace(/\\r/g,   \'\\\\r\')\n            .replace(/[\\x00-\\x07\\x0B\\x0E\\x0F]/g, function(ch) { return \'\\\\x0\' + hex(ch); })\n            .replace(/[\\x10-\\x1F\\x80-\\xFF]/g,    function(ch) { return \'\\\\x\'  + hex(ch); })\n            .replace(/[\\u0180-\\u0FFF]/g,         function(ch) { return \'\\\\u0\' + hex(ch); })\n            .replace(/[\\u1080-\\uFFFF]/g,         function(ch) { return \'\\\\u\'  + hex(ch); });\n        }\n\n        var expectedDescs = new Array(expected.length),\n            expectedDesc, foundDesc, i;\n\n        for (i = 0; i < expected.length; i++) {\n          expectedDescs[i] = expected[i].description;\n        }\n\n        expectedDesc = expected.length > 1\n          ? expectedDescs.slice(0, -1).join(", ")\n              + " or "\n              + expectedDescs[expected.length - 1]\n          : expectedDescs[0];\n\n        foundDesc = found ? "\\"" + stringEscape(found) + "\\"" : "end of input";\n\n        return "Expected " + expectedDesc + " but " + foundDesc + " found.";\n      }\n\n      var posDetails = peg$computePosDetails(pos),\n          found      = pos < input.length ? input.charAt(pos) : null;\n\n      if (expected !== null) {\n        cleanupExpected(expected);\n      }\n\n      return new SyntaxError(\n        message !== null ? message : buildMessage(expected, found),\n        expected,\n        found,\n        pos,\n        posDetails.line,\n        posDetails.column\n      );\n    }\n');t.optimize==="size"?(u.push(o(w())),u.push("")):r.each(n.rules,function(n){u.push(o(b(n)));u.push("")});n.initializer&&(u.push(o(n.initializer.code)),u.push(""));t.optimize==="size"?u.push("    peg$result = peg$parseRule(peg$startRuleIndex);"):u.push("    peg$result = peg$startRuleFunction();");u.push('\n    if (peg$result !== peg$FAILED && peg$currPos === input.length) {\n      return peg$result;\n    } else {\n      if (peg$result !== peg$FAILED && peg$currPos < input.length) {\n        peg$fail({ type: "end", description: "end of input" });\n      }\n\n      throw peg$buildException(null, peg$maxFailExpected, peg$maxFailPos);\n    }\n  }\n\n  return {\n    SyntaxError: SyntaxError,\n    parse:       parse\n  };\n})()');n.code=u.join("\n")}}),t.define("compiler/passes/remove-proxy-rules",function(n,t){var i=t("../../utils");n.exports=function(n,t){function u(n){return n.type==="rule"&&n.expression.type==="rule_ref"}function f(n,t,r){function f(){}function u(n,t,i){o(n.expression,t,i)}function e(n){return function(t,r,u){i.each(t[n],function(n){o(n,r,u)})}}var o=i.buildNodeVisitor({grammar:e("rules"),rule:u,named:u,choice:e("alternatives"),sequence:e("elements"),labeled:u,text:u,simple_and:u,simple_not:u,semantic_and:f,semantic_not:f,optional:u,zero_or_more:u,one_or_more:u,action:u,rule_ref:function(n,t,i){n.name===t&&(n.name=i)},literal:f,"class":f,any:f});o(n,t,r)}var r=[];i.each(n.rules,function(e,o){u(e)&&(f(n,e.name,e.expression.name),i.contains(t.allowedStartRules,e.name)||r.push(o))});r.reverse();i.each(r,function(t){n.rules.splice(t,1)})}}),t.define("compiler/passes/report-left-recursion",function(n,t){var i=t("../../utils"),r=t("../../grammar-error");n.exports=function(n){function f(){}function t(n,t){u(n.expression,t)}function e(n){return function(t,r){i.each(t[n],function(n){u(n,r)})}}var u=i.buildNodeVisitor({grammar:e("rules"),rule:function(n,t){u(n.expression,t.concat(n.name))},named:t,choice:e("alternatives"),action:t,sequence:function(n,t){n.elements.length>0&&u(n.elements[0],t)},labeled:t,text:t,simple_and:t,simple_not:t,semantic_and:f,semantic_not:f,optional:t,zero_or_more:t,one_or_more:t,rule_ref:function(t,f){if(i.contains(f,t.name))throw new r('Left recursion detected for rule "'+t.name+'".');u(i.findRuleByName(n,t.name),f)},literal:f,"class":f,any:f});u(n,[])}}),t.define("compiler/passes/report-missing-rules",function(n,t){var i=t("../../utils"),r=t("../../grammar-error");n.exports=function(n){function u(){}function t(n){e(n.expression)}function f(n){return function(t){i.each(t[n],e)}}var e=i.buildNodeVisitor({grammar:f("rules"),rule:t,named:t,choice:f("alternatives"),action:t,sequence:f("elements"),labeled:t,text:t,simple_and:t,simple_not:t,semantic_and:u,semantic_not:u,optional:t,zero_or_more:t,one_or_more:t,rule_ref:function(t){if(!i.findRuleByName(n,t.name))throw new r('Referenced rule "'+t.name+'" does not exist.');},literal:u,"class":u,any:u});e(n)}}),t.define("compiler",function(n,t){var i=t("./utils");n.exports={passes:{check:{reportMissingRules:t("./compiler/passes/report-missing-rules"),reportLeftRecursion:t("./compiler/passes/report-left-recursion")},transform:{removeProxyRules:t("./compiler/passes/remove-proxy-rules")},generate:{generateBytecode:t("./compiler/passes/generate-bytecode"),generateJavascript:t("./compiler/passes/generate-javascript")}},compile:function(ast,passes){function runPass(n){n(ast,options)}var options=arguments.length>2?i.clone(arguments[2]):{},stage;i.defaults(options,{allowedStartRules:[ast.rules[0].name],cache:!1,optimize:"speed",output:"parser"});for(stage in passes)passes.hasOwnProperty(stage)&&i.each(passes[stage],runPass);switch(options.output){case"parser":return eval(ast.code);case"source":return ast.code}}}}),t.define("peg",function(n,t){var i=t("./utils");n.exports={VERSION:"0.8.0",GrammarError:t("./grammar-error"),parser:t("./parser"),compiler:t("./compiler"),buildParser:function(n){function u(n){var r={},t;for(t in n)n.hasOwnProperty(t)&&(r[t]=i.values(n[t]));return r}var t=arguments.length>1?i.clone(arguments[1]):{},f="plugins"in t?t.plugins:[],r={parser:this.parser,passes:u(this.compiler.passes)};return i.each(f,function(n){n.use(r,t)}),this.compiler.compile(r.parser.parse(n),r.passes,t)}}}),t.peg}(),pgnParser=function(){function t(n,t){function i(){this.constructor=n}i.prototype=t.prototype;n.prototype=new i}function n(n,t,i,r,u,f){this.message=n;this.expected=t;this.found=i;this.offset=r;this.line=u;this.column=f;this.name="SyntaxError"}function i(t){function tt(n){function i(n,i,r){for(var u,f=i;f<r;f++)u=t.charAt(f),u==="\n"?(n.seenCR||n.line++,n.column=1,n.seenCR=!1):u==="\r"||u==="\u2028"||u==="\u2029"?(n.line++,n.column=1,n.seenCR=!0):(n.column++,n.seenCR=!1)}return l!==n&&(l>n&&(l=0,g={line:1,column:1,seenCR:!1}),i(g,l,n),l=n),g}function s(n){r<v||(r>v&&(v=r,nt=[]),nt.push(n))}function it(i,r,u){function o(n){var t=1;for(n.sort(function(n,t){return n.description<t.description?-1:n.description>t.description?1:0});t<n.length;)n[t-1]===n[t]?n.splice(t,1):t++}function s(n,t){function e(n){function t(n){return n.charCodeAt(0).toString(16).toUpperCase()}return n.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(n){return"\\x0"+t(n)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(n){return"\\x"+t(n)}).replace(/[\u0180-\u0FFF]/g,function(n){return"\\u0"+t(n)}).replace(/[\u1080-\uFFFF]/g,function(n){return"\\u"+t(n)})}for(var r=new Array(n.length),u,f,i=0;i<n.length;i++)r[i]=n[i].description;return u=n.length>1?r.slice(0,-1).join(", ")+" or "+r[n.length-1]:r[0],f=t?'"'+e(t)+'"':"end of input","Expected "+u+" but "+f+" found."}var f=tt(u),e=u<t.length?t.charAt(u):null;return r!==null&&o(r),new n(i!==null?i:s(r,e),r,e,u,f.line,f.column)}function oi(){var n,t,e;return n=r,t=le(),t!==i?(e=rt(),e===i&&(e=f),e!==i?(o=n,t=di(t,e),n=t):(r=n,n=u)):(r=n,n=u),n===i&&(n=r,t=si(),t!==i?(e=p(),e===i&&(e=f),e!==i?(o=n,t=gi(t,e),n=t):(r=n,n=u)):(r=n,n=u),n===i&&(n=r,t=h(),t===i&&(t=f),t!==i&&(o=n,t=nr()),n=t)),n}function le(){var n,t,e;return n=r,t=h(),t===i&&(t=f),t!==i?(e=p(),e!==i?(o=n,t=tr(e),n=t):(r=n,n=u)):(r=n,n=u),n}function si(){var n,t,e,l,s,a;return n=r,t=h(),t===i&&(t=f),t!==i?(e=c(),e===i&&(e=f),e!==i?(l=h(),l===i&&(l=f),l!==i?(s=ki(),s===i&&(s=f),s!==i?(a=rt(),a!==i?(o=n,t=ir(e,s,a),n=t):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n}function p(){var n,t,e,p,g,w,s,b,nt,l,k,a,d,v,y;return n=r,t=h(),t===i&&(t=f),t!==i?(e=c(),e===i&&(e=f),e!==i?(p=h(),p===i&&(p=f),p!==i?(g=ye(),g!==i?(w=h(),w===i&&(w=f),w!==i?(s=c(),s===i&&(s=f),s!==i?(b=h(),b===i&&(b=f),b!==i?(nt=yi(),nt!==i?(l=ft(),l===i&&(l=f),l!==i?(k=h(),k===i&&(k=f),k!==i?(a=c(),a===i&&(a=f),a!==i?(d=h(),d===i&&(d=f),d!==i?(v=ci(),v===i&&(v=f),v!==i?(y=rt(),y===i&&(y=f),y!==i?(o=n,t=rr(e,g,s,nt,l,a,v,y),n=t):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n===i&&(n=hi()),n}function rt(){var n,t,e,y,k,s,w,l,b,a,v;return n=r,t=h(),t===i&&(t=f),t!==i?(e=c(),e===i&&(e=f),e!==i?(y=h(),y===i&&(y=f),y!==i?(k=yi(),k!==i?(s=ft(),s===i&&(s=f),s!==i?(w=h(),w===i&&(w=f),w!==i?(l=c(),l===i&&(l=f),l!==i?(b=h(),b===i&&(b=f),b!==i?(a=li(),a===i&&(a=f),a!==i?(v=p(),v===i&&(v=f),v!==i?(o=n,t=ur(e,k,s,l,a,v),n=t):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n===i&&(n=hi()),n}function hi(){var u,n;return u=r,t.substr(r,3)===ct?(n=ct,r+=3):(n=i,e===0&&s(fr)),n!==i&&(o=u,n=er()),u=n,u===i&&(u=r,t.substr(r,3)===lt?(n=lt,r+=3):(n=i,e===0&&s(or)),n!==i&&(o=u,n=sr()),u=n,u===i&&(u=r,t.substr(r,7)===at?(n=at,r+=7):(n=i,e===0&&s(hr)),n!==i&&(o=u,n=cr()),u=n,u===i&&(u=r,t.charCodeAt(r)===42?(n=lr,r++):(n=i,e===0&&s(ar)),n!==i&&(o=u,n=vr()),u=n))),u}function c(){var n,c,h,f;if(n=r,c=ae(),c!==i){if(h=[],vt.test(t.charAt(r))?(f=t.charAt(r),r++):(f=i,e===0&&s(yt)),f!==i)while(f!==i)h.push(f),vt.test(t.charAt(r))?(f=t.charAt(r),r++):(f=i,e===0&&s(yt));else h=u;h!==i?(f=ve(),f!==i?(o=n,c=yr(h),n=c):(r=n,n=u)):(r=n,n=u)}else r=n,n=u;return n}function ae(){var n;return t.charCodeAt(r)===123?(n=pr,r++):(n=i,e===0&&s(wr)),n}function ve(){var n;return t.charCodeAt(r)===125?(n=br,r++):(n=i,e===0&&s(kr)),n}function ci(){var n,s,a,v,c,t,l,e;return n=r,s=ai(),s!==i?(a=p(),a!==i?(v=vi(),v!==i?(c=h(),c===i&&(c=f),c!==i?(t=ci(),t===i&&(t=f),t!==i?(l=h(),l===i&&(l=f),l!==i?(e=ki(),e===i&&(e=f),e!==i?(o=n,s=dr(a,t,e),n=s):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n}function li(){var n,e,c,l,s,t;return n=r,e=ai(),e!==i?(c=si(),c!==i?(l=vi(),l!==i?(s=h(),s===i&&(s=f),s!==i?(t=li(),t===i&&(t=f),t!==i?(o=n,e=gr(c,t),n=e):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n}function ai(){var n;return t.charCodeAt(r)===40?(n=nu,r++):(n=i,e===0&&s(tu)),n}function vi(){var n;return t.charCodeAt(r)===41?(n=iu,r++):(n=i,e===0&&s(ru)),n}function ye(){var n,h,c;return n=r,h=ut(),h!==i?(t.charCodeAt(r)===46?(c=k,r++):(c=i,e===0&&s(d)),c===i&&(c=f),c!==i?(o=n,h=pt(h),n=h):(r=n,n=u)):(r=n,n=u),n}function ut(){var h,n,f;if(e++,h=r,n=[],wt.test(t.charAt(r))?(f=t.charAt(r),r++):(f=i,e===0&&s(bt)),f!==i)while(f!==i)n.push(f),wt.test(t.charAt(r))?(f=t.charAt(r),r++):(f=i,e===0&&s(bt));else n=u;return n!==i&&(o=h,n=fu(n)),h=n,e--,h===i&&(n=i,e===0&&s(uu)),h}function h(){var h,f,n;if(h=r,f=[],t.charCodeAt(r)===32?(n=kt,r++):(n=i,e===0&&s(dt)),n!==i)while(n!==i)f.push(n),t.charCodeAt(r)===32?(n=kt,r++):(n=i,e===0&&s(dt));else f=u;return f!==i&&(o=h,f=eu()),f}function yi(){var n,h,c,l,a,v,y,p,k;return n=r,h=et(),h===i&&(h=f),h!==i?(c=r,e++,l=we(),e--,l!==i?(r=c,c=ou):c=u,c!==i?(l=bi(),l!==i?(a=ot(),a===i&&(a=f),a!==i?(v=w(),v!==i?(y=b(),y!==i?(p=wi(),p===i&&(p=f),p!==i?(k=pi(),k===i&&(k=f),k!==i?(o=n,h=su(h,l,a,v,y,p,k),n=h):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n===i&&(n=r,h=et(),h===i&&(h=f),h!==i?(c=ot(),c===i&&(c=f),c!==i?(l=w(),l!==i?(a=b(),a!==i?(v=wi(),v===i&&(v=f),v!==i?(y=pi(),y===i&&(y=f),y!==i?(o=n,h=hu(h,c,l,a,v,y),n=h):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n===i&&(n=r,t.substr(r,5)===gt?(h=gt,r+=5):(h=i,e===0&&s(cu)),h!==i&&(o=n,h=lu()),n=h,n===i&&(n=r,t.substr(r,3)===ni?(h=ni,r+=3):(h=i,e===0&&s(au)),h!==i&&(o=n,h=vu()),n=h))),n}function pi(){var n;return t.charCodeAt(r)===43?(n=yu,r++):(n=i,e===0&&s(pu)),n===i&&(t.charCodeAt(r)===35?(n=wu,r++):(n=i,e===0&&s(bu))),n}function wi(){var n,f,h;return n=r,t.charCodeAt(r)===61?(f=ti,r++):(f=i,e===0&&s(ii)),f!==i?(h=et(),h!==i?(o=n,f=ku(h),n=f):(r=n,n=u)):(r=n,n=u),n}function ft(){var n,t,s,e;return n=r,t=pe(),t!==i?(s=h(),s===i&&(s=f),s!==i?(e=ft(),e===i&&(e=f),e!==i?(o=n,t=du(t,e),n=t):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n}function pe(){var f,n,h;return f=r,t.charCodeAt(r)===36?(n=gu,r++):(n=i,e===0&&s(nf)),n!==i?(h=ut(),h!==i?(o=f,n=tf(h),f=n):(r=f,f=u)):(r=f,f=u),f===i&&(f=r,t.substr(r,2)===ri?(n=ri,r+=2):(n=i,e===0&&s(rf)),n!==i&&(o=f,n=uf()),f=n,f===i&&(f=r,t.substr(r,2)===ui?(n=ui,r+=2):(n=i,e===0&&s(ff)),n!==i&&(o=f,n=ef()),f=n,f===i&&(f=r,t.substr(r,2)===fi?(n=fi,r+=2):(n=i,e===0&&s(of)),n!==i&&(o=f,n=sf()),f=n,f===i&&(f=r,t.substr(r,2)===ei?(n=ei,r+=2):(n=i,e===0&&s(hf)),n!==i&&(o=f,n=cf()),f=n,f===i&&(f=r,t.charCodeAt(r)===33?(n=lf,r++):(n=i,e===0&&s(af)),n!==i&&(o=f,n=vf()),f=n,f===i&&(f=r,t.charCodeAt(r)===63?(n=yf,r++):(n=i,e===0&&s(pf)),n!==i&&(o=f,n=wf()),f=n,f===i&&(f=r,t.charCodeAt(r)===61?(n=ti,r++):(n=i,e===0&&s(ii)),n!==i&&(o=f,n=bf()),f=n,f===i&&(f=r,t.charCodeAt(r)===8734?(n=kf,r++):(n=i,e===0&&s(df)),n!==i&&(o=f,n=gf()),f=n,f===i&&(f=r,t.charCodeAt(r)===68?(n=ne,r++):(n=i,e===0&&s(te)),n!==i&&(o=f,n=ie()),f=n))))))))),f}function bi(){var n;return n=w(),n===i&&(n=b()),n}function we(){var n,t,e,o,s;return n=r,t=bi(),t!==i?(e=ot(),e===i&&(e=f),e!==i?(o=w(),o!==i?(s=b(),s!==i?(t=[t,e,o,s],n=t):(r=n,n=u)):(r=n,n=u)):(r=n,n=u)):(r=n,n=u),n}function ki(){var n,h,c,f;if(n=r,h=ut(),h!==i){if(c=[],t.charCodeAt(r)===46?(f=k,r++):(f=i,e===0&&s(d)),f!==i)while(f!==i)c.push(f),t.charCodeAt(r)===46?(f=k,r++):(f=i,e===0&&s(d));else c=u;c!==i?(o=n,h=pt(h),n=h):(r=n,n=u)}else r=n,n=u;return n}function et(){var n;return re.test(t.charAt(r))?(n=t.charAt(r),r++):(n=i,e===0&&s(ue)),n}function w(){var n;return fe.test(t.charAt(r))?(n=t.charAt(r),r++):(n=i,e===0&&s(ee)),n}function b(){var n;return oe.test(t.charAt(r))?(n=t.charAt(r),r++):(n=i,e===0&&s(se)),n}function ot(){var n;return t.charCodeAt(r)===120?(n=he,r++):(n=i,e===0&&s(ce)),n}function be(n){return parseInt(n.join(""),10)}var a=arguments.length>1?arguments[1]:{},i={},st={pgn:oi},ht=oi,u=i,f=null,di=function(n,t){return arr=t?t:[],arr.unshift(n),arr},gi=function(n,t){return arr=t?t:[],arr.unshift(n),arr},nr=function(){return[[]]},tr=function(n){return n},ir=function(n,t,i){return last=i[0],last.moveNumber=t,last.commentMove=n,i},rr=function(n,t,i,r,u,f,e,o){return arr=o?o:[],move={},move.turn="w",move.moveNumber=t,move.notation=r,move.commentBefore=i,move.commentAfter=f,move.commentMove=n,move.variations=e?e:[],move.nag=u?u:null,arr.unshift(move),arr},ur=function(n,t,i,r,u,f){return arr=f?f:[],move={},move.turn="b",move.notation=t,move.commentBefore=n,move.commentAfter=r,move.variations=u?u:[],arr.unshift(move),move.nag=i?i:null,arr},ct="1:0",fr={type:"literal",value:"1:0",description:'"1:0"'},er=function(){return["1:0"]},lt="0:1",or={type:"literal",value:"0:1",description:'"0:1"'},sr=function(){return["0:1"]},at="1/2-1/2",hr={type:"literal",value:"1/2-1/2",description:'"1/2-1/2"'},cr=function(){return["1/2-1/2"]},lr="*",ar={type:"literal",value:"*",description:'"*"'},vr=function(){return["*"]},vt=/^[^}]/,yt={type:"class",value:"[^}]",description:"[^}]"},yr=function(n){return n.join("").trim()},pr="{",wr={type:"literal",value:"{",description:'"{"'},br="}",kr={type:"literal",value:"}",description:'"}"'},dr=function(n,t){return arr=t?t:[],arr.unshift(n),arr},gr=function(n,t){return arr=t?t:[],arr.unshift(n),arr},nu="(",tu={type:"literal",value:"(",description:'"("'},iu=")",ru={type:"literal",value:")",description:'")"'},k=".",d={type:"literal",value:".",description:'"."'},pt=function(n){return n},uu={type:"other",description:"integer"},wt=/^[0-9]/,bt={type:"class",value:"[0-9]",description:"[0-9]"},fu=function(n){return be(n)},kt=" ",dt={type:"literal",value:" ",description:'" "'},eu=function(){return""},ou=void 0,su=function(n,t,i,r,u,f,e){return hm={},hm.fig=n?n:null,hm.disc=t?t:null,hm.strike=i?i:null,hm.col=r,hm.row=u,hm.check=e?e:null,hm.promotion=f,hm.notation=(n?n:"")+(t?t:"")+(i?i:"")+r+u+(f?f:"")+(e?e:""),hm},hu=function(n,t,i,r,u,f){return hm={},hm.fig=n?n:null,hm.strike=t?t:null,hm.col=i,hm.row=r,hm.check=f?f:null,hm.notation=(n?n:"")+(t?t:"")+i+r+(u?u:"")+(f?f:""),hm.promotion=u,hm},gt="O-O-O",cu={type:"literal",value:"O-O-O",description:'"O-O-O"'},lu=function(){return hm={},hm.notation="O-O-O",hm},ni="O-O",au={type:"literal",value:"O-O",description:'"O-O"'},vu=function(){return hm={},hm.notation="O-O",hm},yu="+",pu={type:"literal",value:"+",description:'"+"'},wu="#",bu={type:"literal",value:"#",description:'"#"'},ti="=",ii={type:"literal",value:"=",description:'"="'},ku=function(n){return"="+n},du=function(n,t){return arr=t?t:[],arr.unshift(n),arr},gu="$",nf={type:"literal",value:"$",description:'"$"'},tf=function(n){return"$"+n},ri="!!",rf={type:"literal",value:"!!",description:'"!!"'},uf=function(){return"$3"},ui="??",ff={type:"literal",value:"??",description:'"??"'},ef=function(){return"$4"},fi="!?",of={type:"literal",value:"!?",description:'"!?"'},sf=function(){return"$5"},ei="?!",hf={type:"literal",value:"?!",description:'"?!"'},cf=function(){return"$6"},lf="!",af={type:"literal",value:"!",description:'"!"'},vf=function(){return"$1"},yf="?",pf={type:"literal",value:"?",description:'"?"'},wf=function(){return"$2"},bf=function(){return"$10"},kf="",df={type:"literal",value:"",description:'"\\u221E"'},gf=function(){return"$13"},ne="D",te={type:"literal",value:"D",description:'"D"'},ie=function(){return"$220"},re=/^[RNBQK]/,ue={type:"class",value:"[RNBQK]",description:"[RNBQK]"},fe=/^[a-h]/,ee={type:"class",value:"[a-h]",description:"[a-h]"},oe=/^[1-8]/,se={type:"class",value:"[1-8]",description:"[1-8]"},he="x",ce={type:"literal",value:"x",description:'"x"'},r=0,o=0,l=0,g={line:1,column:1,seenCR:!1},v=0,nt=[],e=0,y;if("startRule"in a){if(!(a.startRule in st))throw new Error("Can't start parsing from rule \""+a.startRule+'".');ht=st[a.startRule]}if(y=ht(),y!==i&&r===t.length)return y;y!==i&&r<t.length&&s({type:"end",description:"end of input"});throw it(null,nt,v);}return t(n,Error),{SyntaxError:n,parse:i}}(),pgnReader,pgnBase,pgnView;pgnReader=function(n){var t={},o=pgnParser,r=n.fen?new Chess(n.fen):new Chess,f=n.fen,s=r.turn,u;for(t.PGN_KEYS={Event:"the name of the tournament or match event",Site:"the location of the event",Date:"the starting date of the game (format: YYYY.MM.TT)",Round:"the playing round ordinal of the game",White:"the player of the white pieces (last name, pre name)",Black:"the player of the black pieces (last name, pre name)",Result:"the result of the game (1 - 0, 1/2 - 1/2, 0 - 1)",Board:"the board number in a team event",ECO:"ECO-Opening-Key (ECO = 'Encyclopaedia of Chess Openings')",WhitemyELO:"myELO-score white (at the beginning of the game)",BlackmyELO:"myELO-score black (at the beginning of the game)",WhiteDays:"rate in days for white",BlackDays:"rate in days for black",myChessNo:"identification-no. of the game on the myChess.de - server",Annotator:"The person providing notes to the game.",PlyCount:"String value denoting total number of half-moves played.",TimeControl:"40/7200:3600 (moves per seconds: sudden death seconds)",Time:'Time the game started, in "HH:MM:SS" format, in local clock time.',Termination:'Gives more details about the termination of the game. It may be "abandoned", "adjudication" (result determined by third-party adjudication), "death", "emergency", "normal", "rules infraction", "time forfeit", or "unterminated".',Mode:'"OTB" (over-the-board) "ICS" (Internet Chess Server)'},t.NAGs=[null,"!","?","!!","??","!?","?!","",null,null,"=",null,null,"","","","","","+","-+"],t.PGN_NAGS={},u=0;u<t.NAGs.length;u++)t.PGN_NAGS[t.NAGs[u]]=u;var e=function(n){var r="",i,f,u;if(n===null||n===undefined)return r;for(i=0;i<n.length;i++)f=parseInt(n[i].substring(1)),u=t.NAGs[f],r+=typeof u!="undefined"?u:"";return r},h=function(n){if(typeof n.row=="undefined")return n.notation;var t=n.fig?n.fig:"",i=n.strike?n.strike:"",r=n.disc?n.disc:"",u=n.check?n.check:"",f=n.promotion?n.promotion:"";return t+r+i+n.col+n.row+f+u},y=function(n){var t=h(n.notation);return n.nag&&(t+=e(n.nag)),t},p=function(n){var i=t.PGN_NAGS[n];return i==="undefined"?null:"$"+i},w=function(){var n=c();return l(n),t},c=function(){var r=function(n){var u={},f=n.match(/\[([^\]]+)]/g),i,r,e;if(f===null)return u;for(i=0;i<f.length;i++)r=f[i].match(/\[(\w+)\s+\"([^\"]+)\"/),r&&(e=r[1],t.PGN_KEYS[e]&&(u[e]=r[2]));return u},i;return t.headers=r(n.pgn),i=n.pgn.lastIndexOf("]"),n.pgn.substring(i+1)},l=function(n){var i=function(n,t,i,r){r!=null&&(i.prev=t,r.next||(r.next=n));i.index=n},r=function(){typeof t.movesMainLine[t.movesMainLine.length-1]=="string"&&(t.endGame=t.movesMainLine.pop())};t.moves_string=n.trim();t.movesMainLine=o.parse(t.moves_string)[0];r();v(i)},i=function(n){return t.moves[n]},a=function(n){return n.variationLevel>0&&(n.prev===undefined||t.moves[n.prev].next!=n.index)},b=function(n){return n.variationLevel>0&&!n.next},k=function(){function n(n){n.isEmpty()||n.lastChar()==" "||n.append(" ")}var t=function(t,i){t!==undefined&&t!==null&&(n(i),i.append("{"),i.append(t),i.append("}"))},f=function(n,i){t(n.commentMove,i)},o=function(n,i){t(n.commentBefore,i)},s=function(n,i){t(n.commentAfter,i)},h=function(t,i){n(i);t.turn==="w"?(i.append(""+t.moveNumber),i.append(".")):a(t)&&(i.append(""+t.moveNumber),i.append("..."))},c=function(t,i){n(i);i.append(t.notation.notation)},l=function(n,t){t.append(e(n.nag))},v=function(t,i){n(i);i.append("(");r(t[0],i);n(i);i.append(")")},y=function(n,t){for(var i=0;i<n.variations.length;i++)v(n.variations[i],t)},p=function(n){return n.next?i(n.next):null},r=function(n,t){if(n!==null&&n!==undefined){f(n,t);h(n,t);o(n,t);c(n,t);l(n,t);s(n,t);y(n,t);var i=p(n);r(i,t)}},w=function(n){return r(n,u),u.toString()},u=StringBuilder("");return w(i(0),u)},d=function(n){return typeof n.nag=="undefined"?!1:n.nag==null?!1:n.nag.indexOf("$220")>-1},v=function(n){t.moves=[];var u=-1,o=function(n,i){while(i>=0){if(t.moves[i].variationLevel==n)return t.moves[i];i--}return null},e=function(s,h,c){var l=c!=null?t.moves[c]:null;$.each(s,function(s,a){var v,y;u++;a.variationLevel=h;t.moves.push(a);s>0&&(t.moves[u-1].variationLevel>h?(l=o(h,u-1),c=l.index):(c=u-1,l=t.moves[c]));n(u,c,a,l);typeof a.prev=="number"?r.load(i(a.prev).fen):(r.reset(),f!=null&&r.load(f));v=r.move(a.notation.notation);v==null;y=r.fen();a.fen=y;$.each(a.variations,function(n,t){e(t,h+1,c)})})};e(t.movesMainLine,0,null)};w();var g=function(n,e){function v(n,t){var f,e,o,s,h;if(t==null||(f=i(t),typeof f=="undefined")||(r.load(f.fen),e=r.move(n),o=i(f.next),typeof o=="undefined"))return null;if(o.notation.notation==e.san)return f.next;for(s=i(f.next),u=0;u<s.variations.length;u++)if(h=s.variations[u],h[0].notation.notation==e.san)return h[0].index;return null}function y(n,t,r){var u=i(t);u.next?(i(u.next).variations.push([n]),n.variationLevel=(u.variationLevel?u.variationLevel:0)+1,n.turn=="b"&&(n.moveNumber=u.moveNumber)):(u.next=r,n.variationLevel=u.variationLevel)}var a=function(n){return i(n).turn==="w"?"b":"w"},l=v(n,e),o,h,c;return l?l:(o={},o.notation={},o.variations=[],e==null?(r.reset(),f!=null&&r.load(f),o.turn="w",s!=null&&(o.turn=s),o.moveNumber=1):(r.load(i(e).fen),o.turn=a(e),o.turn==="w"&&(o.moveNumber=i(i(e).prev).moveNumber+1)),h=r.move(n),o.fen=r.fen(),h.san.substring(0,1)!="O"?(o.notation.notation=h.san,o.notation.col=h.to.substring(0,1),o.notation.row=h.to.substring(1,2),h.piece!="p"&&(o.notation.fig=h.piece.charAt(0).toUpperCase())):o.notation.notation=h.san,n.indexOf("x")>-1&&(o.notation.strike="x",h.piece=="p"&&(o.notation.fig=h.from.substring(0,1))),t.moves.push(o),o.prev=e,c=t.moves.length-1,o.index=c,e!=null&&y(o,e,c),c)},nt=function(n,t,r){var u=i(t),f,e;u.nag==null&&(u.nag=[]);f=n[0]=="$"?n:p(n);r?u.nag.push(f):(e=u.nag.indexOf(f),e>-1&&u.nag.splice(e,1))},tt=function(n){var t=i(n);t.nag=[]};return{movesString:function(){return t.moves_string},readHeaders:c,readMoves:function(){return l},getMoves:function(){return t.moves},movesMainLine:t.movesMainLine,getMove:i,getHeaders:function(){return t.headers},getParser:function(){return o},eachMove:function(){return v()},write_pgn:k,nag_to_symbol:e,startVariation:a,endVariation:b,changeNag:nt,clearNags:tt,addMove:g,has_diagram_nag:d,PGN_NAGS:t.PGN_NAGS,NAGS:t.NAGs,san:h,sanWithNags:y}};pgnBase=function(n,t){function rt(n){var u=n[0].getBoundingClientRect(),i=$("#"+n[0].id).parent(),o=i.parent()[0].getBoundingClientRect(),f=i[0].getBoundingClientRect(),s=u.top-f.top,h=u.bottom-f.top,r=i.parent().scrollTop(),e=r+i.parent().innerHeight();return s<r||h>e?($("#"+n[0].id).parent().parent().animate({scrollTop:r+(u.top-(o.top+e-r))+30},t.timerTime-200),!1):!0}function r(n,t,i,r,u){var e=document.createElement(n);return t&&e.setAttribute("id",t),i&&(r?e.setAttribute("class",f+" "+i):e.setAttribute("class",i)),u&&u.appendChild(e),e}function ht(n){var t=r("select",u+"nag","nag",f,n);t.setAttribute("multiple","multiple");$.each(i.mypgn.NAGS,function(n,i){if(i!=null){var u=r("option",null,null,f,t);u.setAttribute("value",n);u.text=i}})}function vt(){return" "+$("#comment"+u+" textarea.comment").val()+" "}function nt(n){$("div#"+o+" a.yellow").removeClass("yellow");yt(n).addClass("yellow")}function pt(t){var r=i.mypgn.getMove(t);r.commentAfter?($("#"+n+" input.afterComment").prop("checked",!0),$("#"+n+" textarea.comment").val(r.commentAfter)):r.commentBefore?($("#"+n+" input.beforeComment").prop("checked",!0),$("#"+n+" textarea.comment").val(r.commentBefore)):r.commentMove?($("#"+n+" input.moveComment").prop("checked",!0),$("#"+n+" textarea.comment").val(r.commentMove)):$("#"+n+" textarea.comment").val("")}function wt(n,t){console.log("clicked: "+n+" Checked? "+t);i.mypgn.changeNag("$"+n,i.currentMove,t);bt(i.currentMove)}function bt(n){var t=i.mypgn.getMove(n);$("#"+o+n+" > a").text(i.mypgn.sanWithNags(t))}var i={},f=t.theme||"default",e=new Chess,c,p=n+"Headers",w=n+"Inner",o=n+"Moves",u=n+"Button",h=!1,v={},b,a,s,tt,it;(function(){t.position||(t.position="start")})();b=function(t,i){var r="#"+(i?i:"")+n+t;$(r)[0].style.display="none"};var k=function(){$("#"+n+" .square-55d63").removeClass("possible")},d=function(t){$("#"+n+" .square-"+t).addClass("possible")},ut=function(n,t){if(e.game_over()===!0||e.turn()==="w"&&t.search(/^b/)!==-1||e.turn()==="b"&&t.search(/^w/)!==-1)return!1},ft=function(n,t){k();var r=e.move({from:n,to:t,promotion:"q"});if(r===null)return"snapback";i.currentMoveNotation=r.san},et=function(n){var i=e.moves({square:n,verbose:!0}),t;if(i.length!==0)for(d(n),t=0;t<i.length;t++)d(i[t].to)},ot=function(){k()},st=function(){var t,n;c.position(e.fen());t=i.currentMove;i.currentMove=i.mypgn.addMove(i.currentMoveNotation,t);n=i.mypgn.getMove(i.currentMove);l(i.currentMove).length==0&&g(i.currentMove,null,n,n.prev,document.getElementById(o),[]);nt(i.currentMove);a(i.currentMove)};var ct=function(){function h(n,t){var e=r("button",u+n,n,f,t),i=n;switch(n){case"flipper":i="Flip Board";break;case"prev":i="Previous Move";break;case"next":i="Next Move";break;case"first":i="First Move";break;case"last":i="Last Move";break;case"play":i="Play"}return $("#"+u+n).attr("title",i),e}var k=function(n){["flipper","first","prev","next","play","last"].forEach(function(t){h(t,n)})},d=function(n){["deleteVar","promoteVar","deleteMoves"].forEach(function(t){var i=h(t,n)});["pgn"].forEach(function(t){var i=h(t,n)})},g=function(n){var t=r("div",null,"commentRadio",f,n),e=r("input",null,"moveComment",f,t),i,u;e.type="radio";e.value="move";e.name="radio";r("label",null,"labelMoveComment",f,t).appendChild(document.createTextNode("Move"));i=r("input",null,"beforeComment",f,t);i.type="radio";i.value="before";i.name="radio";r("label",null,"labelBeforeComment",f,t).appendChild(document.createTextNode("Before"));u=r("input",null,"afterComment",f,t);u.type="radio";u.value="after";u.name="radio";r("label",null,"labelAfterComment",f,t).appendChild(document.createTextNode("After"));r("textarea",null,"comment",f,n)},e=document.getElementById(n).getElementsByClassName("BoardContainer")[0],c=document.getElementById(n).getElementsByClassName("MovesContainer")[0],i,nt,l,v,s,b,it;if(e!=null){t.size&&(e.style.width=t.size);e.setAttribute("class",f+" whole");r("div",p,"headers",f,e);i=r("div",null,"outerBoard",null,e);t.boardSize&&(i.style.width=t.boardSize);nt=r("div",w,"board",f,i);l=r("div",u,"buttons",f,i);k(l);v=r("div","edit"+u,"edit",f,i);d(v);var y=r("div","outerpgn"+u,"outerpgn",f,i),rt=h("hidePGN",y),ut=r("div","pgn"+u,"pgn",f,y),tt=r("div","comment"+u,"comment",f,i);g(tt);c!=null&&(t.scrollable?(s=r("div",null,"movesOuterScroller",null,c),b=r("div",null,"movesScroller",null,s),r("div",o,"moves",null,b)):s=r("div",o,"moves",null,c),t.movesWidth&&(s.style.width=t.movesWidth),t.movesHeight&&(s.style.height=t.movesHeight,s.firstChild.style.height=t.movesHeight));it=r("div",null,"endBoard",null,e);a(-1)}},lt=function(){function i(n,t,i){var r=n.pieceStyle||"wikipedia";$.each(i,function(i,r){typeof n[r]!="undefined"&&(t[r]=n[r])});t.pieceTheme||(t.pieceTheme=root+"img/chesspieces/"+r+"/{piece}.png")}var n={};return i(t,n,["position","orientation","showNotation","pieceTheme","draggable","onDragStart","onDrop","onMouseoutSquare","onMouseoverSquare","onSnapEnd"]),t.overrideShowNotation!=null&&(n.showNotation=t.overrideShowNotation),c=new ChessBoard(w,n),c.orientation()=="black"&&$("#"+u+"flipper").addClass("BlackOrientation"),c},at=function(){var o,u,s,h;if(t.headers!=!1){var e=$("#"+p)[0],n=i.mypgn.getHeaders(),c=r("span",null,"whiteHeader",f,e);n.White&&c.appendChild(document.createTextNode(n.White+" "));o=r("span",null,"blackHeader",f,e);n.Black&&o.appendChild(document.createTextNode(" "+n.Black));u="";s=function(n,t,i){return t&&(n.length>0&&(n+=i),n+=t),n};[n.Event,n.Site,n.Round,n.Date,n.ECO,n.Result].forEach(function(n){u=s(u,n," | ")});h=r("span",null,"restHeader",f,e);h.appendChild(document.createTextNode(u))}};var y=function(n,t){var i=r("span",null,"comment "+t);return n&&typeof n=="string"&&i.appendChild(document.createTextNode(" "+n+" ")),i},l=function(n){return $("#"+o+n)},yt=function(n){return $("#"+o+n+"> a")},g=function(u,f,e,c,a,v,p){var ut=function(n,t,i,r){r.length==0?typeof n=="number"?$(t).insertAfter(l(n)):i.appendChild(t):r[r.length-1].appendChild(t)},b="move",w,nt,g,tt,k,d,it,rt;e.variationLevel>0&&(b=b+" var var"+e.variationLevel);e.turn=="w"&&(b=b+" white");w=r("span",o+u,b);nt=i.mypgn.startVariation(e);nt&&(g=r("div",null,"variation"),v.length==0?(tt=null,tt=typeof e.prev=="number"?i.mypgn.getMove(e.prev).next:0,l(tt)[0].appendChild(g)):v[v.length-1].appendChild(g),v.push(g));e.commentMove!=null&&e.commentMove.trim().length>0&&(w.appendChild(y(e.commentMove,"moveComment")),e.turn=="b"&&(h=!0));e.turn=="w"&&(k=e.moveNumber,d=r("span",null,"moveNumber",null,w),d.appendChild(document.createTextNode(""+k+". ")));e.commentBefore!=null&&e.commentBefore.trim().length>0&&(w.appendChild(y(e.commentBefore,"beforeComment")),e.turn=="b"&&(h=!0));(e.index==0||h==!0||nt||p)&&e.turn=="b"&&(k=e.moveNumber,d=r("span",null,"moveNumber",null,w),d.appendChild(document.createTextNode(""+k+"... ")),h=!1);var ft=r("a",null,null,null,w),et=i.mypgn.sanWithNags(e),ot=document.createTextNode(et);ft.appendChild(ot);w.appendChild(document.createTextNode(" "));e.commentAfter!=null&&e.commentAfter.trim().length>0?(w.appendChild(y(e.commentAfter,"afterComment")),e.turn=="w"&&(h=!0)):h=!1;ut(e.prev,w,a,v);i.mypgn.endVariation(e)&&v.pop();l(u).on("click",function(n){s(i.currentMove,u,e.fen);n.stopPropagation()});return i.mypgn.has_diagram_nag(e)&&(it=n+"dia"+u,rt=r("div",it),w.appendChild(rt),t.position=e.fen,pgnBoard(it,t)),e.turn=="b"&&(h=!1),u};return a=function(t){var e;if($("#"+n+" div.buttons .gray").removeClass("gray"),t==-1)["prev","first"].forEach(function(t){$("#"+n+" div.buttons ."+t).addClass("gray")});else if(e=i.mypgn.getMove(t),typeof e.next!="number"){v.stop();var f=$("#"+u+"play")[0],r=f.getAttribute("class"),o=f.getAttribute("title");r.indexOf("play")<0&&(r=r.replace("stop","play"),o=r.replace("Stop","Play"));f.setAttribute("class",r);f.setAttribute("title",o);["next","play","last"].forEach(function(t){$("#"+n+" div.buttons ."+t).addClass("gray")})}$("select#"+u+"nag").multiselect("uncheckAll")},s=function(n,t,r){c.position(r);e.load(r);nt(t);t!=null?(pt(t),rt(l(t)),i.currentMove=t,a(t)):(a(-1),delete i.currentMove)},tt=function(n){c.position(n);e.load(n)},it=function(r){var c,h,f;i.mypgn=pgnReader({pgn:t.pgn?t.pgn:"",fen:t.fen,turn:t.sideToMove});c=i.mypgn.getMoves();e.reset();var p=function(){function a(){var t=$("#"+u+"play")[0],n,i;$(t).hasClass("gray")||(v.toggle(),n=t.getAttribute("class"),i=t.getAttribute("title"),n.indexOf("play")<0?(n=n.replace("stop","play"),i=n.replace("Stop","Play")):(n=n.replace("play","stop"),i=n.replace("Play","Stop")),t.setAttribute("class",n),t.setAttribute("title",i))}var e=function(t,i){jQuery("#"+n+",#"+n+"Moves").bind("keydown",t,function(n){i();n.stopPropagation()})},o=function(){var n=null,t,r;typeof i.currentMove=="undefined"||i.currentMove==-1?(n=i.mypgn.getMove(0).fen,s(null,0,n)):(t=i.mypgn.getMove(i.currentMove).next,r=i.mypgn.getMove(t),r!=null&&(n=r.fen,s(i.currentMove,t,n)))},c=function(){var n=null,r;typeof i.currentMove=="undefined"||i.currentMove==0?(n=i.mypgn.getMove(0).fen,t.fen!=null&&(n=t.fen),s(null,null,n)):(r=i.mypgn.getMove(i.currentMove).prev,n=i.mypgn.getMove(r).fen,s(i.currentMove,r,n))},h,y,f;v=$.timer(function(){o()});v.set({time:t.timerTime?t.timerTime:700});$("#"+u+"flipper").on("click",function(){r.flip();r.orientation()=="white"?$("#"+u+"flipper").removeClass("BlackOrientation"):$("#"+u+"flipper").addClass("BlackOrientation")});$("#"+u+"next").on("click",function(){o()});$("#"+u+"prev").on("click",function(){c()});$("#"+u+"first").on("click",function(){var n=i.mypgn.getMove(0).fen;t.fen!=null&&(n=t.fen);s(null,null,n)});$("#"+u+"last").on("click",function(){var n=i.mypgn.getMove(i.mypgn.getMoves().length-1).fen;s(i.currentMove,i.mypgn.getMoves().length-1,n)});$("#"+u+"pgn").on("click",function(){$("#pgn"+u).hide(200);var t=w();b(t);$("#"+n+" .outerpgn").show()});$("#"+n+" .hidePGN").on("click",function(){$("#"+n+" .outerpgn").hide("fold")});for($("#"+n+" .outerpgn").hide(),$("#comment"+u+" textarea.comment").change(function(){var n=vt(),t=$("#comment"+u+" :checked").val()||"after";l(i.currentMove).find("."+t+"Comment").text(n);t==="after"?i.mypgn.getMove(i.currentMove).commentAfter=n:t==="before"?i.mypgn.getMove(i.currentMove).commentBefore=n:t==="move"&&(i.mypgn.getMove(i.currentMove).commentMove=n)}),h=["moveComment","beforeComment","afterComment"],y=null,f=0;f<h.length;f++)$("#comment"+u+" ."+h[f]).click(function(){var r=this.value,t;r==="after"?t=i.mypgn.getMove(i.currentMove).commentAfter:r==="before"?t=i.mypgn.getMove(i.currentMove).commentBefore:r==="move"&&(t=i.mypgn.getMove(i.currentMove).commentMove);$("#"+n+" textarea.comment").val(t)});e("left",c);e("right",o);e("space",a);$("#"+u+"play").on("click",function(){a()})},w=function(){return i.mypgn.write_pgn()},b=function(n){$("#pgn"+u).text(n).show(1e3)},k=document.getElementById(o),a=null,d=[],y=!1;for(h=0;h<c.length;h++)f=c[h],h!=0&&f.turn=="b"&&f.prev!=null&&f.prev<c.length&&(f.moveNumber=c[f.prev].moveNumber),f.moveNumber==null&&(f.moveNumber=1),a=g(h,e,f,a,k,d,y),y=i.mypgn.endVariation(f);p();ht($("#edit"+n+"Button")[0]);at();e.reset();$(function(){$("select#"+u+"nag").multiselect({header:!1,selectedList:4,minWidth:80,checkAllText:"",uncheckAllText:"Clean",noneSelectedText:"NAGs",click:function(n,t){wt(t.value,t.checked)}})})},{chess:e,getPgn:function(){return i.mypgn},pgn:i.mypgn,loadFen:tt,generateHTML:ct,generateBoard:lt,generateMoves:it,hideHTML:b,onDragStart:ut,onDrop:ft,onMouseoutSquare:ot,onMouseoverSquare:et,onSnapEnd:st}};pgnView=function(n,t){var i,r;return t.fen=t.position?t.position:"start",i=pgnBase(n,t),i.generateHTML(),r=i.generateBoard(),i.generateMoves(r),i.hideHTML("Button","edit"),i.hideHTML("Button","comment"),{board:r,chess:i.chess,getPgn:i.getPgn,pgn:i.pgn,version:i.VERSION}}