(function($,ko){let urlComponentLoader={loadTemplate:function(name,templateConfig,callback){if(templateConfig.url){let version=window.global.version,fullUrl=window.urls.cdnUrl+"/components/"+templateConfig.url+"?v="+version;$.get(fullUrl,function(markupString){ko.components.defaultLoader.loadTemplate(name,markupString,callback)})}else callback(null)},loadViewModel:function(name,viewModelConfig,callback){if(viewModelConfig&&typeof viewModelConfig.createViewModel=="function"){let currentCreateViewModel=viewModelConfig.createViewModel;viewModelConfig.createViewModel=function(params,componentInfo){return currentCreateViewModel(params,componentInfo)};ko.components.defaultLoader.loadViewModel(name,viewModelConfig,callback)}else callback(null)}};ko.components.loaders.unshift(urlComponentLoader)})(jQuery,ko),function($,ko){function ApplyCouponModel(){function destroyErrorTooltip(element){element.tooltip("destroy")}function showErrorTooltip(element,text){destroyErrorTooltip(element);setTimeout(function(){element.tooltip({"class":"tooltip_error",placement:"right",trigger:"manual",title:text}).tooltip("show")},500)}const self=this;if(self.addCouponDlg=$("#add-coupon-dlg"),self.form=$("#add-coupon-form",self.addCouponDlg),self.couponInput=$("#add-coupon-couponId",self.form),self.couponCode=ko.observable(""),self.activate=function(){if(self.couponCode().length<3){showErrorTooltip(self.couponInput,"Coupon code not valid");return}let couponUserId=window.user.browsingProfileUserId;couponUserId||(couponUserId=window.global.currentUserId);let applyCouponRequest=new $.tabletopia.post.users.activateCoupon;applyCouponRequest.load({userId:couponUserId,couponCode:self.couponCode()}).done(function(data){data.success?window.location.reload():data.message&&showErrorTooltip(self.couponInput,data.message)}).fail(function(){$("#error-dlg").modal();self.addCouponDlg&&self.addCouponDlg.modal("hide")})},self.addCouponDlg)self.addCouponDlg.on("shown.bs.modal",function(){self.couponInput&&self.couponInput.focus()});self.couponInput&&self.couponInput.keyup(function(){destroyErrorTooltip(self.couponInput)});$("#apply-coupon-button").click(function(){self.couponCode("");destroyErrorTooltip(self.couponInput);self.addCouponDlg&&self.addCouponDlg.modal()})}ko.components.register("apply-coupon",{template:{url:"ApplyCoupon/apply-coupon.html"},viewModel:{createViewModel:function(){return new ApplyCouponModel}}})}(jQuery,ko),function($,ko){ko.bindingHandlers.animate={update:function(element,valueAccessor){var value=valueAccessor();if(value){const uwValue=ko.unwrap(value),duration=uwValue.duration!==undefined?uwValue.duration:1e3;$(element).animate(uwValue,duration)}}}}(jQuery,ko),function($,ko){function FindPlayModel(params){const self=this;self.widgetMode=$.tabletopia.enums.widgetMode.widget;self.openNewTab=!1;self.filter=params.filter;self.mode=ko.observable($.tabletopia.enums.findPlayMode.playNow);self.playNowFound=ko.observable(!1);self.scheduledFound=ko.observable(!1);self.inProgressFound=ko.observable(!1);params.widgetMode!==undefined&&(self.widgetMode=params.widgetMode);self.widgetMode===$.tabletopia.enums.widgetMode.widget&&(self.openNewTab=!0);self.userProvider=typeof UserProvider!="undefined"?new UserProvider(typeof unity=="undefined"?{}:unity):undefined;const x=new Date;self.timeZoneOffset=-x.getTimezoneOffset()/60;self.timeZone=self.timeZoneOffset>=0?$.tabletopia.localization.userTimeZone.replace("{0}","+"+self.timeZoneOffset):$.tabletopia.localization.userTimeZone.replace("{0}",self.timeZoneOffset);self.isActive=function(tab){return tab===self.mode()};self.playNowHidden=ko.pureComputed(function(){return self.widgetMode===$.tabletopia.enums.widgetMode.game?!self.playNowFound():!1});self.componentHidden=ko.pureComputed(function(){return self.widgetMode===$.tabletopia.enums.widgetMode.game?!self.playNowFound()&&!self.scheduledFound()&&!self.inProgressFound():!1});self.seeOtherHidden=function(){if(self.widgetMode===$.tabletopia.enums.widgetMode.findAndPlay)switch(self.mode()){case $.tabletopia.enums.findPlayMode.playNow:return!self.playNowFound();case $.tabletopia.enums.findPlayMode.gamesInProgress:return!self.inProgressFound();case $.tabletopia.enums.findPlayMode.playLater:return!0}return!0};self.timeZoneHidden=function(){return self.playNowFound()||self.scheduledFound()||self.inProgressFound()?self.mode()!==$.tabletopia.enums.findPlayMode.playLater:!0};self.showPlayNow=function(){self.mode($.tabletopia.enums.findPlayMode.playNow);self.widgetMode===$.tabletopia.enums.widgetMode.findAndPlay&&window.history.replaceState("","","/playground/find-play")};self.showPlayLater=function(){self.mode($.tabletopia.enums.findPlayMode.playLater);self.widgetMode===$.tabletopia.enums.widgetMode.findAndPlay&&window.history.replaceState("","","/playground/find-play#later")};self.showGamesInProgress=function(){self.mode($.tabletopia.enums.findPlayMode.gamesInProgress);self.widgetMode===$.tabletopia.enums.widgetMode.findAndPlay&&window.history.replaceState("","","/playground/find-play#games-in-progress")}}ko.components.register("find-play",{template:{url:"FindPlay/find-play.html"},viewModel:{createViewModel:function(params,componentInfo){return new FindPlayModel(params,componentInfo)}}});$.extend(!0,$,{tabletopia:{enums:{findPlayMode:{playNow:0,playLater:1,gamesInProgress:2},widgetMode:{game:0,findAndPlay:1,widget:2}}}})}(jQuery,ko),function($,ko){function GamesInProgressModel(params){function updateRooms(data,loadMore){var loadMore=loadMore||!1;if(data!==undefined&&data.rooms!==undefined){let newRoomsUrls={},roomsToDelete=[];loadMore&&self.page++;self.rooms.valueWillMutate();loadMore||data.rooms.length!==0||self.rooms.removeAll();const underlyingArray=self.rooms();if(data.rooms.forEach(function(room){room=prepareRoom(room);loadMore?underlyingArray.push(room):newRoomsUrls[room.shortUrl]=room}),Object.keys(newRoomsUrls).length>0){underlyingArray.forEach(function(room,index){const updatedRoom=newRoomsUrls[room.shortUrl];updatedRoom!==undefined?(room.wantedPlayersOb(updatedRoom.wantedPlayers),room.gameOb(updatedRoom.game),room.seatsOb(updatedRoom.seats),newRoomsUrls[updatedRoom.shortUrl]=undefined):roomsToDelete.push(index)});roomsToDelete.forEach(function(index){underlyingArray.splice(index,1)});for(newRoom in newRoomsUrls)newRoomsUrls[newRoom]!==undefined&&underlyingArray.push(newRoomsUrls[newRoom])}self.rooms.valueHasMutated();self.moreAvailable(self.rooms().length<data.totalRooms)}self.findPlay.inProgressFound(self.rooms().length>0);self.findPlay.inProgressFound()||self.findPlay.mode()!==$.tabletopia.enums.findPlayMode.gamesInProgress||self.findPlay.mode($.tabletopia.enums.findPlayMode.playNow);self.lastRequestTime=(new Date).getTime()}function prepareRoom(room){return room.wantedPlayersOb=ko.observable(room.wantedPlayers),room.gameOb=ko.observable(room.game),room.seatsOb=ko.observable(room.seats),room}function loadRooms(){if(!self.getMoreRoomsRequest.isLoading()&&!self.getRoomsRequest.isLoading()){const query={page:1};self.page=1;self.rooms().length>0&&(query.size=self.rooms().length);self.findPlay.filter&&$.extend(!0,query,self.findPlay.filter);self.getRoomsRequest.load(query).done(function(data){updateRooms(data)})}}const self=this;self.page=1;self.lastRequestTime=0;self.rooms=ko.observableArray();self.findPlay=params.findPlay;self.moreAvailable=ko.observable(!1);self.getRoomsRequest=new $.tabletopia.get.findPlay.playInProgress;self.getMoreRoomsRequest=new $.tabletopia.get.findPlay.playInProgress;self.position=ko.computed(function(){let offsetMultiplier=self.rooms().length;return offsetMultiplier===0&&(offsetMultiplier=2),{height:offsetMultiplier*150,duration:800}});self.loadMore=function(){if(!self.getMoreRoomsRequest.isLoading()){const query={page:self.page+1};self.findPlay.filter&&$.extend(!0,query,self.findPlay.filter);self.getMoreRoomsRequest.load(query).done(function(data){updateRooms(data,!0)})}};self.findPlay.mode.subscribe(function(newValue){newValue===$.tabletopia.enums.findPlayMode.gamesInProgress&&(new Date).getTime()-self.lastRequestTime>3e4&&loadRooms()});self.removeRoom=function(elem){$(elem).animate({opacity:.25,height:0},1e3,function(){$(elem).remove()})};self.getRoomsRequest.load(self.findPlay.filter?self.findPlay.filter:{}).done(function(data){updateRooms(data)})}ko.components.register("find-play-games-in-progress",{template:{url:"FindPlay/games-in-progress.html"},viewModel:{createViewModel:function(params){return new GamesInProgressModel(params)}}})}(jQuery,ko),function($,ko){function PlayLaterModel(params){function updateRooms(data,loadMore){var loadMore=loadMore||!1;if(data!==undefined&&data.rooms!==undefined){let scheduledGroup="";scheduledGroupsCount=0;self.rooms.valueWillMutate();loadMore?self.page++:self.rooms.removeAll();const underlyingArray=self.rooms();data.rooms.forEach(function(room){room.wantedPlayersOb=ko.observable(room.wantedPlayers);room.gameOb=ko.observable(room.game);room.seatsOb=ko.observable(room.seats);room.welcomeMessageOb=ko.observable(room.welcomeMessage);room.scheduledGroup=ko.observable("");room.scheduledGroupAtUserTZ=ko.observable(room.scheduledAtUserTZ);underlyingArray.push(room)});underlyingArray.forEach(function(room){if(room.scheduledAtUtc){const currentScheduledGroup=new Date(room.scheduledAtUtc).toDateString();scheduledGroup!==currentScheduledGroup?(scheduledGroupsCount++,scheduledGroup=currentScheduledGroup,room.scheduledGroup(scheduledGroup)):room.scheduledGroup("");room.cheduledGroupNumber=scheduledGroupsCount}});self.rooms.valueHasMutated();self.moreAvailable(self.rooms().length<data.totalRooms)}self.findPlay.scheduledFound(self.rooms().length>0);self.findPlay.scheduledFound()||self.findPlay.mode()!==$.tabletopia.enums.findPlayMode.playLater||self.findPlay.mode($.tabletopia.enums.findPlayMode.playNow);self.lastRequestTime=(new Date).getTime()}function loadRooms(){if(!self.getMoreRoomsRequest.isLoading()&&!self.getRoomsRequest.isLoading()){const query={tz:self.findPlay.timeZoneOffset*-60,page:1};self.page=1;self.rooms().length>0&&(query.size=self.rooms().length);self.findPlay.filter&&$.extend(!0,query,self.findPlay.filter);self.getRoomsRequest.load(query).done(function(data){updateRooms(data)})}}const self=this;let scheduledGroupsCount=0;self.page=1;self.lastRequestTime=0;self.rooms=ko.observableArray();self.findPlay=params.findPlay;self.moreAvailable=ko.observable(!1);self.getRoomsRequest=new $.tabletopia.get.findPlay.playLater;self.getMoreRoomsRequest=new $.tabletopia.get.findPlay.playLater;self.position=ko.computed(function(){let offsetMultiplier=self.rooms().length;return offsetMultiplier===0&&(offsetMultiplier=2),{height:offsetMultiplier*150+scheduledGroupsCount*51,duration:800}});self.loadMore=function(){if(!self.getMoreRoomsRequest.isLoading()){const query={tz:self.findPlay.timeZoneOffset*-60,page:self.page+1};self.findPlay.filter&&$.extend(!0,query,self.findPlay.filter);self.getMoreRoomsRequest.load(query).done(function(data){updateRooms(data,!0)})}};self.findPlay.mode.subscribe(function(newValue){newValue===$.tabletopia.enums.findPlayMode.playLater&&(new Date).getTime()-self.lastRequestTime>3e4&&loadRooms()});self.removeRoom=function(elem){$(elem).animate({opacity:.25,height:0},1e3,function(){$(elem).remove()})};const query={tz:self.findPlay.timeZoneOffset*-60};self.findPlay.filter&&$.extend(!0,query,self.findPlay.filter);self.getRoomsRequest.load(query).done(function(data){updateRooms(data)})}ko.components.register("find-play-later",{template:{url:"FindPlay/play-later.html"},viewModel:{createViewModel:function(params){return new PlayLaterModel(params)}}})}(jQuery,ko),function($,ko){function PlayNowEmptyModel(params){const self=this;self.filter={};self.openNewTab=!1;self.widgetMode=$.tabletopia.enums.widgetMode.findAndPlay;self.games=ko.observableArray();params.filter&&(self.filter=params.filter);params.widgetMode&&(self.widgetMode=params.widgetMode);params.openNewTab&&(self.openNewTab=params.openNewTab);self.widgetMode===$.tabletopia.enums.widgetMode.findAndPlay?(self.getGamesRequest=new $.tabletopia.get.findPlay.recommendedGames,self.getGamesRequest.load().done(function(data){self.games(data)})):(self.getGamesRequest=new $.tabletopia.get.findPlay.recommendedWidgetGames,self.getGamesRequest.load(self.filter).done(function(data){self.games(data)}))}ko.components.register("play-now-empty",{template:{url:"FindPlay/play-now-empty.html"},viewModel:{createViewModel:function(params){return new PlayNowEmptyModel(params)}}})}(jQuery,ko),function($,ko){function PlayNowModel(params){function updateRooms(){self.getRoomsRequest.isLoading()||(new Date).getTime()-self.lastRequestTime()<3e4||self.getRoomsRequest.load(self.findPlay.filter?self.findPlay.filter:{}).done(function(data){let newRoomsUrls={},roomsToDelete=[];self.rooms.valueWillMutate();const underlyingArray=self.rooms();if(data.rooms.forEach(function(room){room=prepareRoom(room);newRoomsUrls[room.shortUrl]=room}),Object.keys(newRoomsUrls).length>0){underlyingArray.forEach(function(room,index){const updatedRoom=newRoomsUrls[room.shortUrl];updatedRoom!==undefined?(room.wantedPlayersOb(updatedRoom.wantedPlayers),room.gameOb(updatedRoom.game),room.seatsOb(updatedRoom.seats),newRoomsUrls[updatedRoom.shortUrl]=undefined):roomsToDelete.push(index)});roomsToDelete.forEach(function(index){underlyingArray.splice(index,1)});for(newRoom in newRoomsUrls)newRoomsUrls[newRoom]!==undefined&&underlyingArray.push(newRoomsUrls[newRoom])}self.rooms.valueHasMutated();self.lastRequestTime((new Date).getTime());self.findPlay.playNowFound(self.rooms().length>0);self.findPlay.scheduledFound(data.scheduledFound);self.findPlay.inProgressFound(data.inProgressFound);selectTab()})}function prepareRoom(room){return room.wantedPlayersOb=ko.observable(room.wantedPlayers),room.gameOb=ko.observable(room.game),room.seatsOb=ko.observable(room.seats),room}function selectTab(){if(self.findPlay.widgetMode===$.tabletopia.enums.widgetMode.findAndPlay)(self.findPlay.scheduledFound()||self.findPlay.mode()!==$.tabletopia.enums.findPlayMode.playLater)&&(self.findPlay.inProgressFound()||self.findPlay.mode()!==$.tabletopia.enums.findPlayMode.gamesInProgress)||self.findPlay.mode($.tabletopia.enums.findPlayMode.playNow);else{let tabWithData={};if(tabWithData[$.tabletopia.enums.findPlayMode.playNow]=self.findPlay.playNowFound(),tabWithData[$.tabletopia.enums.findPlayMode.playLater]=self.findPlay.scheduledFound(),tabWithData[$.tabletopia.enums.findPlayMode.gamesInProgress]=self.findPlay.inProgressFound(),!self.findPlay.playNowFound()&&!self.findPlay.scheduledFound()&&!self.findPlay.inProgressFound()){self.findPlay.mode($.tabletopia.enums.findPlayMode.playNow);return}tabWithData[self.findPlay.mode()]||(tabWithData[$.tabletopia.enums.findPlayMode.playNow]?self.findPlay.mode($.tabletopia.enums.findPlayMode.playNow):tabWithData[$.tabletopia.enums.findPlayMode.playLater]?self.findPlay.mode($.tabletopia.enums.findPlayMode.playLater):tabWithData[$.tabletopia.enums.findPlayMode.gamesInProgress]&&self.findPlay.mode($.tabletopia.enums.findPlayMode.gamesInProgress))}}const self=this,playgroundHub=$.connection.ph;self.lastRequestTime=ko.observable(0);self.rooms=ko.observableArray();self.findPlay=params.findPlay;self.getRoomsRequest=new $.tabletopia.get.findPlay.playNow;var qs={trackedPageType:"FindAndPlay"};typeof window.user.id=="number"&&window.user.id>0&&(qs.userId=window.user.id);window.global.signalrManager.extendQueryString(qs);self.showEmptyStub=ko.pureComputed(function(){return self.lastRequestTime()===0||self.findPlay.widgetMode===$.tabletopia.enums.widgetMode.game?!1:!self.findPlay.playNowFound()});self.position=ko.pureComputed(function(){return{height:self.rooms().length*150+200}});playgroundHub.client.addRooms=function(newRooms){typeof newRooms!="undefined"&&newRooms.length!==0&&updateRooms()};playgroundHub.client.removeRooms=function(removedRooms){if(typeof removedRooms!="undefined"&&removedRooms.length!==0){let removedRoomsUrls=[];removedRooms.forEach(function(room){const startIndex=room.indexOf("^"),endIndex=room.indexOf("-");startIndex!==-1&&endIndex!==-1&&(removedRoomsUrls[room.substr(1,endIndex-1)]=room)});self.rooms.remove(function(room){return removedRoomsUrls[room.shortUrl]!==undefined});self.findPlay.playNowFound(self.rooms().length>0);selectTab()}};self.removeRoom=function(elem){$(elem).animate({opacity:.25,height:0},1e3,function(){$(elem).remove()})};self.getRoomsRequest.load(self.findPlay.filter?self.findPlay.filter:{}).done(function(data){if(data.rooms.forEach(function(room){room=prepareRoom(room)}),self.rooms(data.rooms),self.lastRequestTime((new Date).getTime()),self.findPlay.playNowFound(self.rooms().length>0),self.findPlay.scheduledFound(data.scheduledFound),self.findPlay.inProgressFound(data.inProgressFound),window.global.signalrManager.connect(),data.scheduledFound&&window.location.href.indexOf("#later")!==-1){self.findPlay.mode($.tabletopia.enums.findPlayMode.playLater);return}if(data.inProgressFound&&window.location.href.indexOf("#games-in-progress")!==-1){self.findPlay.mode($.tabletopia.enums.findPlayMode.gamesInProgress);return}selectTab()})}ko.components.register("find-play-now",{template:{url:"FindPlay/play-now.html"},viewModel:{createViewModel:function(params){return new PlayNowModel(params)}}})}(jQuery,ko),function($,ko){function RoomsModel(params){const self=this,roomElementHeight=150,groupElementHeight=51;self.model=params.model;self.userProvider=params.model.userProvider;self.openNewTab=params.model.openNewTab;$.extend(!0,self,params.model.room);self.order=params.model.order;self.showScheduledGroup=ko.pureComputed(function(){return self.scheduledGroup()?!0:!1});self.gameTime=ko.pureComputed(function(){const createdAt=new Date(self.createdAtUtc),dateText=self.dateTimeToText(createdAt.getTime());switch(self.model.mode){case $.tabletopia.enums.findPlayMode.gamesInProgress:return $.tabletopia.localization.startedAt+" "+dateText;case $.tabletopia.enums.findPlayMode.playNow:return $.tabletopia.localization.createdTime.toLowerCase()+" "+dateText;case $.tabletopia.enums.findPlayMode.playLater:let scheduledDate=new Date(self.scheduledAtUtc);return scheduledDate=new Date(scheduledDate.getTime()),scheduledDate.toLocaleTimeString(navigator.language,{hour:"2-digit",minute:"2-digit"})}});self.playerStatus=function(player){return self.model.mode===$.tabletopia.enums.findPlayMode.gamesInProgress?player.online?$.tabletopia.localization.inGame:$.tabletopia.localization.offline:player.online?$.tabletopia.localization.online:$.tabletopia.localization.offline};self.playerName=function(player){return self.host.id===player.id?player.displayName+" (Host)":player.displayName};self.seatClass=ko.pureComputed(function(){let elementsCount=self.seatsOb().length-self.wantedPlayersOb();return self.wantedPlayersOb()>0&&elementsCount++,self.widgetMode===$.tabletopia.enums.widgetMode.findAndPlay?elementsCount<4?"big-3":elementsCount<5?"big-4":"big-8":elementsCount<4?"small-3":"small-8"});self.animatePosition=ko.pureComputed(function(){const top=self.order()*roomElementHeight,offset=self.cheduledGroupNumber?self.cheduledGroupNumber*groupElementHeight:0;return{top:offset?top+offset:top,height:offset?roomElementHeight+offset:roomElementHeight}});self.animateGroupPosition=ko.pureComputed(function(){const top=self.order()*roomElementHeight,offset=self.cheduledGroupNumber?(self.cheduledGroupNumber-1)*groupElementHeight:0;return{top:top+offset}});self.statusText=ko.pureComputed(function(){return self.model.mode===$.tabletopia.enums.findPlayMode.gamesInProgress?$.tabletopia.localization.roomStatusGameInProgress:$.tabletopia.localization.roomStatusLookingForPlayers});self.lobbyUrl=ko.pureComputed(function(){return"/playground/players/"+self.host.shortUrl+"/"+self.shortUrl});self.showUserInfo=function(currentPlayer){currentPlayer&&self.userProvider&&self.model.userProvider.openUserPreview(currentPlayer.shortUrl,"Find-Play","OnlinePlayers")};self.dateTimeToText=function(dateUtc){const date=new Date(dateUtc),now=Date.now(),diff=now-date,seconds=diff/1e3;if(seconds<=60)return $.tabletopia.localization.justNowLowercase;const minutes=diff/6e4;if(minutes<=60)return minutes>1?minutes.toFixed()+" "+$.tabletopia.localization.agoMinutes:$.tabletopia.localization.agoMinute;const hours=diff/36e5;if(hours<=24)return hours>1?hours.toFixed()+" "+$.tabletopia.localization.agoHours:$.tabletopia.localization.agoHour;const days=diff/864e5;if(days<=30)return days>1?days.toFixed()+" "+$.tabletopia.localization.agoDays:$.tabletopia.localization.yesterdayLowercase;if(days<=365)return days>30?(days/30).toFixed()+" "+$.tabletopia.localization.agoMonths:$.tabletopia.localization.agoMonth;const years=days/365;return years>1?years.toFixed()+" "+$.tabletopia.localization.agoYears:$.tabletopia.localization.AgoYear}}ko.components.register("find-play-room",{template:{url:"FindPlay/room.html"},viewModel:{createViewModel:function(params,componentInfo){return new RoomsModel(params,componentInfo)}}})}(jQuery,ko),function($,ko){function GameShortModel(params){const self=this;self.model=params.model.game;self.openNewTab=params.model.openNewTab;self.catalogItemClass="carousel__item";params.model.catalogItemClass&&(self.catalogItemClass=params.model.catalogItemClass);self.catalogItemClass+=" item game-short-item";self.url="/games/"+self.model.shortUrl;self.isTryNowAvailable=(!window.user.isAuthenticated||window.user.isDemoUser)&&self.model.createRoomAccessGroup==="Everyone"&&self.model.hasOnlyPremiumSetups;self.isPremiumAvailable=self.model.hasOnlyPremiumSetups&&window.user.isAuthenticated&&!window.user.isDemoUser;self.isDlcAvailable=self.model.isDlc&&!self.model.inLibrary&&window.isInSteamBrowser;self.isLanguageAvailable=self.model.languages&&self.model.languages.length>0&&(self.model.languages.length>1||self.model.languages[0]!=="ind")}ko.components.register("game-short",{template:{url:"Games/game-short.html"},viewModel:{createViewModel:function(params){return new GameShortModel(params)}}})}(jQuery,ko)